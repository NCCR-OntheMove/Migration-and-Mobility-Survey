#
# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(shinythemes)
library(knitr)
library(kableExtra)
library(highcharter)
library(XML)
library(sp)
#library(tidyverse)
library(dplyr)
library(tidyr)
library(forcats)
library(naniar)
library(readr)
library(shinyWidgets)

library(leaflet)
library(htmlwidgets)
library(htmltools)

#load("./data/doble_presence.Rdata")
load("./data/dmms.Rdata")
load("./data/countries.Rdata")
SAMPLING<-read_csv("./data/SAMPLING.csv")
load("./data/SHP.Rdata")
#load("./data/mapa16.Rdata")
#load("./data/mapa18.Rdata")

#load("C:/Users/jgaleano/Dropbox/R/SHINY/NEW_DP/MMS/data/dmms.Rdata")
# Define server logic required to draw a histogram
#doble_presence<-as.data.frame(doble_presence)

# functions ##### 
gg_color_hue <- function(n) {
  hues = seq(15, 375, length=n+1)
  hcl(h=hues, l=65, c=100)[1:n]
}

a <- function(x) format(x, big.mark = ",", scientific = FALSE)


##### shiny server ######
shinyServer(function(input, output,session) {
  options(shiny.sanitize.errors = FALSE)
  
  
  output$sampling <-renderText({
    SAMPLING<-SAMPLING[,c(2:6)]
    kable(SAMPLING)%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  })

  #### A1 A2 Piramids #####
  output$pyramidrel <- renderHighchart({
    
    piramids <- lapply(dmms, function(x){
      
      x$A1<- with(x,paste(A1,(year-A2),sep=""))
      #x <- x%>%
      # mutate(A1=paste(A1,(year-A2),sep=""))
      
      x<-x[,c("A1", input$mag,"year")]
      colnames(x)<-c("A1","pop","year")
      
      x$sex<-as.numeric(substr(x$A1,1,1))
      x$age<-as.numeric(substr(x$A1,2,3))
      
      x<-x %>%
        group_by(year,sex,age) %>% 
        summarise(pop=sum(pop))
      
      x$age_group<-with(x, ifelse(age<30, "20-30", 
                                  ifelse((age>=30 & age <40), "30-40",
                                         ifelse((age>=40 & age <50), "40-50",
                                                ifelse((age>=50 & age <60), "50-60",
                                                       ifelse(age>=60, "60-64",0))))))
      
      
      
      
      
      
      x<-x[,c("pop","year", "sex","age_group")]
      x[is.na(x)] <- -7
      
      
      colnames(x)<-c("n_nw","year","sex","age_group")
      
      x<-x %>%
        group_by(year,sex,age_group) %>% 
        filter(sex!=-7)%>%
        summarise(pop=sum(n_nw))
      
      
      x$sex<-as.factor(x$sex)
      x<-x %>%
        group_by(year,sex,age_group) %>% 
        summarise(pop=round(sum(pop),0))%>% 
        mutate(pop_rel=ifelse(year==2016,pop/sum(x[x$year==2016,"pop"]),
                              ifelse(year==2018,pop/sum(x[x$year==2018,"pop"]),    
                                     pop/sum(x[x$year==2020,"pop"]))))%>%
        mutate(pop2=ifelse(sex==1, pop*-1,pop),
               pop_rel2=ifelse(sex==1, pop_rel*-1,pop_rel),
               sex1=fct_recode(as.factor(sex), Male = "1", Female = "2"))
      
      
      x$pop_rel2<-round(x$pop_rel2*100,1)
      x
      
    })
    
    pir<- as.data.frame(do.call("rbind", piramids))
    
    pir<-pir[pir$year==input$year,]
    
    xaxis <- list(categories = as.factor(sort(unique(pir$age_group))),
                  reversed = FALSE, 
                  #tickInterval =5,
                  labels = list(step = 1))
    cols = rev(gg_color_hue(2))
    
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 2000,175000)
    
    highchart() %>%
      hc_chart(type = "bar",zoomType= 'xy') %>%
      hc_xAxis(xaxis) %>%
      hc_add_series(name = 'Males', 
                    data = c(pir[(pir$sex==1),ifelse(input$mag2=="Relative",7,6)]))%>%
      hc_add_series(name = 'Females', 
                    data = c(pir[(pir$sex==2),ifelse(input$mag2=="Relative",7,6)]))%>%
      hc_plotOptions(series = list(stacking = "normal",animation=FALSE),
                     bar = list(groupPadding = 0, pointPadding =  0, borderWidth =.25))%>%
      hc_colors(c(cols)) %>%
      hc_title(text =paste(input$year, "Population structure", 
                           "n:", a(sum(pir[,"pop"])),sep=" "))%>%
      hc_subtitle(text =paste(paste("Males: ",a(sum(abs(c(pir[(pir$sex==1),"pop2"])))),sep=""),
                              paste("Females: ",a(sum(abs(c(pir[(pir$sex==2),"pop2"])))),sep=""),sep=" - "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),min=ifelse(input$mag2=="Absolute",-hc_yAxis,-25),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,25))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(shared = FALSE,
                 formatter = JS("function () { return '<b>' + this.series.name + '<br>' +'Age: ' + this.point.category + '</b><br/>' + 'N: ' + Math.abs(this.point.y);}"))
  })   
  
  
  
  #### A3 RANKING TOP 20 countrie of birth ###### 
  
  output$barras1 <-renderHighchart({ 
    
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      colnames(x)<-c("A3","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"A3"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("A3","B",sep="")
      x$A3B<-as.factor(x$A3B)
      x$A3B<-fct_explicit_na(x$A3B)
      
      colnames(x)<-c("A3","pop","year","A3B")
      
      x<-x %>%
        group_by(year,A3B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$year,]
    
    data<- if(input$mag2=="Absolute"){ 
      nacdf[,c("year","A3B","pop")]}else{
        nacdf[,c("year","A3B", "prop")]}
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 700,175000)
    
    color<-ifelse(input$year==2016,1,
                  ifelse(input$year==2018,2,3))
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$A3B), title = list(text = '')) %>%
      #hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of birth:",input$year,sep=" "),
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$year==2016){ 
          1}else{
            if(input$year==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  }) 
  
  
  #### A4 RANKING TOP 20 countrie of birth ###### 
  
  output$barras3 <-renderHighchart({ 
    
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      colnames(x)<-c("A4_1","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"A4_1"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("A4_1","B",sep="")
      x$A4_1<-as.factor(x$A4_1)
      x$A4_1<-fct_explicit_na(x$A4_1)
      
      colnames(x)<-c("A3","pop","year","A3B")
      
      x<-x %>%
        group_by(year,A3B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$year,]
    
    data<- if(input$mag2=="Absolute"){ 
      nacdf[,c("year","A3B","pop")]}else{
        nacdf[,c("year","A3B", "prop")]}
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 700,175000)
    color<-ifelse(input$year==2016,1,
                  ifelse(input$year==2018,2,3))
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$A3B), title = list(text = '')) %>%
      #hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of nationality:",input$year,sep=" "),
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$year==2016){ 
          1}else{
            if(input$year==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  }) 
  
  
  
  #### A5 RANKING TOP 20 countrie of birth ###### 
  
  output$barras5 <-renderHighchart({ 
    dmms[[3]]<-NULL
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      colnames(x)<-c("A5_1","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"A5_1"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("A5_1","B",sep="")
      x$A5_1B<-as.factor(x$A5_1B)
      x$A5_1B<-fct_explicit_na(x$A5_1B)
      
      colnames(x)<-c("A3","pop","year","A3B")
      
      x<-x %>%
        group_by(year,A3B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$year1,]
    
    data<- if(input$mag2=="Absolute"){ 
      nacdf[,c("year","A3B","pop")]}else{
        nacdf[,c("year","A3B", "prop")]}
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 700,175000)
    color<-ifelse(input$year1==2016,1,
                  ifelse(input$year1==2018,2,3))
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$A3B), title = list(text = '')) %>%
      #hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of nationality:",input$year1,sep=" "),
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$year1==2016){ 
          1}else{
            if(input$year1==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  })
  
  
  #### B1 RANKING TOP 20 countrie of ORRIGIN ###### 
  
  output$B1_16 <-renderHighchart({ 
    
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      colnames(x)<-c("B1","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"B1"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("B1","B",sep="")
      x$B1B<-as.factor(x$B1B)
      x$B1B<-fct_explicit_na(x$B1B)
      
      colnames(x)<-c("A3","pop","year","A3B")
      
      x<-x %>%
        group_by(year,A3B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$year3,]
    
    data<- if(input$mag3=="Absolute"){ 
      nacdf[,c("year","A3B","pop")]}else{
        nacdf[,c("year","A3B", "prop")]}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 700,175000)
    color<-ifelse(input$year3==2016,1,
                  ifelse(input$year3==2018,2,3))
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$A3B), title = list(text = '')) %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$year3==2016){ 
          1}else{
            if(input$year3==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of origin:",input$year3,sep=" "),
               align = 'left')  %>%
      # hc_subtitle(text =  paste("\nN",a(sum(c(data$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  })
  
  
  #### year of arrival #####   
  output$barras7 <-renderHighchart({ 
    
    tem <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      
      colnames(x)<-c("A6","pop","year")
      
      x<-x %>%
        group_by(year,A6) %>% 
        replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(A6))
      
      x$A6<-as.factor(x$A6)
      x$A6<-fct_explicit_na(x$A6)
      #levels(doble_presence$A6)
      
      #levels(x$A6)<-c(c(2016:2006),"Before 2006",13, "(Missing)")
      x
    })
    
    levels(tem[["D16"]]$A6)<-c(c(2016:2006))
    levels(tem[["D18"]]$A6)<-c(c(2018:2006),"missing")
    levels(tem[["D20"]]$A6)<-c(c(2020:2006))
    
    
    temDF<- as.data.frame(do.call("rbind", tem))
    temDF$A6<-as.factor(temDF$A6)
    
    temDF$A6<-factor(temDF$A6, levels=c( "2006","2007","2008","2009","2010","2011","2012",
                                         "2013","2014","2015","2016","2017","2018","2019","2020"))
    
    #temDF<-temDF[complete.cases(temDF), ]
    
    
    data<- if(input$mag2=="Absolute"){ 
      temDF[,c("year","A6", "pop")]}else{
        temDF[,c("year","A6", "prop")]}
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 1000,85000)
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    
    rank <- highchart() %>% 
      hc_chart(type = "column",zoomType= 'xy') %>%
      hc_xAxis(categories = levels(data$A6), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      # hc_chart(type = 'column') %>%
      hc_legend(enabled =TRUE ) %>%
      
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,15))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Year of emigration to Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(tem[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(tem[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(tem[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
  })
  
  #### A7 RESIDENCE PERMIT   ######     
  
  output$A7_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("A7",input$mag,"year")]
      
      colnames(x)<-c("A7", "pop","year")
      x[is.na(x)] <- -7
      
      x<-x %>%
        group_by(year,A7) %>% 
        filter(A7!=-7)%>% 
        filter(A7!=-9)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((A7))
      
      x$A7<-as.factor(x$A7)
      x$A7<-fct_explicit_na(x$A7)
      
      x
    })
    
    levels(mar[["D16"]]$A7)<-c("Settlement permit (C permit)",
                               "Residence permit (B permit)",
                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                               "Short-term residence permit (L permit)")
    levels(mar[["D18"]]$A7)<-c("Settlement permit (C permit)",
                               "Residence permit (B permit)",
                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                               "Short-term residence permit (L permit)",
                               "Other permit")
    levels(mar[["D20"]]$A7)<-c("Settlement permit (C permit)",
                               "Residence permit (B permit)",
                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                               "Short-term residence permit (L permit)",
                               "Other permit",
                               "I have the Swiss citizenship")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$A7<-as.factor(marDF$A7)
    levels(marDF$A7)
    
    data<- if(input$mag2=="Absolute"){ 
      marDF[,c("year","A7", "pop")]}else{
        marDF[,c("year","A7", "prop")]}
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 6000,475000)
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$A7), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      # hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Residence Permit",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  #### A8 Marital status ##### 
  
  output$barras9 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("A8", "pop","year")
      x<-x %>%
        group_by(year,A8) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((A8))
      
      x$A8<-as.factor(x$A8)
      x$A8<-fct_explicit_na(x$A8)
      
      x
    })
    
    levels(mar[["D16"]]$A8)<-c("Single, never married",
                               "Married",
                               "Separated",
                               "Divorced",
                               "Widowed",
                               "Registered partnership",
                               "Dissolved partnership")
    
    levels(mar[["D18"]]$A8)<-c("Single, never married",
                               "Married",
                               "Separated",
                               "Divorced",
                               "Widowed",
                               "Registered partnership",
                               "Dissolved partnership")
    
    levels(mar[["D20"]]$A8)<-c("Single, never married",
                               "Married",
                               "Separated",
                               "Divorced",
                               "Widowed",
                               "Registered partnership",
                               "Dissolved partnership")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$A8<-as.factor(marDF$A8)
    
    data<- if(input$mag2=="Absolute"){ 
      marDF[,c("year","A8", "pop")]}else{
        marDF[,c("year","A8", "prop")]}
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 6000,475000)
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$A8), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Marital status",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  #### A9 Marital status 2 ##### 
  
  
  output$ComposicionPlotly20 <-renderHighchart({ 
    mar3 <- lapply(dmms, function(x){
      
      x<-x[,c("A8",input$terms,input$mag,"year")]
      colnames(x)<-c("A8", "A9", "pop", "year")
      x[is.na(x)] <- -7
      x$A8<-as.factor(x$A8)
      levels(x$A8)<-c("Single, never married",
                      "Married",
                      "Separated",
                      "Divorced",
                      "Widowed",
                      "Registered partnership",
                      "Dissolved partnership")
      
      x<-x%>%
        group_by(year)%>%
        filter(A9 !=-7)
      
      
      x<-x %>%
        filter(A8 %in% c("Single, never married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Dissolved partnership"))%>%
        group_by(year,A8,A9) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar3))
    marDF<-marDF[marDF$A9==1,]
    marDF$A8<-as.factor(marDF$A8)
    
    data<- if(input$mag2=="Absolute"){ 
      marDF[,c("year","A8", "pop")]}else{
        marDF[,c("year","A8", "prop")]}
    
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 1500,150000)
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    #levels(marDF$A8)
    
    hc <-  highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = (data$A8), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you have a partner?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar3[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar3[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar3[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    hc
    
    
  }) 
  
  
  
  
  #### A11 STILLS LIVE IN SWITZERLAND ######
  
  output$A11_18 <-renderHighchart({ 
    dmms[[1]] <- NULL
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$terms,input$mag,"year")]
      
      colnames(x)<-c("A11", "pop","year")
      x<-x %>%
        group_by(year,A11) %>% 
        filter(A11!=-9)%>% 
        filter(A11!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((A11))
      
      x$A11<-as.factor(x$A11)
      x$A11<-fct_explicit_na(x$A11)
      
      x
    })
    
    levels(mar[["D18"]]$A11)<-c("Yes, I live in Switzerland",
                                "I live partly in Switzerland, partly abroad")
    
    levels(mar[["D20"]]$A11)<-c("Yes, I live in Switzerland",
                                "I live partly in Switzerland, partly abroad")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$A11<-as.factor(marDF$A11)
    levels(marDF$A11)
    
    
    data<- if(input$mag2=="Absolute"){ 
      marDF[,c("year","A11", "pop")]}else{
        marDF[,c("year","A11", "prop")]}
    
    hc_yAxis<-ifelse(input$mag=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$mag2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$A11), title = list(text = '')) %>%
      #hc_add_series(name= "2016",data = marDF[marDF$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you still live in Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank
    
    
  })  
  
  
  #### B16 At the time of our first survey, at the end of 2016, you were living in Switzerland. Can you confirm that you left Switzerland after the 2016 Survey and then you came back in [A6]?#### 
  
  output$B16_16 <-renderHighchart({ 
    
    x<-dmms[["D18"]][,c(input$BQ,input$mag1,"year")]
    
    colnames(x)<-c("B16", "pop","year")
    x<-x %>%
      group_by(B16) %>% 
      filter(B16!=-9)%>% 
      filter(B16!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((B16))
    
    x$B16<-as.factor(x$B16)
    x$B16<-fct_explicit_na(x$B16)
    
    x
    #       })
    
    levels(x$B16)<-c("Yes, I left Switzerland after 2016 then returned",
                     "I did not live anymore in Switzerland at the end of 2016, and returned after",
                     "No, I have stayed continuously in Switzerland since 2016")
    
    
    data<- if(input$mag3=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 50,5000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$B16), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "2018: Left Switzerland after the 2016 Survey",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[2]))
    
    rank
  })    
  output$B16_18 <-renderHighchart({ 
    
    x<-dmms[["D20"]][,c(input$BQ,input$mag1,"year")]
    
    colnames(x)<-c("B16", "pop","year")
    x<-x %>%
      group_by(B16) %>% 
      filter(B16!=-9)%>% 
      filter(B16!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((B16))
    
    x$B16<-as.factor(x$B16)
    x$B16<-fct_explicit_na(x$B16)
    
    x
    #       })
    
    levels(x$B16)<-c("Yes, I left Switzerland after 2018 then returned",
                     "I did not live anymore in Switzerland at the end of 2018, and returned after",
                     "No, I have stayed continuously in Switzerland since 2018")
    
    
    data<- if(input$mag3=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 50,5000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$B16), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2020", data = data) %>%
      hc_title(text = "2020: Left Switzerland after the 2018 Survey",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[3]))
    
    rank
    
    
    
    
  })  
  
  
  #### b17 How long did you stay abroad before returning to Switzerland in [A6]?#### 
  
  output$B17_18 <-renderHighchart({ 
    dmms[[1]] <- NULL
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      
      colnames(x)<-c("B17", "pop","year")
      x<-x %>%
        group_by(year,B17) %>% 
        filter(B17!=-9)%>% 
        filter(B17!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((B17))
      
      x$B17<-as.factor(x$B17)
      x$B17<-fct_explicit_na(x$B17)
      
      x
    })
    
    levels(mar[["D18"]]$B17)<-c("Less than 1 month",
                                "1 to 3 months",
                                "3 months to one year",
                                "More than one year")
    
    levels(mar[["D20"]]$B17)<-c("Less than 1 month",
                                "1 to 3 months",
                                "3 months to one year",
                                "More than one year")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$B17<-as.factor(marDF$B17)
    #levels(marDF$B17)
    
    
    data<- if(input$mag2=="Absolute"){ 
      marDF[,c("year","B17", "pop")]}else{
        marDF[,c("year","B17", "prop")]}
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$B17), title = list(text = '')) %>%
      #hc_add_series(name= "2016",data = marDF[marDF$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How long did you stay aborad?",
               align = 'left')  %>%
      
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank
    
    
  }) 
  
  
  ####   reaons #####
  
  output$B18_1_18 <-renderHighchart({ 
    dmms[[1]] <- NULL
    mar <- lapply(dmms, function(x){
      x<-x[,c("B18_1","B18_2","B18_3","B18_4",
              "B18_5","B18_6","B18_7","B18_8",input$mag1,"year")]#input$mag1
      
      
      colnames(x)<-c("B18_1","B18_2","B18_3","B18_4",
                     "B18_5","B18_6","B18_7","B18_8","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B18_1, B18_2,B18_3, B18_4,B18_5,
                                         B18_6,B18_7,B18_8), factor_key=FALSE)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar))
    
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    levels(marDF$groupz)<-c("To begin or continue a training abroad",
                            "For professional reasons",
                            "To take care of one or more family members abroad",
                            "For other family reasons",
                            "To expecience new things abroad",
                            "Because my residency permit in Switzerland expired",
                            "For other reasons")
    marDF[is.na(marDF)] <- 0
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 7,750)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ")
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Reasons last stay abroad",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank
    
  })
  
  #### B2 HOW MANY COUNTRIES ###### 
  
  output$B2_16 <-renderHighchart({ 
    
    nco <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]#input$BQ,input$mag1,
      
      
      x$B2CAT<- with(x, ifelse(B2==0,"In no other country",
                               ifelse(B2==1,"In 1 other country",
                                      ifelse(B2==2,"In 2 other countries",
                                             ifelse(B2==3,"In 3 other countries",
                                                    ifelse(B2 >3,"In 4 or more other countries",0))))))
      
      colnames(x)<-c("B2", "pop", "year","B2CAT")
      
      x<-x %>%
        group_by(year,B2CAT) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))
      x
    })
    
    ncoDF<- as.data.frame(do.call("rbind", nco))
    
    ncoDF$B2CAT<-as.factor(ncoDF$B2CAT)
    data<- if(input$mag3=="Absolute"){ 
      ncoDF[,c("year","B2CAT", "pop")]}else{
        ncoDF[,c("year","B2CAT", "prop")]}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 4000,450000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$B2CAT), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "In how many other countries have you lived for three or more months",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(nco[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(nco[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(nco[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  #### B4 first time in swisss ###### 
  
  output$B4_16 <-renderHighchart({ 
    fst <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]#input$BQ,input$mag1
      
      x[is.na(x)] <- -7
      
      colnames(x)<-c("B4","pop","year")
      x<-x %>%
        group_by(year,B4) %>% 
        filter(B4!=-7)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    fstDF<- as.data.frame(do.call("rbind", fst))
    fstDF<-fstDF[fstDF$B4==1,]
    fstDF$B4<-as.factor(fstDF$B4)
    levels(fstDF$B4)<-"Yes"
    
    
    data<- if(input$mag3=="Absolute"){ 
      fstDF[,c("year","B4", "pop")]}else{
        fstDF[,c("year","B4", "prop")]}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 7000,700000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = factor(data$B4), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = " First time in Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(fst[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(fst[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  
  
  
  #### B5 HOW MANY TIME IN SWISTZ ####
  
  output$B5_16 <-renderHighchart({ 
    dmms[[3]]<-NULL
    nco <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      
      x[is.na(x)] <- -7
      x<-x%>%
        filter(B5!=-7)
      
      x$B5CAT<- with(x, ifelse(B5==0,"0 time",
                               ifelse(B5==1,"1 more time",
                                      ifelse(B5==2,"2 more times",
                                             ifelse(B5==3,"3 more times",
                                                    ifelse(B5 >3,"4 or more more times",0))))))
      
      colnames(x)<-c("B5", "pop", "year","B5CAT")
      
      x<-x %>%
        group_by(year,B5CAT) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((B5CAT))
      x
    })
    
    data<- if(input$mag3=="Absolute"){ 
      c(nco[["D16"]]$pop)}else{
        c(nco[["D16"]]$prop)}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 600,75000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(nco[["D16"]]$B5CAT), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,80))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "2016: Number of times",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nco[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[1]))
    rank
  }) 
  
  output$B5_18 <-renderHighchart({ 
    dmms[[3]]<-NULL
    nco <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      
      x[is.na(x)] <- -7
      x<-x%>%
        filter(B5!=-7)
      
      x$B5CAT<- with(x, ifelse(B5==0,"0 year",
                               ifelse(B5==1,"1 year",
                                      ifelse(B5==2,"2 years",
                                             ifelse(B5==3,"3 years",
                                                    ifelse(B5 >3,"4 or more years",0))))))
      
      colnames(x)<-c("B5", "pop", "year","B5CAT")
      
      x<-x %>%
        group_by(year,B5CAT) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((B5CAT))
      x
    })
    
    data<- if(input$mag3=="Absolute"){ 
      c(nco[["D18"]]$pop)}else{
        c(nco[["D18"]]$prop)}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 600,75000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(nco[["D18"]]$B5CAT), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,80))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "2018: Number of years",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nco[["D18"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[2]))
    rank
  })
  
  
  #### B6 Have you ever been a cross-border commuter in Switzerland before your current stay in Switzerland? ####    
  
  output$B6_16 <-renderHighchart({ 
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BQ,input$mag1,"year")]
    
    x[is.na(x)] <- -7
    
    colnames(x)<-c("B6","pop","year")
    x<-x %>%
      group_by(year,B6) %>% 
      filter(B6!=-7)%>%
      summarise(pop=round(sum(pop),0))
    x
    #})
    
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Have you ever been a cross-border commuter in Switzerland", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  }) 
  
  output$B6_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  
  
  #### B8 REASON FOR MIGRATING TO SWITZERLAND ####
  
  
  
  #input<-data.frame(mag1="weight",mag3="Relative")
  
  output$B8_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B8_1","B8_2","B8_3","B8_4",
              "B8_5","B8_6","B8_7","B8_8",
              "B8_9","B8_10",input$mag1,"year")]
      
      colnames(x)<-c("B8_1","B8_2","B8_3","B8_4",
                     "B8_5","B8_6","B8_7","B8_8",
                     "B8_9","B8_10","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B8_1, B8_2,B8_3, B8_4,B8_5,
                                         B8_6,B8_7,B8_8,B8_9,B8_10), factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF1<-marDF[marDF$year==2016,]
    
    dmms18 <-  dmms[[2]]
    dmms18<-list(dmms18)
    mar2 <- lapply(dmms18, function(x){
      
      x<-x[,c("B8_1","B8_2","B8_3","B8_4",
              "B8_5","B8_6","B8_7","B8_8",
              "B8_9","B8_10","B8_11","B8_12",input$mag1,"year")]
      
      colnames(x)<-c("B8_1","B8_2","B8_3","B8_4",
                     "B8_5","B8_6","B8_7","B8_8",
                     "B8_9","B8_10","B8_11","B8_12","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B8_1, B8_2,B8_3, B8_4,B8_5,
                                         B8_6,B8_7,B8_8,B8_9,B8_10,
                                         B8_11,B8_12), factor_key=FALSE)
      
      xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    
    dmms20 <-  dmms[[3]]
    dmms20<-list(dmms20)
    mar3 <- lapply(dmms20, function(x){
      
      x<-x[,c("B8_1","B8_2","B8_3","B8_4",
              "B8_5","B8_6","B8_7","B8_8",
              "B8_9","B8_10","B8_12",input$mag1,"year")]
      
      colnames(x)<-c("B8_1","B8_2","B8_3","B8_4",
                     "B8_5","B8_6","B8_7","B8_8",
                     "B8_9","B8_10","B8_12","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B8_1, B8_2,B8_3, B8_4,B8_5,
                                         B8_6,B8_7,B8_8,B8_9,B8_10,
                                         B8_12), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3))
    
    marDF<-rbind(marDF1,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B8_1","B8_2","B8_3","B8_4","B8_5",
                                                "B8_6", "B8_7","B8_8", "B8_9",
                                                "B8_12", "B8_10"))
    levels(marDF$groupz)<-c("Professional reasons",
                            "Educational and/or study reasons",
                            "To join a partner and/or to start a family",
                            "To accompany family",
                            "Lifestyle reasons",
                            "Gain new experiences",
                            "Social network in Switzerland",
                            "Tax reasons",
                            "Political reasons",
                            "Health reasons",
                            "Other reasons")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 4500,450000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("groupz","year","prop")
    
    marDF1$year <-paste("Wave",  marDF1$year,sep=" ")
    
    rank <-marDF1 %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Reasons for moving to Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(dmms[[1]][input$mag1])),sep=": "),
        paste("\n2018 N",a(sum(dmms[[2]][input$mag1])),sep=": "),
        paste("\n2020 N",a(sum(dmms[[3]][input$mag1])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
    
  }) 
  
  
  #### b9 married before coming? ######
  
  output$B9_16 <-renderHighchart({ 
    
    
    fst <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      
      x[is.na(x)] <- -7
      colnames(x)<-c("B9","pop","year")
      x<-x %>%
        group_by(year,B9) %>% 
        filter(B9!=-7)%>%
        filter(B9!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    
    fstDF<- as.data.frame(do.call("rbind", fst))
    fstDF<-fstDF[fstDF$B9==1,]
    fstDF$B9<-as.factor(fstDF$B9)
    levels(fstDF$B9)<-"Yes"
    
    
    data<- if(input$mag3=="Absolute"){ 
      fstDF[,c("year","B9", "pop")]}else{
        fstDF[,c("year","B9", "prop")]}
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 7000,700000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = factor(data$B9), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(dmms[[1]][input$mag1])),sep=": "),
        paste("\n2018 N",a(sum(dmms[[2]][input$mag1])),sep=": "),
        paste("\n2020 N",a(sum(dmms[[3]][input$mag1])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Were you married or in a relationship when coming to Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  #### B10 WHAT WAS THE SITUATION BEFORE COMING TO SWITZERLAND ####
  
  output$B10_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BQ,input$mag1,"year")]
      x[is.na(x)] <- -7
      colnames(x)<-c("B10","pop","year")
      x<-x %>%
        group_by(year,B10) %>% 
        filter(B10!=-7)%>%
        filter(B10!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      
      x$B10<-as.factor(x$B10)
      x$B10<-fct_explicit_na(x$B10)
      levels(x$B10)<-c(
        "Your spouse/partner already lived in Switzerland when you met.",
        "You moved together.",
        "Your spouse/partner moved before you.",
        "Your spouse/partner moved after you.",
        "Your spouse/partner has not yet moved to Switzerland.")
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar))
    
    data<- if(input$mag3=="Absolute"){ 
      marDF[,c("year","B10", "pop")]}else{
        marDF[,c("year","B10", "prop")]}
    
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 2000,175000)
    
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$B10), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Which of you moved to Switzerland first, or did you move to Switzerland together??",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(mar[[1]]$pop)),sep=": "),
        paste("\n2018 N",a(sum(mar[[2]]$pop)),sep=": "),
        paste("\n2020 N",a(sum(mar[[3]]$pop)),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
    
  }) 
  
  
  
  #### B11 WWhich of you got had a job here in Switzerland first? ####
  
  output$B11_1_16 <-renderHighchart({ 
    
    x<-dmms[["D16"]][,c("B11_1","B11_2","B11_3","B11_4","B11_5",
                        input$mag1,"year")]#input$mag1,"
    
    colnames(x)<-c("B11_1","B11_2","B11_3","B11_4","B11_5",
                   "pop","year")
    
    x[is.na(x)] <- -7
    
    
    xlong<-x %>%gather(groupz, value,c(B11_1, B11_2,B11_3, B11_4,B11_5),
                       factor_key=FALSE)
    
    
    x1<-xlong %>%
      group_by(year,groupz) %>% 
      filter(value!=-7)%>%
      filter(value!=-9)%>%
      filter(value!=-8)%>%
      filter(value!=2)%>%
      summarise(pop=round(sum(pop),0))
    
    x2<-xlong %>%
      group_by(year,groupz) %>% 
      filter(value!=-7)%>%
      filter(value!=-9)%>%
      filter(value!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    x1$prop<-round(x1$pop/(x2$pop)*100,1)
    x1$groupz<- as.factor(x1$groupz)
    
    levels(x1$groupz)<-c("You got had a job before your spouse/partner",
                         "Your spouse/partner got had a job before you",
                         "You both got had a job around the same time",
                         "You have never had a job in Switzerland",
                         "Your spouse/partner has never had a job in Switzerland")
    
    data<- if(input$mag3=="Absolute"){ 
      x1[,c("year","groupz", "pop")]}else{
        x1[,c("year","groupz", "prop")]}
    
    colnames(data)<-c("year","groupz", "prop")
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1250,125000)
    
    
    rank <-data %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Which of you got had a job here in Switzerland first?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(x1$pop)),sep=": "),
        #paste("\n2018 N",a(sum(x1$pop)),sep=": "),
        #paste("\n2020 N",a(sum(x1$pop)),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[1]))
    
    rank
    
    
  })
  #### B12 did you have relatives already living here? ####
  
  output$B12_16 <-renderHighchart({ 
    
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("B12",input$mag1,"year")]
    
    colnames(x)<-c("B12","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,B12) %>% 
      filter(B12!=-7)%>%
      filter(B12!=-9)%>%
      summarise(pop=round(sum(pop),0))
    
    
    #})
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Relatives already living in Switzerland", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  })   
  
  output$B12_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  
  ##### b13 did you receive any support in one of the following areas #####
  
  #input<-data.frame(mag1="weight",mag3="Relative")
  output$B13_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B13_1","B13_2","B13_3",
              "B13_5","B13_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_1","B13_2","B13_3",
                     "B13_5","B13_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_1, B13_2,B13_3,B13_5,
                                         B13_6), factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    #marDF1<-marDF[marDF$year==2016,]
    
    dmms18 <-  dmms[1:2]
    #dmms18<-list(dmms18)
    mar2 <- lapply(dmms18, function(x){
      
      x<-x[,c("B13_4",input$mag1,"year")] #input$mag1,
      
      colnames(x)<-c("B13_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_4), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    
    dmms20 <-  dmms[3]
    #dmms20<-list(dmms20)
    mar3 <- lapply(dmms20, function(x){
      
      x<-x[,c("B13_9",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_9), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3))
    
    dmms1 <-  dmms[1]
    #dmms20<-list(dmms20)
    mar4 <- lapply(dmms1, function(x){
      
      x<-x[,c("B13_7","B13_8",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_7","B13_8","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_7,B13_8), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF4<- as.data.frame(do.call("rbind", mar4))
    
    
    marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B13_1", "B13_2", "B13_3",
                                                "B13_4", "B13_5", "B13_6",
                                                "B13_7", "B13_8", "B13_9"))
    levels(marDF$groupz)<-c("Allowance for or payment of moving costs",
                            "Housing",
                            "Dealing with administrative issues",
                            "Allowance for or payment of language courses",
                            "School/childcare",
                            "Spouse/partner employment support",
                            "Information about Switzerland",
                            "Other support",
                            "Finding a job after being arrived in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 4500,450000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("groupz","year","prop")
    marDF1$year <-paste("Wave",marDF$year, sep="")
    rank <-marDF1 %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Did you receive any support in one of the following areas?",align = 'left')  %>%
      #hc_subtitle(text =paste(
      # paste("\n2016 N",a(sum(marDF[marDF$year==2016,'pop'])),sep=": "),
      #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,'pop'])),sep=": "),
      #  paste("\n2020 N",a(sum(marDF[marDF$year==2020,'pop'])),sep=": "),
      #  sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  }) 
  
  #### b13 tables ####
  
  output$TB13_16<- renderText({
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B13_1","B13_2","B13_3",
              "B13_5","B13_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_1","B13_2","B13_3",
                     "B13_5","B13_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_1, B13_2,B13_3,B13_5,
                                         B13_6), factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    #marDF1<-marDF[marDF$year==2016,]
    
    dmms18 <-  dmms[1:2]
    #dmms18<-list(dmms18)
    mar2 <- lapply(dmms18, function(x){
      
      x<-x[,c("B13_4",input$mag1,"year")] #input$mag1,
      
      colnames(x)<-c("B13_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_4), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    
    
    marDF2<- as.data.frame(do.call("rbind", mar2))
    
    dmms20 <-  dmms[3]
    #dmms20<-list(dmms20)
    mar3 <- lapply(dmms20, function(x){
      
      x<-x[,c("B13_9",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_9), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    
    
    marDF3<- as.data.frame(do.call("rbind", mar3))
    
    dmms1 <-  dmms[1]
    #dmms20<-list(dmms20)
    mar4 <- lapply(dmms1, function(x){
      
      x<-x[,c("B13_7","B13_8",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B13_7","B13_8","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B13_7,B13_8), factor_key=FALSE)
      
      #xlong$groupz<-ifelse(xlong$groupz=="B8_11","B8_3",xlong$groupz)
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    
    marDF4<- as.data.frame(do.call("rbind", mar4))
    
    
    marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B13_1", "B13_2", "B13_3",
                                                "B13_4", "B13_5", "B13_6",
                                                "B13_7", "B13_8", "B13_9"))
    levels(marDF$groupz)<-c("Allowance for or payment of moving costs",
                            "Housing",
                            "Dealing with administrative issues",
                            "Allowance for or payment of language courses",
                            "School/childcare",
                            "Spouse/partner employment support",
                            "Information about Switzerland",
                            "Other support",
                            "Finding a job after being arrived in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    kable(marDF %>%
            # arrange(desc(pop))%>%
            #ungroup %>%
            select(groupz,year,pop)%>%
            rename(Area="groupz", Year = "year", N = "pop"))%>%
      #)%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  })
  
  #### B14 From whom did you receive support? ####
  
  output$B14_1_16 <-renderHighchart({ 
    
    x<-dmms[["D16"]][,c("B14_1","B14_2","B14_3","B14_4","B14_5",
                        "B14_6","B14_7","B14_8",
                        input$mag1,"year")]#input$mag1,"
    
    colnames(x)<-c("B14_1","B14_2","B14_3","B14_4","B14_5",
                   "B14_6","B14_7","B14_8",
                   "pop","year")
    
    x[is.na(x)] <- -7
    
    xlong<-x %>%gather(groupz, value,c(B14_1,B14_2,B14_3,B14_4,B14_5,
                                       B14_6,B14_7,B14_8),
                       factor_key=FALSE)
    
    
    x1<-xlong %>%
      group_by(year,groupz) %>% 
      filter(value!=-7)%>%
      filter(value!=-9)%>%
      filter(value!=-8)%>%
      filter(value!=2)%>%
      summarise(pop=round(sum(pop),0))
    
    x2<-xlong %>%
      group_by(year,groupz) %>% 
      filter(value!=-7)%>%
      filter(value!=-9)%>%
      filter(value!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
    x1$groupz<- as.factor(x1$groupz)
    
    levels(x1$groupz)<-c("Relatives in Switzerland",
                         "Friends in Switzerland",
                         "Business relations/colleagues in Switzerland",
                         "Your employer",
                         "A private institution",
                         "A public institution",
                         "An online social media/website/blog",
                         "Other")
    
    data<- if(input$mag3=="Absolute"){ 
      x1[,c("year","groupz", "pop")]}else{
        x1[,c("year","groupz", "prop")]}
    
    colnames(data)<-c("year","groupz", "prop")
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 2500,150000)
    
    data$year <-paste("Wave",data$year, sep=" ")
    rank <-data %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "From whom did you receive support?",align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(x1$pop)),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[1]))
    
    rank
    
    
    
  })  
  
  #### B21 Who provided you the support for the payment of moving costs? #####
  
  output$B21_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B21_1","B21_2","B21_3","B21_4",
              "B21_5","B21_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B21_1","B21_2","B21_3","B21_4",
                     "B21_5","B21_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B21_1, B21_2,B21_3,
                                         B21_4,B21_5,B21_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B21_1","B21_2","B21_3",
                                                "B21_4","B21_5","B21_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("groupz","year","prop")
    
    
    marDF1$year <-paste("Wave",marDF1$year, sep=" ")  
    rank <-marDF1 %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support for the payment of moving costs?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  
  
  #### B22 Who provided you the support for the payment of moving costs? #####
  
  output$B22_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B22_1","B22_2","B22_3","B22_4",
              "B22_5","B22_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B22_1","B22_2","B22_3","B22_4",
                     "B22_5","B22_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B22_1, B22_2,B22_3,
                                         B22_4,B22_5,B22_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B22_1","B22_2","B22_3",
                                                "B22_4","B22_5","B22_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ") 
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support for housing?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  
  
  #### B23 Who provided you the support for the payment of moving costs? #####
  
  output$B23_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B23_1","B23_2","B23_3","B23_4",
              "B23_5","B23_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B23_1","B23_2","B23_3","B23_4",
                     "B23_5","B23_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B23_1, B23_2,B23_3,
                                         B23_4,B23_5,B23_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B23_1","B23_2","B23_3",
                                                "B23_4","B23_5","B23_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ") 
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support for dealing with administrative issues?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  
  
  
  #### B24 Who provided you the support for the payment of moving costs? #####
  
  output$B24_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B24_1","B24_2","B24_3","B24_4",
              "B24_5","B24_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B24_1","B24_2","B24_3","B24_4",
                     "B24_5","B24_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B24_1, B24_2,B24_3,
                                         B24_4,B24_5,B24_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B24_1","B24_2","B24_3",
                                                "B24_4","B24_5","B24_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ") 
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support for school/childcare?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  
  
  
  #### B25 Who provided you the support for the payment of moving costs? #####
  
  output$B25_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B25_1","B25_2","B25_3","B25_4",
              "B25_5","B25_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B25_1","B25_2","B25_3","B25_4",
                     "B25_5","B25_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B25_1, B25_2,B25_3,
                                         B25_4,B25_5,B25_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B25_1","B25_2","B25_3",
                                                "B25_4","B25_5","B25_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ") 
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support for the spouse/partner employment?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  
  
  #### B27 Who provided you the support for the payment of moving costs? #####
  
  output$B27_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("B27_1","B27_2","B27_3","B27_4",
              "B27_5","B27_6",input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B27_1","B27_2","B27_3","B27_4",
                     "B27_5","B27_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B27_1, B27_2,B27_3,
                                         B27_4,B27_5,B27_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    
    
    #marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
                                                "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Relatives or friends already living in Switzerland",
                            "Your employer",
                            "Business relations/colleagues in Switzerland",
                            "A private institution",
                            "A public institution",
                            "Others")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 1500,100000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$mag3=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    marDF$year <-paste("Wave",marDF$year, sep=" ") 
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Who provided you the support to find a job after being arrived in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2:3]))
    
    rank  
    
  }) 
  
  
  #### B15 FROM 0 TO 7 #####
  
  #input<-data.frame(mag1="weight",mag3="Relative")
  
  output$B15_1_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    
    marDFf<-marDF[marDF$groupz=="Financing the move and the settlement in Switzerland",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Financing the move and the settlement in Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
    
  })   
  
  output$B15_2_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Finding accommodation",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Finding accommodation",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank    
    
  })
  
  output$B15_3_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Finding childcare/school",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Finding childcare/school",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  })
  
  output$B15_4_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Dealing with the administration",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Dealing with the administration",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
    
  })
  
  output$B15_5_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #   filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Speaking/understanding the local language",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Speaking/understanding the local language",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  })
  
  output$B15_6_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Feeling lonely and/or homesick",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Feeling lonely and/or homesick",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
    
  })
  
  output$B15_7_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Feeling homesick",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Feeling homesick",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
    
  })
  
  output$B15_8_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("B15_1","B15_2","B15_3","B15_4",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_1","B15_2","B15_3","B15_4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_1, B15_2,B15_3,B15_4),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1620 <-  dmms[c(1,3)]
    mar2 <- lapply(dmms1620, function(x){
      
      x<-x[,c("B15_5",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_5),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    
    dmms1820 <-  dmms[c(2,3)]
    mar4 <- lapply(dmms1820, function(x){
      
      x<-x[,c("B15_8",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_8","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_8),
                         factor_key=FALSE)
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      
      #    x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF4<- as.data.frame(do.call("rbind", mar4))
    
    #dmms1820 <-  dmms[2:3]
    dmms16 <-  dmms[1]
    mar3 <- lapply(dmms16, function(x){
      
      x<-x[,c("B15_6","B15_7",
              input$mag1,"year")]#input$mag1,
      
      colnames(x)<-c("B15_6","B15_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(B15_6,B15_7),
                         factor_key=FALSE)
      
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz, value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      x1
    })
    marDF3<- as.data.frame(do.call("rbind", mar3)) #CATS 1,2,4,5,6
    
    marDF<-rbind(marDF,marDF2,marDF3,marDF4)
    #marDF1<-marDF[marDF$year==2016,]
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Financing the move and the settlement in Switzerland",
                            "Finding accommodation",
                            "Finding childcare/school",
                            "Dealing with the administration",
                            "Speaking/understanding the local language",
                            "Feeling lonely and/or homesick",
                            "Feeling homesick",
                            "Finding a job for the spouse/partner")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$mag1=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$mag3=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDFf<-marDF[marDF$groupz=="Finding a job for the spouse/partner",]
    
    marDFf1<-if(input$mag3=="Relative"){
      marDFf[,c(1,2,3,5)]
    } else {
      marDFf[,c(1,2,3,4)]}
    
    colnames(marDFf1)<-c("groupz","year","value", "prop")
    
    marDFf1<-as.data.frame(marDFf1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDFf1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDFf1[marDFf$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDFf1[marDFf$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDFf1[marDFf$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag3=="Absolute",0,0),
               max=ifelse(input$mag3=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Finding a job for the spouse/partner",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFf[marDFf$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFf[marDFf$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFf[marDFf$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  })
  
  
  #### c1 Do you intend to apply for the Swiss nationality in the future? #####
  
  output$C1_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BC,input$magC,"year")] #input$BC,input$magC,
      
      colnames(x)<-c("C1", "pop","year")
      
      x<-x %>%
        group_by(year,C1) %>% 
        filter(C1!=-9)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((C1))
      
      x$C1<-as.factor(x$C1)
      x$C1<-fct_explicit_na(x$C1)
      
      x
    })
    
    levels(mar[["D16"]]$C1)<-c("Yes, certainly",
                               "Yes, probably",
                               "No, probably not",
                               "No, certainly not",
                               "I do not know yet",
                               "I have already applied for the Swiss nationality")
    
    levels(mar[["D18"]]$C1)<-c("Yes, certainly",
                               "Yes, probably",
                               "No, probably not",
                               "No, certainly not",
                               "I do not know yet",
                               "I have already applied for the Swiss nationality")
    
    levels(mar[["D20"]]$C1)<-c("Yes, certainly",
                               "Yes, probably",
                               "No, probably not",
                               "No, certainly not",
                               "I do not know yet",
                               "I have already applied for the Swiss nationality",
                               "I have already being naturalized")
    
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(C1, nesting(year))
    marDF$C1<-as.factor(marDF$C1)
    
    marDF[is.na(marDF)] <- 0
    
    #marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magC=="n_nw", 2500,275000)
    
    formatter<- ifelse(input$magC2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magC2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("groupz","year","prop")
    
    marDF1$year<-paste("Wave ",marDF$year, sep="")
    
    rank <-marDF1 %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magC2=="Absolute",0,0),
               max=ifelse(input$magC2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you intend to apply for the Swiss nationality in the future?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  }) 
  
  #### c2 Why do you not wish to acquire the Swiss citizenship nationality? #####
  
  output$C2_1_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("C2_1","C2_2","C2_3","C2_4",
              "C2_5","C2_6","C2_7","C2_8",input$magC,"year")]#input$magC,
      
      colnames(x)<-c("C2_1","C2_2","C2_3","C2_4",
                     "C2_5","C2_6","C2_7","C2_8","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(C2_1,C2_2,C2_3,C2_4,
                                         C2_5,C2_6,C2_7,C2_8),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("I do not fulfill the requirements",
                            "I do not intend to stay in Switzerland for good",
                            "I do not feel a bond with Switzerland",
                            "I do not see any benefit in it",
                            "I do not want to give up current nationality",
                            "I do not want to lose my rights/benefits of my country of origin",
                            "I do not want to go through the process, which is too expensive/complicated/long",
                            "Other reasons")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magC=="n_nw", 1000,75000)
    
    formatter<- ifelse(input$magC2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magC2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("groupz","year","prop")
    
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("C1",input$magC,"year")] #input$BC,input$magC,
      
      colnames(x)<-c("C1", "pop","year")
      
      x<-x %>%
        group_by(year,C1) %>% 
        filter(C1!=-9)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((C1))
      
      x$C1<-as.factor(x$C1)
      x$C1<-fct_explicit_na(x$C1)
      
      x
    })
    
    levels(mar1[["D16"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality")
    
    levels(mar1[["D18"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality")
    
    levels(mar1[["D20"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality",
                                "I have already being naturalized")
    
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    marDFtotales<-marDFtotales[(marDFtotales$C1=="No, probably not"|
                                  marDFtotales$C1=="No, certainly not"), ]
    
    marDF1$year<-paste("Wave ",marDF$year, sep="")
    rank <-marDF1 %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magC2=="Absolute",0,0),
               max=ifelse(input$magC2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Why do you not wish to acquire the Swiss citizenship nationality?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  }) 
  
  #### C3 why you want the swiss nationality #####
  
  output$C3_1_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("C3_1","C3_2","C3_3","C3_4",
              "C3_5","C3_6","C3_7",input$magC,"year")]#input$magC,
      
      colnames(x)<-c("C3_1","C3_2","C3_3","C3_4",
                     "C3_5","C3_6","C3_7","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(C3_1,C3_2,C3_3,C3_4,
                                         C3_5,C3_6,C3_7),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    dmms1820 <-  dmms[2:3]
    mar2 <- lapply(dmms1820, function(x){
      
      x<-x[,c("C3_8","C3_9",input$magC,"year")]#input$magC,
      
      colnames(x)<-c("C3_8","C3_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(C3_8,C3_9),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF2<- as.data.frame(do.call("rbind", mar2))
    
    marDFf<-rbind(marDF,marDF2)
    
    marDFf<-marDFf %>% complete(groupz, nesting(year))
    marDFf$groupz<-as.factor(marDFf$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDFf$groupz)<-c("My spouse/partner and/or close family members are Swiss",
                             "I wish to vote in national elections, to get involved in my local community",
                             "It makes it easier to visit my country of origin or other countries",
                             "I feel that I belong in Switzerland",
                             "It will give me better professional opportunities",
                             "It will protect me from being expulsed from Switzerland",
                             "It simplifies administrative procedures",
                             "To offer a better future to my children / family",
                             "Other reasons")
    marDFf[is.na(marDFf)] <- 0
    
    marDFf<-with(marDFf, marDFf[order(groupz),])
    
    hc_yAxis<-ifelse(input$magC=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$magC2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDFf<-if(input$magC2=="Relative"){
      marDFf[,c(1,2,4)]
    } else {
      marDFf[,c(1,2,3)]}
    
    colnames(marDFf)<-c("groupz","year","prop")
    marDFf$year<-paste("Wave ",marDFf$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("C1",input$magC,"year")] #input$BC,input$magC,
      
      colnames(x)<-c("C1", "pop","year")
      
      x<-x %>%
        group_by(year,C1) %>% 
        filter(C1!=-9)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((C1))
      
      x$C1<-as.factor(x$C1)
      x$C1<-fct_explicit_na(x$C1)
      
      x
    })
    
    levels(mar1[["D16"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality")
    
    levels(mar1[["D18"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality")
    
    levels(mar1[["D20"]]$C1)<-c("Yes, certainly",
                                "Yes, probably",
                                "No, probably not",
                                "No, certainly not",
                                "I do not know yet",
                                "I have already applied for the Swiss nationality",
                                "I have already being naturalized")
    
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    marDFtotales<-marDFtotales[(marDFtotales$C1=="Yes, certainly"|
                                  marDFtotales$C1=="Yes, probably"|
                                  marDFtotales$C1=="I have already applied for the Swiss nationality"), ]
    
    
    rank <-marDFf %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magC2=="Absolute",0,0),
               max=ifelse(input$magC2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Why would you like to acquire the Swiss citizenship nationality?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%   
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
  }) 
  
  
  
  
  
  
  ### D1 What is the highest level of education you have successfully completed? ####
  
  output$D1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BD,input$magD,"year")]
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("D1", "pop","year")
      x<-x %>%
        group_by(year,D1) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((D1))
      
      x$D1<-as.factor(x$D1)
      x$D1<-fct_explicit_na(x$D1)
      
      x
    })
    
    levels(mar[["D16"]]$D1)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    levels(mar[["D18"]]$D1)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    levels(mar[["D20"]]$D1)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$D1<-as.factor(marDF$D1)
    
    data<- if(input$magD2=="Absolute"){ 
      marDF[,c("year","D1", "pop")]}else{
        marDF[,c("year","D1", "prop")]}
    
    hc_yAxis<-ifelse(input$magD=="n_nw", 6000,475000)
    
    formatter<- ifelse(input$magD2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$D1), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$mag2=="Absolute",0,0),
               max=ifelse(input$mag2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "What is the highest level of education you have successfully completed?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  #### D2 In which country did you attain your highest educational qualification?  ###### 
  
  output$D2_16 <-renderHighchart({ 
    
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$BD,input$magD,"year")]#input$BD,input$magD
      colnames(x)<-c("D2","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"D2"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("D2","B",sep="")
      x$D2B<-as.factor(x$D2B)
      x$D2B<-fct_explicit_na(x$D2B)
      
      colnames(x)<-c("A3","pop","year","A3B")
      
      x<-x %>%
        group_by(year,A3B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$yearD,]
    
    data<- if(input$magD2=="Absolute"){ 
      nacdf[,c("year","A3B","pop")]}else{
        nacdf[,c("year","A3B", "prop")]}
    
    formatter<- ifelse(input$magD2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magD=="n_nw", 700,175000)
    
    color<-ifelse(input$yearD==2016,1,
                  ifelse(input$yearD==2018,2,3))
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$A3B), title = list(text = '')) %>%
      #hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of highest education:",input$yearD,sep=" "),
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$yearD==2016){ 
          1}else{
            if(input$yearD==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magD2=="Absolute",0,0),
               max=ifelse(input$magD2=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  }) 
  
  
  
  #### D3 HIGHER LEVEL OF EDUCATION IN HOME COUNTRY #####
  
  output$D3_16 <-renderHighchart({ 
    #input<-data.frame(BD="D3", magD="weight",magD2="Relative")
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BD,input$magD, "year")]#input$BD,input$magD,
      
      colnames(x)<-c("D3", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year,D3) %>% 
        filter(D3!=-9)%>% 
        filter(D3!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(D3))
      
      x$D3<-as.factor(x$D3)
      x$D3<-fct_explicit_na(x$D3)
      
      x
    })
    
    levels(mar[["D16"]]$D3)<-c("Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent",
                               "I have never been in school in my home country of origin [B1]")
    
    levels(mar[["D18"]]$D3)<-c("Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent",
                               "I have never been in school in my home country of origin [B1]")
    
    levels(mar[["D20"]]$D3)<-c("Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent",
                               "I have never been in school in my home country of origin [B1]")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$D3<-as.factor(marDF$D3)
    
    data<- if(input$magD2=="Absolute"){ 
      marDF[,c("year","D3", "pop")]}else{
        marDF[,c("year","D3", "prop")]}
    
    data<-with(data, data[order(D3),])
    hc_yAxis<-ifelse(input$magD=="n_nw", 750,50000)
    
    formatter<- ifelse(input$magD2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$D3), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magD2=="Absolute",0,0),
               max=ifelse(input$magD2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What is the highest level of education that you have completed in your home country of origin?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank})
  
  #### D4 Did you make an official request in Switzerland in order to obtain a certificate of equivalence for your educational qualifications? #####
  
  output$D4_16 <-renderHighchart({ 
    #input<-data.frame(BD="D3", magD="weight",magD2="Relative")
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BD,input$magD, "year")]#input$BD,input$magD,
      
      colnames(x)<-c("D3", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year,D3) %>% 
        filter(D3!=-9)%>% 
        filter(D3!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(D3))
      
      x$D3<-as.factor(x$D3)
      x$D3<-fct_explicit_na(x$D3)
      
      x
    })
    
    levels(mar[["D16"]]$D3)<-c("Yes, the certificate was obtained",
                               "Yes, but the certificate was not obtained",
                               "Yes, but the procedure is not yet complete",
                               "No, it was not necessary",
                               "No, other reasons")
    
    levels(mar[["D18"]]$D3)<-c("Yes, the certificate was obtained",
                               "Yes, but the certificate was not obtained",
                               "Yes, but the procedure is not yet complete",
                               "No, it was not necessary",
                               "No, other reasons")
    
    levels(mar[["D20"]]$D3)<-c("Yes, the certificate was obtained",
                               "Yes, but the certificate was not obtained",
                               "Yes, but the procedure is not yet complete",
                               "No, it was not necessary",
                               "No, other reasons")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$D3<-as.factor(marDF$D3)
    
    data<- if(input$magD2=="Absolute"){ 
      marDF[,c("year","D3", "pop")]}else{
        marDF[,c("year","D3", "prop")]}
    
    data<-with(data, data[order(D3),])
    hc_yAxis<-ifelse(input$magD=="n_nw", 5000,500000)
    
    formatter<- ifelse(input$magD2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$D3), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magD2=="Absolute",0,0),
               max=ifelse(input$magD2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Did you make an official request in Switzerland in order to obtain a certificate of equivalence for your educational qualifications?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")
    
    rank})
  
  #### D7 Please enter the formal education in which you are currently engaged #####
  
  output$D7_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BD,input$magD,"year")]
    
    colnames(x)<-c("D7", "pop","year")
    x[is.na(x)] <- 99
    
    x<-x %>%
      group_by(D7) %>% 
      filter(D7!=99)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(D7))
    
    x$D7<-as.factor(x$D7)
    x$D7<-fct_explicit_na(x$D7)
    
    x
    # })
    
    levels(x$D7)<-c("Compulsory education",
                    "Higher secondary education not giving access to universities (or similar)",
                    "Vocational education and/or training",
                    "High school-leaving certificate giving access to universities (or similar)",
                    "Advanced technical and professional training",
                    "Bachelor or equivalent",
                    "Master or equivalent",
                    "Phd Doctoral or equivalent")
    
    
    data<- if(input$magD2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magD=="n_nw", 200,20000)
    
    formatter<- ifelse(input$magD2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$D7), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magD2=="Absolute",0,0),
               max=ifelse(input$magD2=="Absolute",hc_yAxis,30))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: Formal education in which you are currently engaged",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[1]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")
    
    
    rank})
  
  
  
  output$D7_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  
  
  
  
  
  #### E1 WHAT WAS YOUR LABOUR MARKET SITUATION ##### 
  
  output$E1_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E1_1","E1_2","E1_3","E1_4",
              "E1_5","E1_6","E1_7","E1_8","E1_9",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E1_1","E1_2","E1_3","E1_4",
                     "E1_5","E1_6","E1_7","E1_8","E1_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E1_1,E1_2,E1_3,E1_4,
                                         E1_5,E1_6,E1_7,E1_8,E1_9),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("In full-time employment",
                            "In part-time employment",
                            "Working in more than one part-time job",
                            "Seeking a job",
                            "Undergoing training",
                            "Looking after home or family",
                            "Disabled or partially disabled",
                            "Retired",
                            "In another non-employed situation")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5500,550000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    data<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(data)<-c("groupz","year","prop")
    
    data$year<-paste("Wave ",data$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E1_1",input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E1_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E1_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    rank <-data %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Labour market situation before moving to Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E30 Before moving to Switzerland in [A6], did you ever work abroad (Abroad means in another country than Switzerland)? ####
  
  output$E30_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E30",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E30","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E30),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes, I already had a working experience abroad")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 1000, 100000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E30",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E30","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E30),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) 
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Before moving to Switzerland, did you ever work abroad?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2,3)]))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E31 Before moving to Switzerland in [A6], did you work as a cross-border worker in Switzerland? ####
  
  output$E31_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E31",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E31","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E31),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes, I was a cross-border worker")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 500, 50000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E31",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E30","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E30),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) 
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,20))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Before moving to Switzerland, did you ever work abroad?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>% hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2,3)]))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E2 OCCUPATIONAL SITUATION ##### 
  
  output$E2_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E2","weight","year")]
      colnames(x)<-c("E2", "pop","year")
      x<-x %>%
        filter(E2!=-7)%>%
        filter(E2!=-9)%>%
        filter(E2!=-8)%>%
        group_by(year,E2) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E2))
      
      x$E2<-as.factor(x$E2)
      x$E2<-fct_explicit_na(x$E2)
      
      x
    })
    
    levels(mar[["D16"]]$E2)<-c("Self-employed",
                               "A company owner",
                               "A relative employed in a family business",
                               "Employed as director or board member and/or with managerial",
                               "Employed without managerial responsibility",
                               "Employed in a protected workshop (except support staff)",
                               "An apprentice",
                               "A PhD student")
    
    levels(mar[["D18"]]$E2)<-c("Self-employed",
                               "A company owner",
                               "A relative employed in a family business",
                               "Employed as director or board member and/or with managerial",
                               "Employed without managerial responsibility",
                               "Employed in a protected workshop (except support staff)",
                               "An apprentice",
                               "A PhD student")
    
    levels(mar[["D20"]]$E2)<-c("Self-employed",
                               "A company owner",
                               "A relative employed in a family business",
                               "Employed as director or board member and/or with managerial",
                               "Employed without managerial responsibility",
                               "Employed in a protected workshop (except support staff)",
                               "An apprentice",
                               "A PhD student")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E2<-as.factor(marDF$E2)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E2", "pop")]}else{
        marDF[,c("year","E2", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5000,500000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E2), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What was your occupational status before moving to Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  #### E3 Once you arrived in Switzerland in [A6], what sector of business, or industry was your company or institution active in for the most part? ####
  
  output$E3_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E3","pop","year")
    x<-x %>%
      group_by(year,E3) %>% 
      filter(E3!=-7)%>%
      filter(E3!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop)*100),1))
    
    x$E3<-as.factor(x$E3)
    x$E3<-fct_explicit_na(x$E3)
    x
    #})
    
    levels(x$E3)<-c(
      "Agriculture, forestry and fishing",
      "Manufacturing, mining and quarrying and other industry ",
      "Construction",
      "Wholesale and retail trade, transportation, hotels and restaurants",
      "Information and communication",
      "Financial and insurance activities",
      "Real estate activities",
      "Professional, scientific, technical, administration and support service activities",
      "Public administration, defense, education, human health and social action",
      "Other activities and services")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 1000,80000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E3), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: Sector of business, or industry was your company",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[1]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  output$E3_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  #### E32 Just before moving to Switzerland in [A6], were you actively looking for a new job in the labor market, either in Switzerland or abroad? ####
  
  output$E32_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E32",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E32","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E32),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 3000, 325000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E32",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E32","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E32),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Just before moving to Switzerland, were you actively looking for a new job in the labor market, either in Switzerland or abroad?",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2,3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  
  #### E33 Please indicate the situation that best describes your job search just before moving to Switzerland in [A6 ##### 
  output$E33_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E33","weight","year")]
      colnames(x)<-c("E33", "pop","year")
      x<-x %>%
        filter(E33!=-7)%>%
        filter(E33!=-9)%>%
        filter(E33!=-8)%>%
        group_by(year,E33) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E33))
      
      x$E33<-as.factor(x$E33)
      x$E33<-fct_explicit_na(x$E33)
      
      x
    })
    
    
    
    levels(mar[["D18"]]$E33)<-c("I was specifically looking for a job in Switzerland",
                                "I was looking for a job in Switzerland but also in other countries",
                                "I was looking for a job in another or other countries, Switzerland was not my priority")
    
    levels(mar[["D20"]]$E33)<-c("I was specifically looking for a job in Switzerland",
                                "I was looking for a job in Switzerland but also in other countries",
                                "I was looking for a job in another or other countries, Switzerland was not my priority")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E33<-as.factor(marDF$E33)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E33", "pop")]}else{
        marDF[,c("year","E33", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2000,200000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E33), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Job search just before moving to Switzerland",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  #### E34 What were the main reasons explaining that you were looking for a job in Switzerland?  ####
  
  output$E34_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E34_1","E34_2","E34_3",
              "E34_4","E34_5","E34_6",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E34_1","E34_2","E34_3",
                     "E34_4","E34_5","E34_6",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E34_1,E34_2,E34_3,
                                         E34_4,E34_5,E34_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Family reasons",
                            "The high wages in Switzerland",
                            "The overall working conditions in Switzerland",
                            "I was looking for a professional experience abroad, not specifically in Switzerland",
                            "The quality of life in Switzerland",
                            "Other reasons")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 1000, 125000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E34_1",input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E34_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E34_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What were the main reasons explaining that you were looking for a job in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | ")) %>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2,3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E4 WDid you have a job contract or a job offer in Switzerland at the time you immigrated to Switzerland in [A6]?  ####
  
  output$E4_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E4",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E4",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E4),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 4000, 400000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E4",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E4","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E4),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Did you have a job or a job offer in Switzerland before you immigrated to Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E5 It was a transfer within the same company ##### 
  
  output$E5_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E5",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E5",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E5),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 1250, 100000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E5",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E5","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E5),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "It was a transfer within the same company",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  ### E43 Under what type of work contract did you work when arriving in Switzerland?#####
  output$E43_20 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D20"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E43","pop","year")
    x<-x %>%
      group_by(year,E43) %>% 
      filter(E43!=-7)%>%
      filter(E43!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E43<-as.factor(x$E43)
    x$E43<-fct_explicit_na(x$E43)
    x
    #})
    
    levels(x$E43)<-c(
      "I retained my work contract with my company",
      "I have an additional assignment contract for the duration of my stay in Switzerland",
      "I have an employment contract with the Swiss branch of my company for the time of my stay in Switzerland",
      "I don't know")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 300,30000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E43), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,60))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2020", data = data) %>%
      hc_title(text = "Under what type of work contract did you work when arriving in Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[3]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  ### E44 If you had been given the choice, which type of work contract would you have preferred when coming to Switzerland? ####
  output$E44_20 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D20"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E44","pop","year")
    x<-x %>%
      group_by(year,E44) %>% 
      filter(E44!=-7)%>%
      filter(E44!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E44<-as.factor(x$E44)
    x$E44<-fct_explicit_na(x$E44)
    x
    #})
    
    levels(x$E44)<-c(
      "A contract with the company in the country I came from",
      "A contract with the Swiss branch of my company",
      "I don't know")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 500,30000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E44), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2020", data = data) %>%
      hc_title(text = "Under what type of work contract did you work when arriving in Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[3]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  #### E6 Before moving to Switzerland in [A6], in which countries did you look for a job?  ##### 
  
  output$E6_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E6_1","E6_2","E6_3",
              "E6_4","E6_5","E6_6",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E6_1","E6_2","E6_3",
                     "E6_4","E6_5","E6_6",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E6_1,E6_2,E6_3,
                                         E6_4,E6_5,E6_6),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Switzerland",
                            "Your home country of origin",
                            "Your country of birth",
                            "The last country you lived in prior to coming to Switzerland",
                            "Other countries",
                            "You were not looking for a job")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 3000, 300000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E6_1",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E6_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E6_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Before moving to Switzerland, in which countries did you look for a job?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E7 How did you go about looking for a job in Switzerland? ####
  output$E7_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E7_1","E7_2","E7_3",
              "E7_4","E7_5","E7_6",
              "E7_7","E7_8","E7_9","E7_10",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E7_1","E7_2","E7_3",
                     "E7_4","E7_5","E7_6",
                     "E7_7","E7_8","E7_9","E7_10",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E7_1,E7_2,E7_3,
                                         E7_4,E7_5,E7_6,
                                         E7_7,E7_8,E7_9,E7_10),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Contact potential employer(s) directly",
                            "Talk to friends or relatives",
                            "Place or answer newspaper, internet or other media ad(s)",
                            "Contact an employment agency",
                            "Ask for referrals from another employer",
                            "Contact a school, community college, university",
                            "Contact government agencies",
                            "Contact ethnic/cultural group or association",
                            "Participate in networking events",
                            "Other")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 1000, 100000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E6_1",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E6_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E6_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How did you go about looking for a job in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E8 Have you had any of the following problems or difficulties when looking for a job in Switzerland? ####
  output$E8_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E8_1","E8_2","E8_3",
              "E8_4","E8_5","E8_6",
              "E8_7","E8_8","E8_9",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E8_1","E8_2","E8_3",
                     "E8_4","E8_5","E8_6",
                     "E8_7","E8_8","E8_9",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E8_1,E8_2,E8_3,
                                         E8_4,E8_5,E8_6,
                                         E8_7,E8_8,E8_9),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    
    levels(marDF$groupz)<-c("Language problems",
                            "Qualifications and job experience from outside Switzerland not accepted",
                            "Problems with the administration or need for a permit in order to work",
                            "No family or friends who could help",
                            "No connections in the job market",
                            "Employers only offered you unsatisfactory job contracts",
                            "Personal or financial constraints (time, costs, family, other responsibilities)",
                            "Discrimination",
                            "Other problems or difficulties")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 750, 50000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Have you had any of the following problems or difficulties when looking for a job in Switzerland?",align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(tem[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  #### e8 tables ####
  
  output$TE8_16<- renderText({
    
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E8_1","E8_2","E8_3",
              "E8_4","E8_5","E8_6",
              "E8_7","E8_8","E8_9",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E8_1","E8_2","E8_3",
                     "E8_4","E8_5","E8_6",
                     "E8_7","E8_8","E8_9",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E8_1,E8_2,E8_3,
                                         E8_4,E8_5,E8_6,
                                         E8_7,E8_8,E8_9),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    
    levels(marDF$groupz)<-c("Language problems",
                            "Qualifications and job experience from outside Switzerland not accepted",
                            "Problems with the administration or need for a permit in order to work",
                            "No family or friends who could help",
                            "No connections in the job market",
                            "Employers only offered you unsatisfactory job contracts",
                            "Personal or financial constraints (time, costs, family, other responsibilities)",
                            "Discrimination",
                            "Other problems or difficulties")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    kable(marDF %>%
            # arrange(desc(pop))%>%
            #ungroup %>%
            select(groupz,year,pop)%>%
            rename(Area="groupz", Year = "year", N = "pop"))%>%
      #)%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  })
  
  #### E9 Sometimes people receive help when looking for job. From whom did you receive assistance? Was it from ####
  
  output$E9_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E9_1","E9_2","E9_3",
              "E9_4","E9_5","E9_6",
              "E9_7","E9_8",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E9_1","E9_2","E9_3",
                     "E9_4","E9_5","E9_6",
                     "E9_7","E9_8",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E9_1,E9_2,E9_3,
                                         E9_4,E9_5,E9_6,
                                         E9_7,E9_8),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Friends or relatives",
                            "Former business relations/colleagues",
                            "Your spouse's/partner's employer",
                            "A private institution",
                            "A public institution",
                            "Users of an online social media",
                            "Other persons or institutions",
                            "I did not receive any support")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 750, 75000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("E9_1",
              input$magE,"year")]#iinput$magE,
      
      colnames(x)<-c("E9_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E9_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) 
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "From whom did you receive assistance?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E10 Once you arrived in Switzerland in [A6], how long did you spend looking for a job before finding one? ####
  output$E10_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E10","pop","year")
    x<-x %>%
      group_by(year,E10) %>% 
      filter(E10!=-7)%>%
      filter(E10!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E10<-as.factor(x$E10)
    x$E10<-fct_explicit_na(x$E10)
    x
    #})
    
    levels(x$E10)<-c(
      "Less than one month",
      "Up to 6 months",
      "6 to 12 months",
      "More than 12 months")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 300,30000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E10), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,60))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "How long did you spend looking for a job before finding one",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  
  
  #### e11 What was your labor market situation once you arrived in Switzerland in [A6]? Were you ##### 
  
  output$E11_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E11_1","E11_2","E11_3","E11_4",
              "E11_5","E11_6","E11_7","E11_8","E11_9",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E11_1","E11_2","E11_3","E11_4",
                     "E11_5","E11_6","E11_7","E11_8","E11_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E11_1,E11_2,E11_3,E11_4,
                                         E11_5,E11_6,E11_7,E11_8,E11_9),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("In full-time employment",
                            "In part-time employment",
                            "Working in more than one part-time job",
                            "Seeking a job",
                            "Undergoing training",
                            "Looking after home or family",
                            "Disabled or partially disabled",
                            "Retired",
                            "In another non-employed situation")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5500,550000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E11_1",input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E11_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E11_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Labour market situation once you arrived to Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%     hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E12 What was your occupational status once you arrived in Switzerland in  ##### 
  
  output$E12_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E2","weight","year")]
      colnames(x)<-c("E12", "pop","year")
      x<-x %>%
        filter(E12!=-7)%>%
        filter(E12!=-9)%>%
        filter(E12!=-8)%>%
        group_by(year,E12) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E12))
      
      x$E12<-as.factor(x$E12)
      x$E12<-fct_explicit_na(x$E12)
      
      x
    })
    
    levels(mar[["D16"]]$E12)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    levels(mar[["D18"]]$E12)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    levels(mar[["D20"]]$E12)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E12<-as.factor(marDF$E12)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E12", "pop")]}else{
        marDF[,c("year","E12", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5000,500000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E12), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What was your occupational status once you arrived in Switzerland?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  
  #### E13 Once you arrived in Switzerland in [A6], how long did you spend looking for a job before finding one? ####
  output$E13_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E13","pop","year")
    x<-x %>%
      group_by(year,E13) %>% 
      filter(E13!=-7)%>%
      filter(E13!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E13<-as.factor(x$E13)
    x$E13<-fct_explicit_na(x$E13)
    x
    #})
    
    levels(x$E13)<-c("Agriculture, forestry and fishing",
                     "Manufacturing, mining and quarrying and other industry ",
                     "Construction",
                     "Wholesale and retail trade, transportation, hotels and restaurants",
                     "Information and communication",
                     "Financial and insurance activities",
                     "Real estate activities",
                     "Professional, scientific, technical, administration and support service activities",
                     "Public administration, defense, education, human health and social action",
                     "Other activities and services")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw",  800,80000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E13), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "Once you arrived in Switzerland, what sector of business, or industry was your company or institution active in for the most part?",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  
  #### E14 In total, how many years have you been in paid work in your whole life? ####
  
  output$E14_16 <-renderHighchart({ 
    
    #nco <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    
    x[is.na(x)] <- -7
    x<-x%>%
      filter(E14!=-7)%>%
      filter(E14!=0)
    
    x$B5CAT<- with(x, ifelse(E14<5,"Less than five year",
                             ifelse((E14>=5 & E14<10),"Between 5 and 9 years",
                                    ifelse((E14>=10 & E14<20),"Between 10 and 19 years",
                                           ifelse((E14>=20 & E14<30),"Between 19 and 29 years",
                                                  ifelse(E14 >=30,"30 or more years",0))))))
    
    
    x$B5CAT<-factor(x$B5CAT, levels=c("Less than five year","Between 5 and 9 years",
                                      "Between 10 and 19 years","Between 19 and 29 years",
                                      "30 or more years"))
    
    colnames(x)<-c("B5", "pop", "year","B5CAT")
    
    x<-x %>%
      group_by(year,B5CAT) %>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(B5CAT))
    x
    #})
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2500,200000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$B5CAT), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "Number of years in paid work",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### E15 Before moving to Switzerland in [A6], did you ever work abroad (Abroad means in another country than Switzerland)? ####
  
  output$E15_16 <-renderHighchart({ 
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E15",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E15","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E15),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    
    levels(marDF$groupz)<-c("Yes")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2250, 200000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E15",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E15","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E15),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you still have the same job and position as when you arrived in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%     
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  
  #### E16 WHAT WAS YOUR LABOUR MARKET SITUATION ##### 
  
  output$E16_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E16_1","E16_2","E16_3","E16_4",
              "E16_5","E16_6","E16_7","E16_8","E16_9",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E16_1","E16_2","E16_3","E16_4",
                     "E16_5","E16_6","E16_7","E16_8",
                     "E16_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E16_1,E16_2,E16_3,E16_4,
                                         E16_5,E16_6,E16_7,E16_8,E16_9),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("In full-time employment",
                            "In part-time employment",
                            "Working in more than one part-time job",
                            "Seeking a job",
                            "Undergoing training",
                            "Looking after home or family",
                            "Disabled or partially disabled",
                            "Retired",
                            "In another non-employed situation")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5500,550000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("E16_1",input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E16_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E16_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What is your current labor market situation?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  #### E36 Once you arrived in Switzerland in [A6], how long did you spend looking for a job before finding one? ####
  
  output$E36_18 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E36","pop","year")
    x<-x %>%
      group_by(year,E36) %>% 
      filter(E36!=-7)%>%
      filter(E36!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E36<-as.factor(x$E36)
    x$E36<-fct_explicit_na(x$E36)
    x
    #})
    
    levels(x$E36)<-c(
      "Less than three months",
      "3 months to 1 year",
      "More than 1 year")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 300,25000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E36), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "Time looking for a job in Switzerland",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%  
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  
  #### E37 Among the following statements, which best describes your situation regarding your job search in Switzerland? ####
  
  
  output$E37_18 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E37","pop","year")
    x<-x %>%
      group_by(year,E37) %>% 
      filter(E37!=-7)%>%
      filter(E37!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E37<-as.factor(x$E37)
    x$E37<-fct_explicit_na(x$E37)
    x
    #})
    
    levels(x$E37)<-c(
      "I recently received a job contract or a job offer",
      "I will quickly find a job in Switzerland",
      "I will probably find a job in Switzerland but it will take some time",
      "It will be difficult for me to find a job in Switzerland",
      "I will probably not find a job in Switzerland",
      "I am so discouraged that I do not look for a job anymore")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 400,25000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E37), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "Job search in Switzerland",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%  
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  #### E17 In what year did you start your current job? #####
  output$E17_16 <-renderHighchart({ 
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    
    colnames(x)<-c("E17","pop","year")
    x[is.na(x)] <- -7
    x<-x %>%
      group_by(year,E17) %>% 
      filter(E17!=-7)%>%
      filter(E17!=-9)%>%
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(E17))
    
    x$E17<-as.factor(x$E17)
    x$E17<-fct_explicit_na(x$E17)
    x
    #})
    
    levels(x$E17)<-c(2016:2006,"Before 2006")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 750,60000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    
    rank <- highchart() %>%
      hc_chart(type = 'column',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$E17), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "Year starting current job",align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%  
      hc_colors(c(gg_color_hue(3)[1]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank
    
  }) 
  
  
  
  #### E18 What is your current occupational status? ##### 
  
  output$E18_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E2","weight","year")]
      colnames(x)<-c("E18", "pop","year")
      x<-x %>%
        filter(E18!=-7)%>%
        filter(E18!=-9)%>%
        filter(E18!=-8)%>%
        group_by(year,E18) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E18))
      
      x$E18<-as.factor(x$E18)
      x$E18<-fct_explicit_na(x$E18)
      
      x
    })
    
    levels(mar[["D16"]]$E18)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    levels(mar[["D18"]]$E18)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    levels(mar[["D20"]]$E18)<-c("Self-employed",
                                "A company owner",
                                "A relative employed in a family business",
                                "Employed as director or board member and/or with managerial",
                                "Employed without managerial responsibility",
                                "Employed in a protected workshop (except support staff)",
                                "An apprentice",
                                "A PhD student")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E18<-as.factor(marDF$E18)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E18", "pop")]}else{
        marDF[,c("year","E18", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 5000,500000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E18), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "What is your current occupational status?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  
  #### E19 OWhat sector of business, or industry is your company or institution active in for the most part? ? ####
  output$E19_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    x[is.na(x)] <- -7
    colnames(x)<-c("E19","pop","year")
    x<-x %>%
      group_by(year,E19) %>% 
      filter(E19!=-7)%>%
      filter(E19!=-9)%>%
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round((pop/sum(pop))*100,1))
    
    x$E19<-as.factor(x$E19)
    x$E19<-fct_explicit_na(x$E19)
    x
    #})
    
    levels(x$E19)<-c("Agriculture, forestry and fishing",
                     "Manufacturing, mining and quarrying and other industry ",
                     "Construction",
                     "Wholesale and retail trade, transportation, hotels and restaurants",
                     "Information and communication",
                     "Financial and insurance activities",
                     "Real estate activities",
                     "Professional, scientific, technical, administration and support service activities",
                     "Public administration, defense, education, human health and social action",
                     "Other activities and services")
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magE=="n_nw",  800,60000)
    
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$E19), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "What sector of business, or industry is your company or institution active in for the most part?",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      
      #hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  
  
  
  #### E21 PDo you have a work contract of.... ##### 
  output$E21_16 <-renderHighchart({ 
    # dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E33","weight","year")]
      colnames(x)<-c("E21", "pop","year")
      x<-x %>%
        filter(E21!=-7)%>%
        filter(E21!=-9)%>%
        filter(E21!=-8)%>%
        group_by(year,E21) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E21))
      
      x$E21<-as.factor(x$E21)
      x$E21<-fct_explicit_na(x$E21)
      
      x
    })
    
    
    levels(mar[["D16"]]$E21)<-c("unlimited duration",
                                "limited duration",
                                " You don't have a contract")
    
    levels(mar[["D18"]]$E21)<-c("unlimited duration",
                                "limited duration",
                                " You don't have a contract")
    
    levels(mar[["D20"]]$E21)<-c("unlimited duration",
                                "limited duration",
                                " You don't have a contract")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E21<-as.factor(marDF$E21)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E21", "pop")]}else{
        marDF[,c("year","E21", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw",  4500,500000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E21), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you have a work contract of....",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })  
  
  
  #### E22 In which locality is the company that you work for?#####
  
  output$E22_16 <-renderHighchart({ 
    
    #mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c(input$BE,input$magE,"year")]
    
    colnames(x)<-c("E22", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(E22) %>% 
      filter(E22!=-9)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((E22))
    
    x$E22<-as.factor(x$E22)
    x$E22<-fct_explicit_na(x$E22)
    
    x
    # })
    
    levels(x$E22)<-c("In the same commune as your residence",
                     "In the same canton but not the same commune as your residence",
                     "In a different canton to your residence",
                     "Abroad")
    
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2500,200000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$E22), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "Locality of the company that you work for",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank
  })
  
  #### E38 Do you think that your current level of education (that is [D1]) is appropriate for your current job?##### 
  output$E38_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      #x<-x[,c("E33","weight","year")]
      colnames(x)<-c("E38", "pop","year")
      x<-x %>%
        filter(E38!=-7)%>%
        filter(E38!=-9)%>%
        filter(E38!=-8)%>%
        group_by(year,E38) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((E38))
      
      x$E38<-as.factor(x$E38)
      x$E38<-fct_explicit_na(x$E38)
      
      x
    })
    
    
    
    
    levels(mar[["D18"]]$E38)<-c("Yes, fully appropriate",
                                "Yes, rather appropriate",
                                "No, not really appropriate",
                                "No, absolutely not appropriate")
    
    levels(mar[["D20"]]$E38)<-c("Yes, fully appropriate",
                                "Yes, rather appropriate",
                                "No, not really appropriate",
                                "No, absolutely not appropriate")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E38<-as.factor(marDF$E38)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E38", "pop")]}else{
        marDF[,c("year","E38", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw",  4000,400000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E38), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you think that your current level of education is appropriate for your current job?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  #### E23 LEVEL OF EDUCATION FOR JOB #####
  
  output$E23_16 <-renderHighchart({ 
    dmms1618<-  dmms[1:2]
    mar <- lapply(dmms1618, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      
      colnames(x)<-c("E23", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, E23) %>% 
        filter(E23!=-9)%>% 
        filter(E23!=-7)%>%
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(E23))
      
      x$E23<-as.factor(x$E23)
      x$E23<-fct_explicit_na(x$E23)
      
      x
    })
    
    levels(mar[["D16"]]$E23)<-c("No formal educational qualification",
                                "Compulsory education",
                                "Higher secondary education not giving access to universities",
                                "Vocational education and/or training",
                                "High school-leaving certificate giving access to universities",
                                "Advanced technical and professional training",
                                "Bachelor or equivalent",
                                "Master or equivalent",
                                "Phd Doctoral or equivalent")
    
    levels(mar[["D18"]]$E23)<-c("No formal educational qualification",
                                "Compulsory education",
                                "Higher secondary education not giving access to universities",
                                "Vocational education and/or training",
                                "High school-leaving certificate giving access to universities",
                                "Advanced technical and professional training",
                                "Bachelor or equivalent",
                                "Master or equivalent",
                                "Phd Doctoral or equivalent")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E23<-as.factor(marDF$E23)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E23", "pop")]}else{
        marDF[,c("year","E23", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2000,150000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$E23), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What type of education do you feel is most appropriate for your current job?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #  paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1:2)]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank
    
  })
  
  
  
  
  #### E24 What are the reasons for you currently occupying a job that does not correspond to your educational level? ##### 
  
  output$E24_1_16 <-renderHighchart({ 
    dmms16<-  dmms[1]
    mar <- lapply(dmms16, function(x){
      
      x<-x[,c("E24_1","E24_2","E24_3","E24_4",
              "E24_5","E24_6","E24_7","E24_8","E24_9",
              "E24_10","E24_11","E24_12","E24_13",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E24_1","E24_2","E24_3","E24_4",
                     "E24_5","E24_6","E24_7","E24_8","E24_9",
                     "E24_10","E24_11","E24_12","E24_13","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E24_1,E24_2,E24_3,E24_4,
                                         E24_5,E24_6,E24_7,E24_8,E24_9,
                                         E24_10,E24_11,E24_12,E24_13),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Inadequate knowledge of one of the national languages",
                            "Qualifications obtained abroad are not recognized in Switzerland",
                            "A change of career",
                            "Lack of jobs with corresponding qualifications",
                            "Future salary improvements and promotional opportunities",
                            "To be able to study at the same time",
                            "To avoid unemployment",
                            "Origin, religion or social background",
                            "Family obligations",
                            "Health reasons",
                            "No interest in changing jobs",
                            "Other obstacle",
                            "No particular obstacles")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 750,50000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms16, function(x){
      
      x<-x[,c("E24_1",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E24_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E24_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        # filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) 
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What are the reasons for you currently occupying a job that does not correspond to your educational level?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        # paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #  paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  #### e25 FROM 0 TO 7 #####
  
  #input<-data.frame(mag1="weight",mag3="Relative")
  
  output$E25_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("E25",
              input$magE,"year")]#input$mag1,
      
      colnames(x)<-c("E25","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E25),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Knowledge and overall skills utilized in your current work")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 3000,300000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magE2=="Relative"){
      marDF[,c(1,2,3,5)]
    } else {
      marDF[,c(1,2,3,4)]}
    
    colnames(marDF1)<-c("groupz","year","value", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Knowledge and overall skills utilized in your current work",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  #### E26 What are the reasons for you currently occupying a job that does not correspond to your educational level? ##### 
  
  output$E26_1_16 <-renderHighchart({ 
    dmms16<-  dmms[1]
    mar <- lapply(dmms16, function(x){
      
      x<-x[,c("E26_1","E26_2","E26_3","E26_4",
              "E26_5","E26_6","E26_7","E26_8","E26_9",
              "E26_10","E26_11","E26_12","E26_13",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E26_1","E26_2","E26_3","E26_4",
                     "E26_5","E26_6","E26_7","E26_8","E26_9",
                     "E26_10","E26_11","E26_12","E26_13","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E26_1,E26_2,E26_3,E26_4,
                                         E26_5,E26_6,E26_7,E26_8,
                                         E26_6,
                                         E26_10,E26_11,E26_12,E26_13),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Inadequate knowledge of one of the national languages",
                            "Qualifications obtained abroad are not recognized in Switzerland",
                            "A change of career",
                            "Lack of jobs with corresponding qualifications",
                            "Future salary improvements and promotional opportunities",
                            "To be able to study at the same time",
                            "To avoid unemployment",
                            "Origin, religion or social background",
                            "Family obligations",
                            "Health reasons",
                            "No interest in changing jobs",
                            "Other obstacle",
                            "No particular obstacles")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 750,50000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms16, function(x){
      
      x<-x[,c("E26_1",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E26_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E26_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #      filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) #
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What are the reasons for you currently occupying a job that does not utilize your knowledge and overall skills?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        # paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  
  #### e39 FROM 0 TO 7 #####
  #input<-data.frame(mag1="weight",mag3="Relative")
  
  output$E39_16 <-renderHighchart({ 
    #aver<-dmms[[1]]
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("E39",
              input$magE,"year")]#input$mag1,
      
      colnames(x)<-c("E39","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E39),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -8
      
      x1<-xlong %>%
        group_by(year,groupz,value) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,0))
      
      #x1$prop<-round(x1$pop/unique(x1$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Level of satisfaction with your current occupation")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magE2=="Relative"){
      marDF[,c(1,2,3,5)]
    } else {
      marDF[,c(1,2,3,4)]}
    
    colnames(marDF1)<-c("groupz","year","value", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      # hc_add_series(name= "Wave 2016",data = marDF[marDF$year==2016,4])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,4])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,4])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Level of satisfaction with your current occupation",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  
  #### E27 when comparing your situation today with your situation before moving to Switzerland in ...? It has ...####
  
  output$E27_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BE,input$magE,"year")]
      
      colnames(x)<-c("E27", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, E27) %>% 
        filter(E27!=-9)%>% 
        filter(E27!=-7)%>%
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(E27))
      
      x$E27<-as.factor(x$E27)
      x$E27<-fct_explicit_na(x$E27)
      
      x
    })
    
    levels(mar[["D16"]]$E27)<-c("Improved substantially",
                                "Improved slightly",
                                "Remained the same",
                                "Worsened slightly",
                                "Worsened substantially")
    
    levels(mar[["D18"]]$E27)<-c("Improved substantially",
                                "Improved slightly",
                                "Remained the same",
                                "Worsened slightly",
                                "Worsened substantially")
    
    levels(mar[["D20"]]$E27)<-c("Improved substantially",
                                "Improved slightly",
                                "Remained the same",
                                "Worsened slightly",
                                "Worsened substantially")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$E27<-as.factor(marDF$E27)
    
    data<- if(input$magE2=="Absolute"){ 
      marDF[,c("year","E27", "pop")]}else{
        marDF[,c("year","E27", "prop")]}
    
    hc_yAxis<-ifelse(input$magE=="n_nw",3500,350000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = rev(levels(data$E27)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Improvement in professional situation",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
  })
  
  #### E40 Have you had business activities in the past 12 months with people or institutions in countries other than Switzerland?####
  
  output$E40_16 <-renderText({ 
    
    x<-"Question not included in 2016 and 2020"
  })
  
  output$E40_18 <-renderHighchart({ 
    
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c("E40",input$magE,"year")]
    
    colnames(x)<-c("E40","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,E40) %>% 
      filter(E40!=-7)%>%
      filter(E40!=-9)%>%
      filter(E40!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    # })
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2018:Business activities in countries other than Switzerland", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single})
  
  
  #### e41 COUNTRY OF bussnies ####
  
  output$E41_1_16 <-renderText({ 
    
    x<-"Question not included in 2016"
  })
  
  output$E41_1_18 <-renderHighchart({ 
    
    #hom <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c("E41_1",input$magE,"year")]
    colnames(x)<-c("E41_1","pop","year")
    x<-as.data.frame(x)
    x = data.frame(x, countries[match(x[,"E41_1"],
                                      countries[,"A3"]),c("official_title_en")])
    colnames(x)[length(names(x))]<-paste("E41_1","B",sep="")
    x$E41_1B<-as.factor(x$E41_1B)
    x$E41_1B<-fct_explicit_na(x$E41_1B)
    
    colnames(x)<-c("B1","pop","year","B1B")
    
    x<-x %>%
      group_by(year,B1B) %>% 
      filter(B1B!="(Missing)")%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(pop))%>% 
      head(20)
    x
    # })
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magD=="n_nw", 200,20000)
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(x$B1B), title = list(text = '')) %>%
      hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", 
                    data = data) %>%
      hc_title(text = "2018: Top 20 countries business activities (1st choice)",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,25))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)
    rank
  })
  
  output$E41_2_18 <-renderHighchart({ 
    
    #hom <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c("E41_2",input$magE,"year")]
    colnames(x)<-c("E41_2","pop","year")
    x<-as.data.frame(x)
    x = data.frame(x, countries[match(x[,"E41_2"],
                                      countries[,"A3"]),c("official_title_en")])
    colnames(x)[length(names(x))]<-paste("E41_2","B",sep="")
    x$E41_2B<-as.factor(x$E41_2B)
    x$E41_2B<-fct_explicit_na(x$E41_2B)
    
    colnames(x)<-c("B1","pop","year","B1B")
    
    x<-x %>%
      group_by(year,B1B) %>% 
      filter(B1B!="(Missing)")%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(pop))%>% 
      head(20)
    x
    # })
    
    data<- if(input$magE2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magD=="n_nw", 200,20000)
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(x$B1B), title = list(text = '')) %>%
      hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", 
                    data = data) %>%
      hc_title(text = "2018: Top 20 countries business activities (2nd choice)",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,25))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)
    rank
  })
  
  
  
  #### E42 What kinds of business activities have you had in the past 12 months with people and institutions in countries other than Switzerland? ##### 
  
  output$E42_1_18 <-renderHighchart({ 
    dmms16<-  dmms[2]
    mar <- lapply(dmms16, function(x){
      
      x<-x[,c("E42_1","E42_2","E42_3","E42_4",
              "E42_5","E42_6",
              input$magE,"year")]#input$magC,
      
      colnames(x)<-c("E42_1","E42_2","E42_3","E42_4",
                     "E42_5","E42_6","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(E42_1,E42_2,E42_3,E42_4,
                                         E42_5,E42_6),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("I import goods produced abroad",
                            "I have people located abroad who do jobs for me (paid or unpaid)",
                            "I have financial support from abroad for my business activities",
                            "I sell goods / services abroad (myself and / or via internet)",
                            "I receive information, training, or counseling services from abroad, including via the internet",
                            "Other")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magE=="n_nw", 500,50000)
    
    formatter<- ifelse(input$magE2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magE2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magE2=="Absolute",0,0),
               max=ifelse(input$magE2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What kinds of business activities have you had in the past 12 months with people and institutions in countries other than Switzerland?",align = 'left')  %>%
      hc_subtitle(text =  paste("\n2018 N",a(sum(c(mar[[1]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  
  
  #### f17    Where does your spouse/partner usually live? ######
  output$F17_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]
      #x<-x[,c("E33","weight","year")]
      colnames(x)<-c("F17", "pop","year")
      x<-x %>%
        filter(F17!=-7)%>%
        filter(F17!=-9)%>%
        filter(F17!=-8)%>%
        group_by(year,F17) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F17))
      
      x$F17<-as.factor(x$F17)
      x$F17<-fct_explicit_na(x$F17)
      
      x
    })
    
    
    
    
    levels(mar[["D18"]]$F17)<-c("With me, in the same household",
                                "In Switzerland, in another household",
                                "Abroad")
    
    levels(mar[["D20"]]$F17)<-c("With me, in the same household",
                                "In Switzerland, in another household",
                                "Abroad",
                                "Partly in Switzerland with me, partly abroad")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F17<-as.factor(marDF$F17)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F17", "pop")]}else{
        marDF[,c("year","F17", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw",  6000,600000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$F17), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Where does your spouse/partner live?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  ##### F18 Which is, among the following proposals, the one which fits the best with your current situation? ######
  output$F18_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]
      #x<-x[,c("E33","weight","year")]
      colnames(x)<-c("F18", "pop","year")
      x<-x %>%
        filter(F18!=-7)%>%
        filter(F18!=-9)%>%
        filter(F18!=-8)%>%
        group_by(year,F18) %>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F18))
      
      x$F18<-as.factor(x$F18)
      x$F18<-fct_explicit_na(x$F18)
      
      x
    })
    
    
    
    
    levels(mar[["D18"]]$F18)<-c("I go regularly abroad to meet my partner",
                                "My partner regularly travels to Switzerland to meet me",
                                "We meet each other sometimes in Switzerland, sometimes abroad",
                                "We rarely meet, only seeing each other during holidays",
                                "I did not have the opportunity to meet my partner since my arrival in Switzerland",
                                "Other situation")
    
    levels(mar[["D20"]]$F18)<-c("I go regularly abroad to meet my partner",
                                "My partner regularly travels to Switzerland to meet me",
                                "We meet each other sometimes in Switzerland, sometimes abroad",
                                "We rarely meet, only seeing each other during holidays",
                                "I did not have the opportunity to meet my partner since my arrival in Switzerland",
                                "Other situation")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F18<-as.factor(marDF$F18)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F18", "pop")]}else{
        marDF[,c("year","F18", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 250,25000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(data$F18), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Which is, among the following proposals, the one which fits the best with your current situation?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  #### F19 What are the reasons explaining why your spouse/partner lives abroad ? #####
  output$F19_1_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("F19_1","F19_2","F19_3",
              "F19_4","F19_5","F19_6","F19_7",
              input$magF,"year")]#input$magC,
      
      colnames(x)<-c("F19_1","F19_2","F19_3",
                     "F19_4","F19_5","F19_6","F19_7",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F19_1,F19_2,F19_3,
                                         F19_4,F19_5,F19_6,F19_7),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("For professional or educational reasons",
                            "For family reasons",
                            "He/she (still) has not obtained a residence permit in Switzerland",
                            "He/she wants to stay in his/her country",
                            "He/she does not want to live in Switzerland",
                            "For monetary reasons",
                            "For other reasons")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 250, 25000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magF2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("F19_1",input$magF,"year")]#input$magC,
      
      colnames(x)<-c("F19_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F19_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What are the reasons explaining why your spouse/partner lives abroad?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | ")) %>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2,3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  ##### F1 Including yourself, how many people live in your household? #####
  output$F1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]
      colnames(x)<-c("F1", "pop", "year")
      
      x[is.na(x)] <- -9
      x<-x%>%
        filter(F1!=-9)%>%
        filter(F1!=-7)%>%
        filter(F1!=0)
      
      x$F1CAT<- with(x, ifelse(F1==1,"1 person",
                               ifelse(F1==2,"2 people",
                                      ifelse(F1==3,"3 people",
                                             ifelse(F1==4,"4 people",
                                                    ifelse(F1 >=5,"5 or more people",0))))))
      
      colnames(x)<-c("F1", "pop", "year","F1CAT")
      
      x<-x %>%
        group_by(year,F1CAT) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F1CAT))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F1CAT<-as.factor(marDF$F1CAT)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F1CAT", "pop")]}else{
        marDF[,c("year","F1CAT", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 3000,250000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F1CAT), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Including yourself, how many people live in your household?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #### F2 COUNTRY OF LIVING PARTNER/SPOUSE ####
  
  output$F2_16 <-renderHighchart({ 
    
    #hom <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("F2",input$magF,"year")]
    colnames(x)<-c("F2","pop","year")
    x<-as.data.frame(x)
    x = data.frame(x, countries[match(x[,"F2"],
                                      countries[,"A3"]),c("official_title_en")])
    colnames(x)[length(names(x))]<-paste("F2","B",sep="")
    x$F2B<-as.factor(x$F2B)
    x$F2B<-fct_explicit_na(x$F2B)
    x[is.na(x)] <- -9
    colnames(x)<-c("B1","pop","year","B1B")
    
    x<-x %>%
      group_by(year,B1B) %>% 
      filter(B1B!="(Missing)")%>% 
      filter(B1B!="-9")%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange(desc(pop))%>% 
      head(20)
    x
    # })
    
    data<- if(input$magF2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 5000,350000)
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.character(x$B1B), title = list(text = '')) %>%
      hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", 
                    data = data) %>%
      hc_title(text = "2016: Top 20 countries partner/spouse currently live",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,100))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### F3 Does your SPOUSE/PARTENER live in the same household? #####
  
  output$F3_16 <-renderHighchart({ 
    
    
    # fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("F3",input$magF,"year")]
    
    colnames(x)<-c("F3","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,F3) %>% 
      filter(F3!=-7)%>%
      filter(F3!=-9)%>%
      filter(F3!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    #})
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Spouse/partner living in same household", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  })
  
  output$F3_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  
  #### f4 In which country was your  "partner"] born?######
  
  output$F4_16 <-renderHighchart({ 
    
    nac <- lapply(dmms, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]
      colnames(x)<-c("F4","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"F4"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("F4","B",sep="")
      x$F4B<-as.factor(x$F4B)
      x$F4B<-fct_explicit_na(x$F4B)
      
      colnames(x)<-c("F4","pop","year","F4B")
      
      x<-x %>%
        group_by(year,F4B) %>% 
        filter(F4B!="(Missing)")%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    
    nacdf<- as.data.frame(do.call("rbind", nac))
    
    nacdf<-nacdf[nacdf$year==input$yearF,]
    
    data<- if(input$magF2=="Absolute"){ 
      nacdf[,c("year","F4B","pop")]}else{
        nacdf[,c("year","F4B", "prop")]}
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 700,175000)
    
    color<-ifelse(input$yearF==2016,1,
                  ifelse(input$yearF==2018,2,3))
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(data$F4B), title = list(text = '')) %>%
      #hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(data = data[,3])%>%
      hc_title(text = paste("Top 20 countries of birth:",input$yearF,sep=" "),
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(nac[[
        
        if(input$yearF==2016){ 
          1}else{
            if(input$yearF==2018){   
              2}else{3}}
        
      ]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,35))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[color]))
    rank
  }) 
  
  
  
  
  #### f6 Highest level of education spouse/partne#####
  
  output$F6_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]#input$BF,input$magF,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("F6", "pop","year")
      
      
      x<-x %>%
        group_by(year,F6) %>% 
        filter(F6!="(Missing)")%>%
        filter(F6!=-7)%>%
        filter(F6!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F6))
      
      x$F6<-as.factor(x$F6)
      x$F6<-fct_explicit_na(x$F6)
      
      x
    })
    
    levels(mar[["D16"]]$F6)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    levels(mar[["D18"]]$F6)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    levels(mar[["D20"]]$F6)<-c("No formal educational qualification",
                               "Compulsory education",
                               "Higher secondary education not giving access to universities (or similar)",
                               "Vocational education and/or training",
                               "High school-leaving certificate giving access to universities (or similar)",
                               "Advanced technical and professional training",
                               "Bachelor or equivalent",
                               "Master or equivalent",
                               "Phd Doctoral or equivalent")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F6<-as.factor(marDF$F6)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F6", "pop")]}else{
        marDF[,c("year","F6", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F6), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Highest level of education spouse/partner",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  #### f7 partener current labour situacion ######
  
  output$F7_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("F7_1","F7_2","F7_3","F7_4",
              "F7_5","F7_6","F7_7","F7_8","F7_9",
              input$magF,"year")]#input$magC,
      
      colnames(x)<-c("F7_1","F7_2","F7_3","F7_4",
                     "F7_5","F7_6","F7_7","F7_8","F7_9","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F7_1,F7_2,F7_3,F7_4,
                                         F7_5,F7_6,F7_7,F7_8,F7_9),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x1$prop<-round(x1$pop/unique(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("In full-time employment",
                            "In part-time employment",
                            "Working in more than one part-time job",
                            "Seeking a job",
                            "Undergoing training",
                            "Looking after home or family",
                            "Disabled or partially disabled",
                            "Retired",
                            "In another non-employed situation")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 5500,550000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    data<-if(input$magF2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(data)<-c("groupz","year","prop")
    
    data$year<-paste("Wave ",data$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("F7_1",input$magF,"year")]#input$magC,
      
      colnames(x)<-c("F7_1","pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F7_1),
                         factor_key=FALSE)
      
      
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x1
    })
    
    marDFtotales<- as.data.frame(do.call("rbind", mar1))
    
    rank <-data %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What is your spouse/partner's current labor market situation?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFtotales[marDFtotales$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFtotales[marDFtotales$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFtotales[marDFtotales$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  ###### F8 CHILDREN IN HH ######
  output$F8_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$BF,input$magF,"year")]
      colnames(x)<-c("F8", "pop", "year")
      
      x[is.na(x)] <- -9
      x<-x%>%
        filter(F8!=-9)%>%
        filter(F8!=-7)
      
      x$F8CAT<- with(x, ifelse(F8==0,"0 children",
                               ifelse(F8==1,"1 children",
                                      ifelse(F8==2,"2 children",
                                             ifelse(F8==3,"3 children",
                                                    ifelse(F8==4,"4 children",
                                                           ifelse(F8 >=5,"5 or more children",0)))))))
      
      colnames(x)<-c("F8", "pop", "year","F8CAT")
      
      x<-x %>%
        group_by(year,F8CAT) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F8CAT))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F8CAT<-as.factor(marDF$F8CAT)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F8CAT", "pop")]}else{
        marDF[,c("year","F8CAT", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F8CAT), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How many children do you have?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(mar[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(mar[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(mar[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  
  
  #### F10 WHERE DO YOUR CHILDREN LIVE #####
  
  output$F10_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("F10_1",input$magF,"year")] #input$magF
      
      colnames(x)<-c("F10_1", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, F10_1) %>% 
        filter(F10_1!=-9)%>% 
        filter(F10_1!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F10_1))
      
      x$F10_1<-as.factor(x$F10_1)
      x$F10_1<-fct_explicit_na(x$F10_1)
      
      x
    })
    
    levels(mar[["D16"]]$F10_1)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D18"]]$F10_1)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D20"]]$F10_1)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F10_1<-as.factor(marDF$F10_1)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F10_1", "pop")]}else{
        marDF[,c("year","F10_1", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F10_1), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Where do your children live? Child 1",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank})
  
  output$F10_2_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("F10_2",input$magF,"year")] #input$magF
      
      colnames(x)<-c("F10_2", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, F10_2) %>% 
        filter(F10_2!=-9)%>% 
        filter(F10_2!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F10_2))
      
      x$F10_2<-as.factor(x$F10_2)
      x$F10_2<-fct_explicit_na(x$F10_2)
      
      x
    })
    
    levels(mar[["D16"]]$F10_2)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D18"]]$F10_2)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D20"]]$F10_2)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F10_2<-as.factor(marDF$F10_2)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F10_2", "pop")]}else{
        marDF[,c("year","F10_2", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F10_2), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Where do your children live? Child 2",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank})
  
  output$F10_3_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("F10_3",input$magF,"year")] #input$magF
      
      colnames(x)<-c("F10_3", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, F10_3) %>% 
        filter(F10_3!=-9)%>% 
        filter(F10_3!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((F10_3))
      
      x$F10_3<-as.factor(x$F10_3)
      x$F10_3<-fct_explicit_na(x$F10_3)
      
      x
    })
    
    levels(mar[["D16"]]$F10_3)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D18"]]$F10_3)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    levels(mar[["D20"]]$F10_3)<-c("In your household",
                                  "In Switzerland but not in your household",
                                  "In your country of origin",
                                  "In another country")
    
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$F10_3<-as.factor(marDF$F10_3)
    
    data<- if(input$magF2=="Absolute"){ 
      marDF[,c("year","F10_3", "pop")]}else{
        marDF[,c("year","F10_3", "prop")]}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 3500,350000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$F10_3), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Where do your children live? Child 3",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank})
  
  
  #### f11 childcate  ####
  
  output$F11_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("F11_1","F11_2","F11_3",
              "F11_4","F11_5","F11_6",
              "F11_7","F11_8","F11_9","F11_10",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F11_1","F11_2","F11_3",
                     "F11_4","F11_5","F11_6",
                     "F11_7","F11_8","F11_9","F11_10",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F11_1,F11_2,F11_3,
                                         F11_4,F11_5,F11_6,
                                         F11_7,F11_8,F11_9,F11_10),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Day care center",
                            "Nursery or pre-school",
                            "A self-organized childcare group",
                            "Babysitter/nanny",
                            "Another institutional or paid arrangement",
                            "Your parents/parents-in-law",
                            "Other family members",
                            "Friends",
                            "Other providers",
                            "I/we do not get regular help")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 500, 50000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magF2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("F11_1",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F11_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F11_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you get regular help with childcare?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #     paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #    paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### f12 What type of school  ####
  
  output$F12_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("F12_1","F12_2","F12_3",
              "F12_4","F12_5","F12_6",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F12_1","F12_2","F12_3",
                     "F12_4","F12_5","F12_6",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F12_1,F12_2,F12_3,
                                         F12_4,F12_5,F12_6),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Public (state-run) and local",
                            "Religious",
                            "Non-profit, including free alternative schools",
                            "Private and local",
                            "International school",
                            "Other school type")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 1500, 100000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magF2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("F12_1",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F12_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F12_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "What type of school do they attend?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #   paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #  paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### f13 Which language   ####
  
  output$F13_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("F13_1","F13_2","F13_3",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F13_1","F13_2","F13_3",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F13_1,F13_2,F13_3),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Local language",
                            "English",
                            "Other language")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 1500, 100000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magF2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("F13_1",
              input$magF,"year")]#iinput$magF,
      
      colnames(x)<-c("F13_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(F13_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Language at school",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #   paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  #### F24 When you arrived in Switzerland in [A6], what was your first type of housing? #####
  
  output$F24_18 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BF,input$magF,"year")]
    
    colnames(x)<-c("F24", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(F24) %>% 
      filter(F24!=-9)%>% 
      filter(F24!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((F24))
    
    x$F24<-as.factor(x$F24)
    x$F24<-fct_explicit_na(x$F24)
    
    x
    # })
    
    levels(x$F24)<-c("A residence that I rented",
                     "A residence that I owned",
                     "A residence that I sublet",
                     "A room in a shared apartment",
                     "A room with a host family",
                     "A friend's or relative's house or apartment",
                     "A home for workers or migrants",
                     "A hotel, hostel or B&B",
                     "Another kind of accommodation")
    
    
    data<- if(input$magF2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 4500,450000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$F24), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,60))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "First type of housing",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### F25 DID YOU MOVE SINCE THEN ###### 
  
  output$F25_16 <-renderText({ 
    
    x<-"Question not included in 2016 and 2020"
  })
  
  output$F25_18 <-renderHighchart({ 
    
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c("F25",input$magF,"year")]
    
    colnames(x)<-c("F25","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,F25) %>% 
      filter(F25!=-7)%>%
      filter(F25!=-9)%>%
      filter(F25!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    #})
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2018: Did you move since then?", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  })
  
  #### F26 What kind of housing do you live in now? #####
  
  output$F26_18 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BF,input$magF,"year")]
    
    colnames(x)<-c("F26", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(F26) %>% 
      filter(F26!=-9)%>% 
      filter(F26!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((F26))
    
    x$F26<-as.factor(x$F26)
    x$F26<-fct_explicit_na(x$F26)
    
    x
    # })
    
    levels(x$F26)<-c("A residence that I rented",
                     "A residence that I owned",
                     "A residence that I sublet",
                     "A room in a shared apartment",
                     "A room with a host family",
                     "A friend's or relative's house or apartment",
                     "A home for workers or migrants",
                     "A hotel, hostel or B&B",
                     "Another kind of accommodation")
    
    
    data<- if(input$magF2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 4500,450000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$F26), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,60))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "Current type of housing",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### F27 Before moving to Switzerland in [A6], did you work as a cross-border worker in Switzerland? ####
  
  output$F27_16 <-renderText({ 
    
    x<-"Question not included in 2016 and 2020"
  })
  
  output$F27_18 <-renderHighchart({ 
    
    
    # fst <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c("F27",input$magF,"year")]
    
    colnames(x)<-c("F27","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,F27) %>% 
      filter(F27!=-7)%>%
      filter(F27!=-9)%>%
      filter(F27!=-8)%>%
      summarise(pop=round(sum(pop),0))%>% 
      mutate(prop= round((pop/sum(pop))*100,1))
    
    
    #})
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No, I moved during my stay in Switzerland")))%>%
      
      hc_title(text = "2018: Do you live since your arrival in Switzerland in the same municipality", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  }) 
  
  
  
  #### F28 satisfied with your move to the municipality you currently live in#####
  
  output$F28_18 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BF,input$magF,"year")]
    
    colnames(x)<-c("F28", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(F28) %>% 
      filter(F28!=-9)%>% 
      filter(F28!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((F28))
    
    x$F28<-as.factor(x$F28)
    x$F28<-fct_explicit_na(x$F28)
    
    x
    # })
    
    levels(x$F28)<-c("Yes, totally satisfied",
                     "Yes, rather satisfied",
                     "No, rather unsatisfied",
                     "No, totally unsatisfied")
    
    
    data<- if(input$magF2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 2000,200000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$F28), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "Satisfaction with your move to the municipality you currently live in",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### F29 satisfied with your move to the municipality you currently live in#####
  
  output$F29_18 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D18"]][,c(input$BF,input$magF,"year")]
    
    colnames(x)<-c("F29", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(F29) %>% 
      filter(F29!=-9)%>% 
      filter(F29!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((F29))
    
    x$F29<-as.factor(x$F29)
    x$F29<-fct_explicit_na(x$F29)
    
    x
    # })
    
    levels(x$F29)<-c("Yes, totally satisfied",
                     "Yes, rather satisfied",
                     "No, rather unsatisfied",
                     "No, totally unsatisfied")
    
    
    data<- if(input$magF2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magF=="n_nw", 4000,300000)
    
    formatter<- ifelse(input$magF2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$F29), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2018", data = data) %>%
      hc_title(text = "Satisfaction to have chosen to live in your current municipality",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  
  #### G1 Which language do you relate to and master best? #####
  
  output$G1_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G1_1",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G1_1", "pop","year")
      
      
      x<-x %>%
        group_by(year,G1_1) %>% 
        filter(G1_1!="(Missing)")%>%
        filter(G1_1!=-7)%>%
        filter(G1_1!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G1_1))
      
      x$G1_1<-as.factor(x$G1_1)
      x$G1_1<-fct_explicit_na(x$G1_1)
      
      x
    })
    
    levels(mar[["D16"]]$G1_1)<-c("Swiss-German",
                                 "German",
                                 "French",
                                 "Romansh",
                                 "Italian",
                                 "English",
                                 "Spanish",
                                 "Portuguese",
                                 "Other language")
    
    levels(mar[["D18"]]$G1_1)<-c("Swiss-German",
                                 "German",
                                 "French",
                                 "Romansh",
                                 "Italian",
                                 "English",
                                 "Spanish",
                                 "Portuguese",
                                 "Other language")
    
    levels(mar[["D20"]]$G1_1)<-c("Swiss-German",
                                 "German",
                                 "French",
                                 "Romansh",
                                 "Italian",
                                 "English",
                                 "Spanish",
                                 "Portuguese",
                                 "Other language")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G1_1<-as.factor(marDF$G1_1)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G1_1", "pop")]}else{
        marDF[,c("year","G1_1", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,300000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G1_1), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Language mastered best",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  ##### G2 lANGUAGE MASTERED BEST  ######
  
  output$G2_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G2",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G2", "pop","year")
      
      
      x<-x %>%
        group_by(year,G2) %>% 
        filter(G2!="(Missing)")%>%
        filter(G2!=-7)%>%
        filter(G2!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G2))
      
      x$G2<-as.factor(x$G2)
      x$G2<-fct_explicit_na(x$G2)
      
      x
    })
    
    levels(mar[["D16"]]$G2)<-c("Everything",
                               "Most of a conversation",
                               "Parts of a conversation",
                               "Some words and phrases",
                               "Nothing at all")
    
    levels(mar[["D18"]]$G2)<-c("Everything",
                               "Most of a conversation",
                               "Parts of a conversation",
                               "Some words and phrases",
                               "Nothing at all")
    
    levels(mar[["D20"]]$G2)<-c("Everything",
                               "Most of a conversation",
                               "Parts of a conversation",
                               "Some words and phrases",
                               "Nothing at all")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G2<-as.factor(marDF$G2)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G2", "pop")]}else{
        marDF[,c("year","G2", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,300000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G2), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Language mastered best",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  ##### G3 local language #####
  
  output$G3_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G3",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G3", "pop","year")
      
      
      x<-x %>%
        group_by(year,G3) %>% 
        filter(G3!="(Missing)")%>%
        filter(G3!=-7)%>%
        filter(G3!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G3))
      
      x$G3<-as.factor(x$G3)
      x$G3<-fct_explicit_na(x$G3)
      
      x
    })
    
    levels(mar[["D16"]]$G3)<-c("Speak fluently",
                               "Speak somewhat fluently",
                               "Speak not very well",
                               "Know some vocabulary",
                               "Not speak the language at all")
    
    levels(mar[["D18"]]$G3)<-c("Speak fluently",
                               "Speak somewhat fluently",
                               "Speak not very well",
                               "Know some vocabulary",
                               "Not speak the language at all")
    
    levels(mar[["D20"]]$G3)<-c("Speak fluently",
                               "Speak somewhat fluently",
                               "Speak not very well",
                               "Know some vocabulary",
                               "Not speak the language at all")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G3<-as.factor(marDF$G3)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G3", "pop")]}else{
        marDF[,c("year","G3", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw",  3000,350000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G3), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Do you speak the local language?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  #### G4 Do you have relatives living in Switzerland? ####
  
  output$G4_16 <-renderHighchart({ 
    
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("G4",input$magG,"year")]
    
    colnames(x)<-c("G4","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,G4) %>% 
      filter(G4!=-7)%>%
      filter(G4!=-9)%>%
      filter(G4!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    # })
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Do you have relatives living in Switzerland?", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single})
  
  output$G4_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  #### G5 hOEW ARE YOU RELATED TO THEM  ####
  
  output$G5_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G5_1","G5_2","G5_3",
              "G5_4","G5_5","G5_6",
              "G5_7","G5_8","G5_9",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G5_1","G5_2","G5_3",
                     "G5_4","G5_5","G5_6",
                     "G5_7","G5_8","G5_9",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G5_1,G5_2,G5_3,
                                         G5_4,G5_5,G5_6,
                                         G5_7,G5_8,G5_9),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Parent(s)",
                            "Grandparent(s)",
                            "Brother(s) and/or sister(s)",
                            "Uncle(s) and/or aunt(s)",
                            "Cousin(s)",
                            "In-law(s)",
                            "Niece(s)/Nephew(s)",
                            "Grandchild(ren)",
                            "Other")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 500, 50000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G5_1",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G5_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G5_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How are they related to you?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        # paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### G20 FRIENDS IN CH  ####
  
  output$G20_18 <-renderHighchart({ 
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G20",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G20",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G20),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Yes")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 7000, 700000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G20",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G20",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G20),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Do you have friends or relatives living in Switzerland you can count on for practical or emotional support?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  ##### g6 Where do your very good friends live?  ######
  
  output$G6_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G6",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G6", "pop","year")
      
      
      x<-x %>%
        group_by(year,G6) %>% 
        filter(G6!="(Missing)")%>%
        filter(G6!=-7)%>%
        filter(G6!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G6))
      
      x$G6<-as.factor(x$G6)
      x$G6<-fct_explicit_na(x$G6)
      
      x
    })
    
    levels(mar[["D16"]]$G6)<-c("All your good friends live in Switzerland",
                               "Most of your good friends live in Switzerland",
                               "Approximately the same numbers of friends live in Switzerland and abroad",
                               "Most of your good friends live abroad",
                               "All your good friends live abroad")
    
    levels(mar[["D18"]]$G6)<-c("All your good friends live in Switzerland",
                               "Most of your good friends live in Switzerland",
                               "Approximately the same numbers of friends live in Switzerland and abroad",
                               "Most of your good friends live abroad",
                               "All your good friends live abroad")
    
    levels(mar[["D20"]]$G6)<-c("All your good friends live in Switzerland",
                               "Most of your good friends live in Switzerland",
                               "Approximately the same numbers of friends live in Switzerland and abroad",
                               "Most of your good friends live abroad",
                               "All your good friends live abroad")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G6<-as.factor(marDF$G6)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G6", "pop")]}else{
        marDF[,c("year","G6", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,350000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G6), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Where do your very good friends live?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  ###### g21  among the follkowing statementes #####
  
  output$G21_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G21",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G21", "pop","year")
      
      
      x<-x %>%
        group_by(year,G21) %>% 
        filter(G21!="(Missing)")%>%
        filter(G21!=-7)%>%
        filter(G21!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G21))
      
      x$G21<-as.factor(x$G21)
      x$G21<-fct_explicit_na(x$G21)
      
      x
    })
    
    
    levels(mar[["D18"]]$G21)<-c("Most of my friends are from my country of origin",
                                "Most of my friends are foreigners, but not necessarily from my country of origin",
                                "Most of my friends are Swiss",
                                "My friends come from many different countries (including Switzerland, my country of origin, other countries)")
    
    levels(mar[["D20"]]$G21)<-c("Most of my friends are from my country of origin",
                                "Most of my friends are foreigners, but not necessarily from my country of origin",
                                "Most of my friends are Swiss",
                                "My friends come from many different countries (including Switzerland, my country of origin, other countries)")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G21<-as.factor(marDF$G21)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G21", "pop")]}else{
        marDF[,c("year","G21", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,350000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G21), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Among the following statements, which best describes your situation concerning your friends here in Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  ###### g22  aHow often do you have contacts with friends or family in your country of origin by telephone, email, skype, whatsapp or other forms of online communications?#####
  
  output$G22_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G22",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G22", "pop","year")
      
      
      x<-x %>%
        group_by(year,G22) %>% 
        filter(G22!="(Missing)")%>%
        filter(G22!=-7)%>%
        filter(G22!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G22))
      
      x$G22<-as.factor(x$G22)
      x$G22<-fct_explicit_na(x$G22)
      
      x
    })
    
    
    levels(mar[["D18"]]$G22)<-c("Every day",
                                "Many times a week",
                                "Approximately once time a week",
                                "A few times per month",
                                "Approximately once time a month",
                                "A few times per year",
                                "Once per year",
                                "Never")
    
    levels(mar[["D20"]]$G22)<-c("Every day",
                                "Many times a week",
                                "Approximately once time a week",
                                "A few times per month",
                                "Approximately once time a month",
                                "A few times per year",
                                "Once per year",
                                "Never")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G22<-as.factor(marDF$G22)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G22", "pop")]}else{
        marDF[,c("year","G22", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,350000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G22), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #   paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How often do you have contacts with friends or family in your country of origin by telephone, email, skype, whatsapp or other forms of online communications?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  #### g7 have you visited your ghome countru ###### 
  
  output$G7_16 <-renderHighchart({ 
    fst <- lapply(dmms, function(x){
      
      x<-x[,c(input$BG,input$magG,"year")]#input$BQ,input$mag1
      
      x[is.na(x)] <- -7
      
      colnames(x)<-c("G7","pop","year")
      x<-x %>%
        group_by(year,G7) %>% 
        filter(G7!=-7)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    fstDF<- as.data.frame(do.call("rbind", fst))
    fstDF<-fstDF[fstDF$G7==1,]
    fstDF$G7<-as.factor(fstDF$G7)
    levels(fstDF$G7)<-"Yes"
    
    
    data<- if(input$magG2=="Absolute"){ 
      fstDF[,c("year","G7", "pop")]}else{
        fstDF[,c("year","G7", "prop")]}
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 7000,700000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = factor(data$G7), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Have you visited your country of origin?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(fst[[2]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(fst[[3]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  ###### g8  How often have you visited your home country of origin?#####
  
  output$G8_16 <-renderHighchart({ 
    
    #dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G8",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G8", "pop","year")
      
      
      x<-x %>%
        group_by(year,G8) %>% 
        filter(G8!="(Missing)")%>%
        filter(G8!=-7)%>%
        filter(G8!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G8))
      
      x$G8<-as.factor(x$G8)
      x$G8<-fct_explicit_na(x$G8)
      
      x
    })
    
    levels(mar[["D16"]]$G8)<-c("Once or twice a year",
                               "Three to six times a year",
                               "Once a month",
                               "Twice or more a month")
    
    
    levels(mar[["D18"]]$G8)<-c("Once or twice a year",
                               "Three to six times a year",
                               "Once a month",
                               "Twice or more a month")
    
    levels(mar[["D20"]]$G8)<-c("Once or twice a year",
                               "Three to six times a year",
                               "Once a month",
                               "Twice or more a month")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G8<-as.factor(marDF$G8)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G8", "pop")]}else{
        marDF[,c("year","G8", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw",4000,400000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G8), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How often have you visited your home country of origin?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #### g23 Is there a place (family house, apartment) in your country of origin that you own or rent and where you can go when you stay there? ###### 
  
  output$G23_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    fst <- lapply(dmms1820, function(x){
      
      x<-x[,c("G23",input$magG,"year")]#input$BQ,input$mag1
      
      x[is.na(x)] <- -7
      
      colnames(x)<-c("G23","pop","year")
      x<-x %>%
        group_by(year,G23) %>% 
        filter(G23!=-7)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    fstDF<- as.data.frame(do.call("rbind", fst))
    fstDF<-fstDF[fstDF$G23==1,]
    fstDF$G23<-as.factor(fstDF$G23)
    levels(fstDF$G23)<-"Yes"
    
    
    data<- if(input$magG2=="Absolute"){ 
      fstDF[,c("year","G23", "pop")]}else{
        fstDF[,c("year","G23", "prop")]}
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 7000,700000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = factor(data$G23), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Is there a place (family house, apartment) in your country of origin that you own or rent and where you can go when you stay there?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(fst[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  }) 
  
  #### G9 When you visit your home country of origin [B1], do you mainly stay.#####
  
  
  output$G9_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("G9",input$magG,"year")]
    
    colnames(x)<-c("G9", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(G9) %>% 
      filter(G9!=-9)%>% 
      filter(G9!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((G9))
    
    x$G9<-as.factor(x$G9)
    x$G9<-fct_explicit_na(x$G9)
    
    x
    # })
    
    levels(x$G9)<-c("With friends",
                    "In your own apartment",
                    "With family or relatives",
                    "In a hotel or vacation rental")
    
    
    data<- if(input$magG2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 4500,450000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$G9), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: When you visit your country of origin, do you mainly stay",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  
  
  #### G10 How at home do you feel on your visits to your home country of origin [B1]? #####
  
  output$G10_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("G10",input$magG,"year")]
    
    colnames(x)<-c("G10", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(G10) %>% 
      filter(G10!=-9)%>% 
      filter(G10!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((G10))
    
    x$G10<-as.factor(x$G10)
    x$G10<-fct_explicit_na(x$G10)
    
    x
    # })
    
    levels(x$G10)<-c("I feel right at home from the first day on",
                     "I feel at home after getting acclimatized",
                     "Even after a longer period, I still feel like a tourist or visitor")
    
    
    data<- if(input$magG2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 4000,300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$G10), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,70))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: How do you feel at home on your visits to your home country of origin",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### g11 Ihave you ever been visited by family of friends from your home country of origin [B1]? ###### 
  
  output$G11_16 <-renderHighchart({ 
    
    #dmms1820 <-  dmms[2:3]
    fst <- lapply(dmms, function(x){
      
      x<-x[,c("G11",input$magG,"year")]#input$BQ,input$mag1
      
      x[is.na(x)] <- -7
      
      colnames(x)<-c("G11","pop","year")
      x<-x %>%
        group_by(year,G11) %>% 
        filter(G11!=-7)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))
      x
    })
    
    fstDF<- as.data.frame(do.call("rbind", fst))
    fstDF<-fstDF[fstDF$G11==1,]
    fstDF$G11<-as.factor(fstDF$G11)
    levels(fstDF$G11)<-"Yes"
    
    
    data<- if(input$magG2=="Absolute"){ 
      fstDF[,c("year","G11", "pop")]}else{
        fstDF[,c("year","G11", "prop")]}
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 7000,700000)
    
    rank <- highchart() %>%
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = factor(data$G11), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Have you ever been visited by family of friends from your home country of origin?",
               align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2018 N",a(sum(c(fst[[1]]$pop))),sep=": "),
        paste("\n2020 N",a(sum(c(fst[[2]]$pop))),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })   
  
  #### G12 Do you have a place of residence abroad outside of Switzerland where you live for three or more months per year? ####
  
  output$G12_16 <-renderHighchart({ 
    
    
    #fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("G12",input$magG,"year")]
    
    colnames(x)<-c("G12","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,G12) %>% 
      filter(G12!=-7)%>%
      filter(G12!=-9)%>%
      filter(G12!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    # })
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Place of residence abroad outside of Switzerland", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single})
  
  output$G12_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })  
  
  #### G13  FROM 0 TO 7 #####
  
  output$G13_1_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G13_1",input$magG,"year")]
      colnames(x)<-c("G13_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G13_1) %>% 
        filter(G13_1!=-7)%>%
        filter(G13_1!=-9)%>%
        filter(G13_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G13_1, nesting(year))
    marDF$G13_1<-as.factor(marDF$G13_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G13_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G13_1),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2500,250000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Are you interested in news and current events in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G13_2_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G13_2",input$magG,"year")]
      colnames(x)<-c("G13_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G13_2) %>% 
        filter(G13_2!=-7)%>%
        filter(G13_2!=-9)%>%
        filter(G13_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G13_2, nesting(year))
    marDF$G13_2<-as.factor(marDF$G13_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G13_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G13_2),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2500,250000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Are you interested in news and current events in your country?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  #### G14 Have you engaged in voluntary work for one of the following associations or charity organizations during the last 12 months in .? ####
  
  output$G14_1_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G14_1_1","G14_1_2","G14_1_3",
              "G14_1_4","G14_1_5","G14_1_6",
              "G14_1_7","G14_1_8",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G14_1_1","G14_1_2","G14_1_3",
                     "G14_1_4","G14_1_5","G14_1_6",
                     "G14_1_7","G14_1_8",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G14_1_1,G14_1_2,G14_1_3,
                                         G14_1_4,G14_1_5,G14_1_6,
                                         G14_1_7,G14_1_8),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Sports or recreational organizatio",
                            "Cultural association linked to your home country of origin",
                            "Social and charitable institutions or non-profit activity",
                            "Religious organization/community or spiritual group",
                            "Political party, political or public office, interest group, trade unions",
                            "Cultural groups: voluntary work in an orchestra, choir, theatre, film or exhibition association",
                            "Other organizations or associations",
                            "You have not engaged in any voluntary work")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3500, 300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G14_1_1",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G14_1_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G14_1_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Have you engaged in voluntary work for one of the following associations or charity organizations during the last 12 months in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #   paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #  paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### G14b Have you engaged in voluntary work for one of the following associations or charity organizations during the last 12 months in .? ####
  
  output$G14_2_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G14_2_1","G14_2_2","G14_2_3",
              "G14_2_4","G14_2_5","G14_2_6",
              "G14_2_7","G14_2_8",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G14_2_1","G14_2_2","G14_2_3",
                     "G14_2_4","G14_2_5","G14_2_6",
                     "G14_2_7","G14_2_8",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G14_2_1,G14_2_2,G14_2_3,
                                         G14_2_4,G14_2_5,G14_2_6,
                                         G14_2_7,G14_2_8),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Sports or recreational organizatio",
                            "Cultural association linked to your home country of origin",
                            "Social and charitable institutions or non-profit activity",
                            "Religious organization/community or spiritual group",
                            "Political party, political or public office, interest group, trade unions",
                            "Cultural groups: voluntary work in an orchestra, choir, theatre, film or exhibition association",
                            "Other organizations or associations",
                            "You have not engaged in any voluntary work")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 4000, 350000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G14_2_1",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G14_2_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G14_2_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Have you engaged in voluntary work for one of the following associations or charity organizations during the last 12 months in your country?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        # paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  
  
  #### G15 If there was a general election tomorrow in Switzerland [if A3 NE CH (8100) add "and you had the right to vote"] would you vote?#####
  
  output$G15_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("G15",input$magG,"year")]
    
    colnames(x)<-c("G15", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(G15) %>% 
      filter(G15!=-9)%>% 
      filter(G15!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((G15))
    
    x$G15<-as.factor(x$G15)
    x$G15<-fct_explicit_na(x$G15)
    
    x
    # })
    
    levels(x$G15)<-c("No, I would not vote",
                     "Yes, I would vote",
                     "I do not know")
    
    
    data<- if(input$magG2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 5000,400000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$G15), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: Would you vote",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### G6 How interested would you say you are in politics in ... #####
  
  output$G16_1_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G16_1",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G16_1", "pop","year")
      
      
      x<-x %>%
        group_by(year,G16_1) %>% 
        filter(G16_1!="(Missing)")%>%
        filter(G16_1!=-7)%>%
        filter(G16_1!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G16_1))
      
      x$G16_1<-as.factor(x$G16_1)
      x$G16_1<-fct_explicit_na(x$G16_1)
      
      x
    })
    
    levels(mar[["D16"]]$G16_1)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    levels(mar[["D18"]]$G16_1)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    levels(mar[["D20"]]$G16_1)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G16_1<-as.factor(marDF$G16_1)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G16_1", "pop")]}else{
        marDF[,c("year","G16_1", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,300000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G16_1), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How interested would you say you are in politics in Switzerland",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  output$G16_2_16 <-renderHighchart({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("G16_2",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G16_2", "pop","year")
      
      
      x<-x %>%
        group_by(year,G16_2) %>% 
        filter(G16_2!="(Missing)")%>%
        filter(G16_2!=-7)%>%
        filter(G16_2!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G16_2))
      
      x$G16_2<-as.factor(x$G16_2)
      x$G16_2<-fct_explicit_na(x$G16_2)
      
      x
    })
    
    levels(mar[["D16"]]$G16_2)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    levels(mar[["D18"]]$G16_2)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    levels(mar[["D20"]]$G16_2)<-c("Very interested",
                                  "Quite interested",
                                  "Hardly interested",
                                  "Not at all interested")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G16_2<-as.factor(marDF$G16_2)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G16_2", "pop")]}else{
        marDF[,c("year","G16_2", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 3000,300000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G16_2), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How interested would you say you are in politics in your country",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  }) 
  
  
  #### G17 There are different ways of trying to improve things or help prevent things from going wrong  ####
  
  #input<-data.frame(magG="weight",magG2="Relative")
  output$G17_1_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G17_1_1","G17_1_2","G17_1_3",
              "G17_1_4","G17_1_5","G17_1_6",
              "G17_1_7","G17_1_8","G17_1_9",
              "G17_1_10","G17_1_11",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G17_1_1","G17_1_2","G17_1_3",
                     "G17_1_4","G17_1_5","G17_1_6",
                     "G17_1_7","G17_1_8","G17_1_9",
                     "G17_1_10","G17_1_11",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G17_1_1,G17_1_2,G17_1_3,
                                         G17_1_4,G17_1_5,G17_1_6,
                                         G17_1_7,G17_1_8,G17_1_9,
                                         G17_1_10,G17_1_11),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("G17_1_1","G17_1_2","G17_1_3",
                                                "G17_1_4","G17_1_5","G17_1_6",
                                                "G17_1_7","G17_1_8","G17_1_9",
                                                "G17_1_10","G17_1_11"))
    
    levels(marDF$groupz)<-c("Contacted a politician, government or local government official",
                            "Made a donation to a political campaign or to a political party",
                            "Worked in a political party or action group",
                            "Worked in another organization or association",
                            "Worn or displayed a campaign badge/sticker",
                            "Signed a petition",
                            "Taken part in a lawful public demonstration",
                            "Boycotted certain products",
                            "Used the Internet in order to communicate about some activity",
                            "Other",
                            "You did not do anything")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 5000, 350000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G17_1_1",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G17_1_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G17_1_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "During the last 12 months, have you done any of the following? (In Switzerland)",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        # paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### G17b There are different ways of trying to improve things or help prevent things from going wrong  ####
  
  output$G17_2_1_16 <-renderHighchart({ 
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G17_2_1","G17_2_2","G17_2_3",
              "G17_2_4","G17_2_5","G17_2_6",
              "G17_2_7","G17_2_8","G17_2_9",
              "G17_2_10","G17_2_11",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G17_2_1","G17_2_2","G17_2_3",
                     "G17_2_4","G17_2_5","G17_2_6",
                     "G17_2_7","G17_2_8","G17_2_9",
                     "G17_2_10","G17_2_11",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G17_2_1,G17_2_2,G17_2_3,
                                         G17_2_4,G17_2_5,G17_2_6,
                                         G17_2_7,G17_2_8,G17_2_9,
                                         G17_2_10,G17_2_11),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    marDF$groupz<-factor(marDF$groupz, levels=c("G17_2_1","G17_2_2","G17_2_3",
                                                "G17_2_4","G17_2_5","G17_2_6",
                                                "G17_2_7","G17_2_8","G17_2_9",
                                                "G17_2_10","G17_2_11"))
    
    levels(marDF$groupz)<-c("Contacted a politician, government or local government official",
                            "Made a donation to a political campaign or to a political party",
                            "Worked in a political party or action group",
                            "Worked in another organization or association",
                            "Worn or displayed a campaign badge/sticker",
                            "Signed a petition",
                            "Taken part in a lawful public demonstration",
                            "Boycotted certain products",
                            "Used the Internet in order to communicate about some activity",
                            "Other",
                            "You did not do anything")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw", 5000, 350000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("G17_2_1",
              input$magG,"year")]#iinput$magG,
      
      colnames(x)<-c("G17_2_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(G17_2_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "During the last 12 months, have you done any of the following? (In your country)",align = 'left')  %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        # paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### G18  FROM 0 TO 10 #####
  
  output$G18_1_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms[1], function(x){
      
      x<-x[,c("G18_1",input$magG,"year")]
      colnames(x)<-c("G18_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G18_1) %>% 
        filter(G18_1!=-7)%>%
        filter(G18_1!=-9)%>%
        filter(G18_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G18_1, nesting(year))
    marDF$G18_1<-as.factor(marDF$G18_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G18_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G18_1),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2000,100000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How confident are you in your own ability to participate in politics in your home country? (In Switzerland)",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        # paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G18_2_16 <-renderHighchart({ 
    
    #input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms[1], function(x){
      
      x<-x[,c("G18_2",input$magG,"year")]
      colnames(x)<-c("G18_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G18_2) %>% 
        filter(G18_2!=-7)%>%
        filter(G18_2!=-9)%>%
        filter(G18_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G18_2, nesting(year))
    marDF$G18_2<-as.factor(marDF$G18_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G18_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G18_2),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2000,100000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #    hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #   hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How confident are you in your own ability to participate in politics in your home country? (In your country)",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #    paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #   paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  #### G19  FROM 0 TO 10 #####
  
  output$G19_1_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms[1], function(x){
      
      x<-x[,c("G19_1",input$magG,"year")]
      colnames(x)<-c("G19_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G19_1) %>% 
        filter(G19_1!=-7)%>%
        filter(G19_1!=-9)%>%
        filter(G19_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G19_1, nesting(year))
    marDF$G19_1<-as.factor(marDF$G19_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G19_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G19_1),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2000,100000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How easy do you personally find it to take part in politics ...?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        # paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G19_2_16 <-renderHighchart({ 
    
    #input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms[1], function(x){
      
      x<-x[,c("G19_2",input$magG,"year")]
      colnames(x)<-c("G19_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G19_2) %>% 
        filter(G19_2!=-7)%>%
        filter(G19_2!=-9)%>%
        filter(G19_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G19_2, nesting(year))
    marDF$G19_2<-as.factor(marDF$G19_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G19_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G19_2),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",2000,100000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #    hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #   hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,25))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "How easy do you personally find it to take part in politics ...?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #    paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #   paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  
  #### G26  FROM 0 TO 7 #####
  
  output$G26_1_18 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    dmms1820<-dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G26_1",input$magG,"year")]
      colnames(x)<-c("G26_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G26_1) %>% 
        filter(G26_1!=-7)%>%
        filter(G26_1!=-9)%>%
        filter(G26_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G26_1, nesting(year))
    marDF$G26_1<-as.factor(marDF$G26_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G26_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G26_1),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",3000,300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Feeling homesick",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G26_2_18 <-renderHighchart({ 
    
    #input<-data.frame(magG="weight",magG2="Relative")
    dmms1820<-dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G26_2",input$magG,"year")]
      colnames(x)<-c("G26_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G26_2) %>% 
        filter(G26_2!=-7)%>%
        filter(G26_2!=-9)%>%
        filter(G26_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G26_2, nesting(year))
    marDF$G26_2<-as.factor(marDF$G26_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G26_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G26_2),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",3000,300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Communicating with the local population",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G26_3_18 <-renderHighchart({ 
    
    #input<-data.frame(magG="weight",magG2="Relative")
    dmms1820<-dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G26_3",input$magG,"year")]
      colnames(x)<-c("G26_3","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G26_3) %>% 
        filter(G26_3!=-7)%>%
        filter(G26_3!=-9)%>%
        filter(G26_3!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G26_3, nesting(year))
    marDF$G26_3<-as.factor(marDF$G26_3)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G26_3)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G26_3),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",3000,300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Adapting oneself to the Swiss way of life",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$G26_4_18 <-renderHighchart({ 
    
    #input<-data.frame(magG="weight",magG2="Relative")
    dmms1820<-dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G26_4",input$magG,"year")]
      colnames(x)<-c("G26_4","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,G26_4) %>% 
        filter(G26_4!=-7)%>%
        filter(G26_4!=-9)%>%
        filter(G26_4!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(G26_4, nesting(year))
    marDF$G26_4<-as.factor(marDF$G26_4)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$G26_4)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(G26_4),])
    
    hc_yAxis<-ifelse(input$magG=="n_nw",3000,300000)
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magG2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Finding friends in Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  
  #####G27  among the follkowing statementes #####
  
  output$G27_1_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G27_1",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G27_1", "pop","year")
      
      
      x<-x %>%
        group_by(year,G27_1) %>% 
        filter(G27_1!="(Missing)")%>%
        filter(G27_1!=-7)%>%
        filter(G27_1!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G27_1))
      
      x$G27_1<-as.factor(x$G27_1)
      x$G27_1<-fct_explicit_na(x$G27_1)
      
      x
    })
    
    
    levels(mar[["D18"]]$G27_1)<-c("Disagree totall",
                                  "Disagree partially",
                                  "Agree partially",
                                  "Agree totally")
    
    levels(mar[["D20"]]$G27_1)<-c("Disagree totall",
                                  "Disagree partially",
                                  "Agree partially",
                                  "Agree totally")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G27_1<-as.factor(marDF$G27_1)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G27_1", "pop")]}else{
        marDF[,c("year","G27_1", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw",  4500,450000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G27_1), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Globally, I feel myself belonging to the Swiss society",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  output$G27_2_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G27_2",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G27_2", "pop","year")
      
      
      x<-x %>%
        group_by(year,G27_2) %>% 
        filter(G27_2!="(Missing)")%>%
        filter(G27_2!=-7)%>%
        filter(G27_2!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G27_2))
      
      x$G27_2<-as.factor(x$G27_2)
      x$G27_2<-fct_explicit_na(x$G27_2)
      
      x
    })
    
    
    levels(mar[["D18"]]$G27_2)<-c("Disagree totall",
                                  "Disagree partially",
                                  "Agree partially",
                                  "Agree totally")
    
    levels(mar[["D20"]]$G27_2)<-c("Disagree totall",
                                  "Disagree partially",
                                  "Agree partially",
                                  "Agree totally")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G27_2<-as.factor(marDF$G27_2)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G27_2", "pop")]}else{
        marDF[,c("year","G27_2", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw",  4500,450000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G27_2), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Globally, I feel myself totally accepted by the society in Switzerland",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####G29  how is your health #####
  
  output$G28_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("G28",input$magG,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("G28", "pop","year")
      
      
      x<-x %>%
        group_by(year,G28) %>% 
        filter(G28!="(Missing)")%>%
        filter(G28!=-7)%>%
        filter(G28!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((G28))
      
      x$G28<-as.factor(x$G28)
      x$G28<-fct_explicit_na(x$G28)
      
      x
    })
    
    
    levels(mar[["D18"]]$G28)<-c("Very Good",
                                "Good",
                                "Fair",
                                "Bad",
                                "Very bad")
    
    levels(mar[["D20"]]$G28)<-c("Very Good",
                                "Good",
                                "Fair",
                                "Bad",
                                "Very bad",
                                "Do not know")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$G28<-as.factor(marDF$G28)
    
    data<- if(input$magG2=="Absolute"){ 
      marDF[,c("year","G28", "pop")]}else{
        marDF[,c("year","G28", "prop")]}
    
    hc_yAxis<-ifelse(input$magG=="n_nw",  4500,450000)
    
    
    formatter<- ifelse(input$magG2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$G28), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How is your health in general?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  
  
  
  
  
  #### H1 Is your stay in Switzerland limited in time?#####
  
  output$H1_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("H1",input$magH,"year")]
    
    colnames(x)<-c("H1", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(H1) %>% 
      filter(H1!=-9)%>% 
      filter(H1!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop= round((pop/sum(pop))*100,1))%>%
      arrange((H1))
    
    x$H1<-as.factor(x$H1)
    x$H1<-fct_explicit_na(x$H1)
    
    x
    # })
    
    levels(x$H1)<-c("Yes",
                    "No",
                    "I do not know yet")
    
    
    data<- if(input$magH2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$H1), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: Stay limited in time",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  #### H2 How many more years would like to stay in Switzerland? ####
  
  output$H2_16 <-renderHighchart({
    
    x<-dmms[["D16"]][,c("H2",input$magH,"year")]
    
    colnames(x)<-c("H2","pop","year")
    x[is.na(x)] <- -7
    
    x<-x %>%
      filter(H2!=-7)
    
    x$H2CAT<- with(x, ifelse(H2==0,"Less than one",
                             ifelse(H2>=1 & H2 <=3,"1-3 years",
                                    ifelse(H2>=4 & H2 <=5,"4-5 years",
                                           ifelse(H2>=6 & H2 <=10,"6-10 years",
                                                  ifelse(H2 >10,"More than 10 years",0))))))
    
    x$H2CAT<-as.factor(x$H2CAT)
    x$H2CAT<-factor(x$H2CAT, levels=c("Less than one",
                                      "1-3 years",
                                      "4-5 years",
                                      "6-10 years",
                                      "More than 10 years"))
    x<-x %>%
      group_by(year,H2CAT) %>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((H2CAT))
    x
    
    data<- if(input$magH2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 200,20000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$H2CAT), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,40))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: How many more years would like to stay in Switzerland",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    
    rank})
  
  
  
  
  
  
  #####H3  How often have you considered emigrating from Switzerland in the last three months? #####
  
  output$H3_16 <-renderHighchart({ 
    
    dmms1820 <-  dmms[1:2]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H3",input$magH,"year")]#input$BF,input$magH,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("H3", "pop","year")
      
      
      x<-x %>%
        group_by(year,H3) %>% 
        filter(H3!="(Missing)")%>%
        filter(H3!=-7)%>%
        filter(H3!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H3))
      
      x$H3<-as.factor(x$H3)
      x$H3<-fct_explicit_na(x$H3)
      
      x
    })
    
    
    levels(mar[["D16"]]$H3)<-c("Very often",
                               "Often",
                               "From time to time",
                               "Never")
    
    levels(mar[["D18"]]$H3)<-c("Very often",
                               "Often",
                               "From time to time",
                               "Never")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$H3<-as.factor(marDF$H3)
    
    data<- if(input$magH2=="Absolute"){ 
      marDF[,c("year","H3", "pop")]}else{
        marDF[,c("year","H3", "prop")]}
    
    hc_yAxis<-ifelse(input$magH=="n_nw",  6000,600000)
    
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$H3), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      #hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How often have you considered emigrating from Switzerland in the last three months?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1:2)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #### H4  Do you plan to emigrate from Switzerland within the next 12 months?#### 
  
  output$H4_16 <-renderHighchart({ 
    
    
    # fst <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("H4",input$magH,"year")]
    
    colnames(x)<-c("H4","pop","year")
    
    x[is.na(x)] <- -7
    
    x<-x %>%
      group_by(year,H4) %>% 
      filter(H4!=-7)%>%
      filter(H4!=-9)%>%
      filter(H4!=-8)%>%
      summarise(pop=round(sum(pop),0))
    
    
    #})
    
    pie_single<- highchart() %>%
      hc_chart(type = 'pie') %>%
      hc_legend(enabled = TRUE) %>%
      hc_plotOptions(column = list(stacking = "normal"),
                     series = list(dataLabels = list(enabled = TRUE, 
                                                     format = '<b>{point.name}</b>: {point.percentage:.1f} %'))) %>%
      hc_add_series(data = list(
        list(y =  round(x[1,3][[1]],2), name = "Yes"),
        list(y =  round(x[2,3][[1]],2), name = "No")))%>%
      
      hc_title(text = "2016: Plan to emigrate from Switzerland", align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x[1,3][[1]],
                                              x[2,3][[1]]))), 
                                sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      #
      hc_tooltip(pointFormat = "N: {point.y}", enabled = TRUE) 
    pie_single
  })
  
  output$H4_18 <-renderText({ 
    
    x<-"Question not included in 2018 and 2020"
  })
  
  #### H5 COUNTRY FOR EMIGRATION ####
  
  output$H5_16 <-renderHighchart({ 
    #input<-data.frame(magH="weight",magH2="Relative")
    hom <- lapply(dmms[1], function(x){
      
      x<-x[,c("H5",input$magH,"year")]
      colnames(x)<-c("H5","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"H5"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("H5","B",sep="")
      x$H5B<-as.factor(x$H5B)
      x$H5B<-fct_explicit_na(x$H5B)
      
      colnames(x)<-c("B1","pop","year","B1B")
      
      x[is.na(x)] <- -9
      x<-x %>%
        filter(B1!=-9)%>%
        filter(B1!=-7)%>%
        filter(B1B!="(Missing)")%>%
        group_by(year,B1B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    data<- if(input$magH2=="Absolute"){ 
      c(hom[["D16"]]$pop)}else{
        c(hom[["D16"]]$prop)}
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 400,40000)
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(hom[["D16"]]$B1B), title = list(text = '')) %>%
      hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", 
                    data = data) %>%
      hc_title(text = "2016: Top 20 countries",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(hom[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,25))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)
    rank
  })
  
  output$H5_18 <-renderHighchart({ 
    
    hom <- lapply(dmms[2], function(x){
      
      x<-x[,c("H5",input$magH,"year")]
      colnames(x)<-c("H5","pop","year")
      x<-as.data.frame(x)
      x = data.frame(x, countries[match(x[,"H5"],
                                        countries[,"A3"]),c("official_title_en")])
      colnames(x)[length(names(x))]<-paste("H5","B",sep="")
      x$H5B<-as.factor(x$H5B)
      x$H5B<-fct_explicit_na(x$H5B)
      
      colnames(x)<-c("B1","pop","year","B1B")
      
      x[is.na(x)] <- -9
      x<-x %>%
        filter(B1!=-9)%>%
        filter(B1!=-7)%>%
        filter(B1B!="(Missing)")%>%
        group_by(year,B1B) %>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange(desc(pop))%>% 
        head(20)
      x
    })
    
    data<- if(input$magH2=="Absolute"){ 
      c(hom[["D18"]]$pop)}else{
        c(hom[["D18"]]$prop)}
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 400,40000)
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = FALSE) %>%
      hc_xAxis(categories = as.character(hom[["D18"]]$B1B), title = list(text = '')) %>%
      hc_yAxis(title = list(text = 'N')) %>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Value", 
                    data = data) %>%
      hc_title(text = "2018: Top 20 countries",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(hom[["D18"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,25))%>%
      hc_exporting(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_tooltip(enabled = TRUE)
    rank
  })
  
  #### H6  FROM 0 TO 10 #####
  
  output$H6_1_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H6_1",input$magH,"year")]
      colnames(x)<-c("H6_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_1) %>% 
        filter(H6_1!=-7)%>%
        filter(H6_1!=-9)%>%
        filter(H6_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_1, nesting(year))
    marDF$H6_1<-as.factor(marDF$H6_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_1),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With life in general",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_2_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H6_2",input$magH,"year")]
      colnames(x)<-c("H6_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_2) %>% 
        filter(H6_2!=-7)%>%
        filter(H6_2!=-9)%>%
        filter(H6_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_2, nesting(year))
    marDF$H6_2<-as.factor(marDF$H6_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_2),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With your job in general",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(1:2)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_3_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    dmms1820 <-  dmms[1]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H6_3",input$magH,"year")]
      colnames(x)<-c("H6_3","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_3) %>% 
        filter(H6_3!=-7)%>%
        filter(H6_3!=-9)%>%
        filter(H6_3!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_3, nesting(year))
    marDF$H6_3<-as.factor(marDF$H6_3)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_3)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_3),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      #hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With the studies you are currently engaged in",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(1:2)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_4_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H6_4",input$magH,"year")]
      colnames(x)<-c("H6_4","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_4) %>% 
        filter(H6_4!=-7)%>%
        filter(H6_4!=-9)%>%
        filter(H6_4!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_4, nesting(year))
    marDF$H6_4<-as.factor(marDF$H6_4)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_4)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_4),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With your personal, social and family relationships",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_5_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H6_5",input$magH,"year")]
      colnames(x)<-c("H6_5","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_5) %>% 
        filter(H6_5!=-7)%>%
        filter(H6_5!=-9)%>%
        filter(H6_5!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_5, nesting(year))
    marDF$H6_5<-as.factor(marDF$H6_5)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_5)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_5),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With your decision to move to Switzerland",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_6_18 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H6_6",input$magH,"year")]
      colnames(x)<-c("H6_6","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_6) %>% 
        filter(H6_6!=-7)%>%
        filter(H6_6!=-9)%>%
        filter(H6_6!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_6, nesting(year))
    marDF$H6_6<-as.factor(marDF$H6_6)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_6)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_6),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With your housing conditions",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H6_7_18 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H6_7",input$magH,"year")]
      colnames(x)<-c("H6_7","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H6_7) %>% 
        filter(H6_7!=-7)%>%
        filter(H6_7!=-9)%>%
        filter(H6_7!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H6_7, nesting(year))
    marDF$H6_7<-as.factor(marDF$H6_7)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H6_7)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H6_7),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,35))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "With the quality of life in your neighborhood",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  
  #### H7 Discrimination means that a person is treated less favorably than other people because of different characteristics. Have you experienced situations of prejudice or discrimination in Switzerland in the last 24 months?#####
  
  output$H7_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("H7",input$magH,"year")]
    
    colnames(x)<-c("H7", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(H7) %>% 
      filter(H7!=-9)%>% 
      filter(H7!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((H7))
    
    x$H7<-as.factor(x$H7)
    x$H7<-fct_explicit_na(x$H7)
    
    x
    # })
    
    levels(x$H7)<-c("Yes",
                    "No")
    
    
    data<- if(input$magH2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$H7), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "2016: Experienced situations of prejudice or discrimination",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(1)]))%>% 
      hc_tooltip(enabled = TRUE)
    
    rank})
  
  output$H7_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      x<-x[,c("H7",input$magH,"year")]
      
      colnames(x)<-c("H7", "pop","year")
      x[is.na(x)] <- -9
      
      x<-x %>%
        group_by(year, H7) %>% 
        filter(H7!=-9)%>% 
        filter(H7!=-7)%>% 
        #replace_with_na(replace = list(A6 = -9))%>% 
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H7))
      
      x$H7<-as.factor(x$H7)
      x$H7<-fct_explicit_na(x$H7)
      levels(x$H7)<-c("Never",
                      "Rarely",
                      "Sometimes",
                      "Frequently")
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H7, nesting(year))
    marDF$H7<-as.factor(marDF$H7)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H7)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H7),])
    
    
    
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Experienced situations of prejudice or discrimination",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank 
    
  })
  
  #### H8 In your opinion, on the basis of what actual or assigned characteristic(s) has this discrimination taken place? Because of. ##### 
  
  output$H8_1_16 <-renderHighchart({ 
    # dmms1820 <-  dmms[1]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H8_1","H8_2","H8_3",
              "H8_4","H8_5","H8_6",
              "H8_7","H8_8",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H8_1","H8_2","H8_3",
                     "H8_4","H8_5","H8_6",
                     "H8_7","H8_8",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H8_1,H8_2,H8_3,
                                         H8_4,H8_5,H8_6,
                                         H8_7,H8_8),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Racist reasons",
                            "Your immigrant background, origin, nationality",
                            "Your religion",
                            "Your gendre",
                            "Your disability, impairment or chronic disease",
                            "Your age",
                            "Your sexual orientation",
                            "Other")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2000, 200000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms, function(x){
      
      x<-x[,c("H8_1",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H8_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H8_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "In your opinion, on the basis of what actual or assigned characteristic(s) has this discrimination taken place?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  ##### H9Where did you experience this discrimination? Was it #####
  
  output$H9_1_16 <-renderHighchart({ 
    
    #input<-data.frame(magH="weight",magH2="Relative")
    # dmms1820 <-  dmms[1]
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H9_1","H9_2","H9_3",
              "H9_4","H9_6",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H9_1","H9_2","H9_3",
                     "H9_4","H9_6",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H9_1,H9_2,H9_3,
                                         H9_4,H9_6),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("During education and work",
                            "In shops, in public and/or during leisure activities",
                            "In healthcare and care",
                            "By public authorities",
                            # "On the Internet",
                            "In another situation or by other persons")
    marDF[is.na(marDF)] <- 0
    
    
    mar1 <- lapply(dmms[1], function(x){
      
      x<-x[,c("H9_5",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H9_5",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H9_5),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1)) #CATS 1,2,4,5,6
    
    marDF1$groupz<-as.factor(marDF1$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF1$groupz)<-c("On the Internet")
    marDF1[is.na(marDF1)] <- 0
    
    
    mar1820 <- lapply(dmms[2:3], function(x){
      
      x<-x[,c("H9_7","H9_8",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H9_7","H9_8",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H9_7,H9_8),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF1820<- as.data.frame(do.call("rbind", mar1820)) #CATS 1,2,4,5,6
    
    marDF1820$groupz<-as.factor(marDF1820$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF1820$groupz)<-c("During the search for a job",
                                "When applying for an apartment")
    marDF1820[is.na(marDF1820)] <- 0
    
    
    
    marfinal<-rbind(marDF,marDF1,marDF1820)
    
    #marfinal<-marfinal %>% complete(marfinal, nesting(year))
    
    marfinal<-with(marfinal, marfinal[order(groupz),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 2000, 200000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marfinal<-if(input$magH2=="Relative"){
      marfinal[,c(1,2,4)]
    } else {
      marfinal[,c(1,2,3)]}
    
    colnames(marfinal)<-c("year","groupz","prop")
    
    marfinal$year<-paste("Wave ",marfinal$year, sep="")
    
    mar2 <- lapply(dmms, function(x){
      
      x<-x[,c("H9_1",
              input$magH,"year")]#iinput$magH,
      
      colnames(x)<-c("H9_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H9_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDFs<- as.data.frame(do.call("rbind", mar2))
    
    rank <-marfinal %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Where did you experience this discrimination?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDFs[marDFs$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDFs[marDFs$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDFs[marDFs$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
  })
  
  #### H12 To deal with the discrimination of foreigners in the labour market, some people slightly modify their curriculum vitae to hide their origin. Did you use one of the following strategies when writing your curriculum vitae in order to increase the possibility of success, when looking for a job in Switzerland?#### 
  
  output$H12_1_18 <-renderHighchart({  
    # input<-data.frame(magH="weight",magH2="Relative")
    dmms1820 <-  dmms[2]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H12_1","H12_2","H12_3",
              "H12_4","H12_5","H12_6",
              "H12_7",
              input$magH,"year")]#iinput$magG,
      
      colnames(x)<-c("H12_1","H12_2","H12_3",
                     "H12_4","H12_5","H12_6",
                     "H12_7",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H12_1,H12_2,H12_3,
                                         H12_4,H12_5,H12_6,
                                         H12_7),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      
      
      x2<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        summarise(pop=round(sum(pop),0))
      
      x2
      
      x1$prop<-round(x1$pop/(x2$pop)*100,1)
      
      x1
    })
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(groupz, nesting(year))
    marDF$groupz<-as.factor(marDF$groupz)
    #levels( marDF$groupz)
    #marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                           "B27_4","B27_5","B27_6"))
    
    levels(marDF$groupz)<-c("Removing information or photos referring to your place of origin",
                            "Modifying your name or surname in order to hide your origin",
                            "Adding some diploma equivalences or professional experiences in Switzerland",
                            "Mentioning social or volunteer activities specifically in Switzerland",
                            "Mentioning pastimes or hobbies related to Switzerland",
                            "Providing an address (of a friend of relative) in Switzerland, even if you were living abroad",
                            "None of those strategies")
    marDF[is.na(marDF)] <- 0
    
    marDF<-with(marDF, marDF[order(groupz),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 7000, 725000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF)<-c("groupz","year","prop")
    
    marDF$year<-paste("Wave ",marDF$year, sep="")
    
    mar1 <- lapply(dmms1820, function(x){
      
      x<-x[,c("H12_1",
              input$magH,"year")]#iinput$magG,
      
      colnames(x)<-c("H12_1",
                     "pop","year")
      
      xlong<-x %>%gather(groupz, value,c(H12_1),
                         factor_key=FALSE)
      
      xlong[is.na(xlong)] <- -7
      x1<-xlong %>%
        group_by(year,groupz) %>% 
        filter(value!=-7)%>%
        filter(value!=-9)%>%
        filter(value!=-8)%>%
        #  filter(value!=2)%>%
        summarise(pop=round(sum(pop),0))
      
      x1
    })
    marDF1<- as.data.frame(do.call("rbind", mar1))
    
    rank <-marDF %>% 
      hchart('bar', hcaes(x = 'groupz', y = 'prop', group = 'year')) %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "Did you use one of the following strategies when writing your curriculum vitae in order to increase the possibility of success, when looking for a job in Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        #paste("\n2016 N",a(sum(marDF1[marDF1$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF1[marDF1$year==2018,"pop"])),sep=": "),
        #paste("\n2020 N",a(sum(marDF1[marDF1$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)[2]))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank  
    
    
  })
  
  #### H10 Considering all of your income and your expenses over a year, would you say you currently.#####
  
  output$H10_16 <-renderHighchart({ 
    
    #  mar <- lapply(dmms, function(x){
    
    x<-dmms[["D16"]][,c("H10",input$magH,"year")]
    
    colnames(x)<-c("H10", "pop","year")
    x[is.na(x)] <- -9
    
    x<-x %>%
      group_by(H10) %>% 
      filter(H10!=-9)%>% 
      filter(H10!=-7)%>% 
      #replace_with_na(replace = list(A6 = -9))%>% 
      summarise(pop=round(sum(pop),0))%>%
      mutate(prop=round(pop/sum(pop)*100,1))%>%
      arrange((H10))
    
    x$H10<-as.factor(x$H10)
    x$H10<-fct_explicit_na(x$H10)
    
    x
    # })
    
    levels(x$H10)<-c("Put money aside",
                     "Spend what you earn",
                     "Consume your savings or your heritage, your reservations",
                     "Go into debt")
    
    
    data<- if(input$magH2=="Absolute"){ 
      c(x$pop)}else{
        c(x$prop)}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled = TRUE) %>%
      hc_xAxis(categories = as.factor(x$H10), title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magG2=="Absolute",0,0),
               max=ifelse(input$magG2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_add_series(name = "Wave 2016", data = data) %>%
      hc_title(text = "Considering all of your income and your expenses over a year, would you say you currently.",
               align = 'left')  %>%
      hc_subtitle(text =  paste("\nN",a(sum(c(x$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")%>%
      hc_exporting(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[1]))%>%  
      hc_tooltip(enabled = TRUE)
    
    rank})
  
  
  #### H11  FROM 0 TO 7 #####
  
  output$H11_1_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H11_1",input$magH,"year")]
      colnames(x)<-c("H11_1","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H11_1) %>% 
        filter(H11_1!=-7)%>%
        filter(H11_1!=-9)%>%
        filter(H11_1!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H11_1, nesting(year))
    marDF$H11_1<-as.factor(marDF$H11_1)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H11_1)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H11_1),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw",2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "To what extent do you have a feeling of attachment to Switzerland?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  output$H11_2_16 <-renderHighchart({ 
    
    # input<-data.frame(magG="weight",magG2="Relative")
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c("H11_2",input$magH,"year")]
      colnames(x)<-c("H11_2","pop","year")
      x[is.na(x)] <- -9
      
      
      x<-x %>%
        group_by(year,H11_2) %>% 
        filter(H11_2!=-7)%>%
        filter(H11_2!=-9)%>%
        filter(H11_2!=-8)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round((pop/sum(pop))*100,1))
      x
    })
    
    marDF<- as.data.frame(do.call("rbind", mar)) #CATS 1,2,4,5,6
    
    marDF<-marDF %>% complete(H11_2, nesting(year))
    marDF$H11_2<-as.factor(marDF$H11_2)
    #levels( marDF$groupz)
    #   marDF$groupz<-factor(marDF$groupz, levels=c("B27_1","B27_2","B27_3",
    #                                              "B27_4","B27_5","B27_6"))
    
    #levels(marDF$H11_2)<-c("in Switzerland")
    marDF[is.na(marDF)] <- 0
    
    
    marDF<-with(marDF, marDF[order(H11_2),])
    
    hc_yAxis<-ifelse(input$magH=="n_nw",2500,250000)
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    # marDF<-as.data.frame(marDF)
    #marDF<-ifelse(input$mag3=="Relative","prop","pop")
    marDF1<-if(input$magH2=="Relative"){
      marDF[,c(1,2,4)]
    } else {
      marDF[,c(1,2,3)]}
    
    colnames(marDF1)<-c("value","year", "prop")
    
    marDF1<-as.data.frame(marDF1)
    
    rank <- highchart() %>% 
      
      hc_xAxis(categories = levels(as.factor(marDF1$value)), title = list(text = '')) %>%
      hc_add_series(name= "Wave 2016",data = marDF1[marDF1$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = marDF1[marDF1$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = marDF1[marDF1$year==2020,3])%>%
      hc_chart(type = 'column',zoomType= 'xy')%>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(title = list(text = '')) %>%
      hc_xAxis(title = list(text = '')) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magF2=="Absolute",0,0),
               max=ifelse(input$magF2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      #hc_add_series(name = "Value", data = data) %>%
      hc_title(text = "To what extent do you have a feeling of attachment to your home country of origin?",align = 'left')  %>%
      hc_subtitle(text =paste(
        paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE) %>%
      hc_colors(c(gg_color_hue(3)))%>%  
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank   
  })
  
  #####H13  How often have you positive contacts with Swiss people? #####
  
  output$H13_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H13",input$magH,"year")]#input$BF,input$magH,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("H13", "pop","year")
      
      
      x<-x %>%
        group_by(year,H13) %>% 
        filter(H13!="(Missing)")%>%
        filter(H13!=-7)%>%
        filter(H13!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H13))
      
      x$H13<-as.factor(x$H13)
      x$H13<-fct_explicit_na(x$H13)
      
      x
    })
    
    
    levels(mar[["D18"]]$H13)<-c("Never",
                                "From time to time",
                                "Often",
                                "Very often")
    
    levels(mar[["D20"]]$H13)<-c("Never",
                                "From time to time",
                                "Often",
                                "Very often")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$H13<-as.factor(marDF$H13)
    
    data<- if(input$magH2=="Absolute"){ 
      marDF[,c("year","H13", "pop")]}else{
        marDF[,c("year","H13", "prop")]}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$H13), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How often have you positive contacts with Swiss people?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####H14  How often have you positive contacts with Swiss people? #####
  
  output$H14_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H14",input$magH,"year")]#input$BF,input$magH,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("H14", "pop","year")
      
      
      x<-x %>%
        group_by(year,H14) %>% 
        filter(H14!="(Missing)")%>%
        filter(H14!=-7)%>%
        filter(H14!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H14))
      
      x$H14<-as.factor(x$H14)
      x$H14<-fct_explicit_na(x$H14)
      
      x
    })
    
    
    levels(mar[["D18"]]$H14)<-c("Never",
                                "From time to time",
                                "Often",
                                "Very often")
    
    levels(mar[["D20"]]$H14)<-c("Never",
                                "From time to time",
                                "Often",
                                "Very often")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$H14<-as.factor(marDF$H14)
    
    data<- if(input$magH2=="Absolute"){ 
      marDF[,c("year","H14", "pop")]}else{
        marDF[,c("year","H14", "prop")]}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$H14), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "How often have you negative contacts with Swiss people?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  ##### H15 When arriving in Switzerland, did you have any plans regarding the duration of your stay?#####
  
  output$H15_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H15",input$magH,"year")]#input$BF,input$magH,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("H15", "pop","year")
      
      
      x<-x %>%
        group_by(year,H15) %>% 
        filter(H15!="(Missing)")%>%
        filter(H15!=-7)%>%
        filter(H15!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H15))
      
      x$H15<-as.factor(x$H15)
      x$H15<-fct_explicit_na(x$H15)
      
      x
    })
    
    
    levels(mar[["D18"]]$H15)<-c("Yes, I wanted to stay in Switzerland for a limited duration (less than 1 year)",
                                "Yes, I wanted to stay one or more years in Switzerland, but ultimately leave the country",
                                "Yes, I wanted to stay all my life in Switzerland",
                                "No, I did not have a well defined plan")
    
    levels(mar[["D20"]]$H15)<-c("Yes, I wanted to stay in Switzerland for a limited duration (less than 1 year)",
                                "Yes, I wanted to stay one or more years in Switzerland, but ultimately leave the country",
                                "Yes, I wanted to stay all my life in Switzerland",
                                "No, I did not have a well defined plan")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$H15<-as.factor(marDF$H15)
    
    data<- if(input$magH2=="Absolute"){ 
      marDF[,c("year","H15", "pop")]}else{
        marDF[,c("year","H15", "prop")]}
    
    hc_yAxis<-ifelse(input$magH=="n_nw", 5000,400000)
    
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$H15), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "When arriving in Switzerland, did you have any plans regarding the duration of your stay?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #### H16 And now, what are your plans regarding the duration of your stay in Switzerland?#####
  
  output$H16_18 <-renderHighchart({ 
    
    dmms1820 <-  dmms[2:3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c("H16",input$magH,"year")]#input$BF,input$magH,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("H16", "pop","year")
      
      
      x<-x %>%
        group_by(year,H16) %>% 
        filter(H16!="(Missing)")%>%
        filter(H16!=-7)%>%
        filter(H16!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((H16))
      
      x$H16<-as.factor(x$H16)
      x$H16<-fct_explicit_na(x$H16)
      
      x
    })
    
    
    levels(mar[["D18"]]$H16)<-c("I will stay in Switzerland for a limited period (less than 1 year)",
                                "I will stay one or more years in Switzerland, but ultimately leave the country",
                                "I will stay all my life in Switzerland",
                                "I do not have a well defined plan")
    
    levels(mar[["D20"]]$H16)<-c("I will stay in Switzerland for a limited period (less than 1 year)",
                                "I will stay one or more years in Switzerland, but ultimately leave the country",
                                "I will stay all my life in Switzerland",
                                "I do not have a well defined plan")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$H16<-as.factor(marDF$H16)
    
    data<- if(input$magH2=="Absolute"){ 
      marDF[,c("year","H16", "pop")]}else{
        marDF[,c("year","H16", "prop")]}
    
    hc_yAxis<-ifelse(input$magH=="n_nw",5000,400000)
    
    
    formatter<- ifelse(input$magH2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$H16), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magH2=="Absolute",0,0),
               max=ifelse(input$magH2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "And now, what are your plans regarding the duration of your stay in Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(2:3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  
  #####K1  During the confinement period beginning in March 2020, where did you spend most of your time (working and free time)? #####
  
  output$K1_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K1", "pop","year")
      
      
      x<-x %>%
        group_by(year,K1) %>% 
        filter(K1!="(Missing)")%>%
        filter(K1!=-7)%>%
        filter(K1!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K1))
      
      x$K1<-as.factor(x$K1)
      x$K1<-fct_explicit_na(x$K1)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K1)<-c("In my usual place of residence in Switzerland",
                               "In another place in Switzerland",
                               "In my country of origin",
                               "In another country")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K1<-as.factor(marDF$K1)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K1", "pop")]}else{
        marDF[,c("year","K1", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  8000,800000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K1), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        # paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "During the confinement period beginning in March 2020, where did you spend most of your time (working and free time)?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  #####K2  Which statement best describes how you felt at that moment? #####
  
  output$K2_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K2", "pop","year")
      
      
      x<-x %>%
        group_by(year,K2) %>% 
        filter(K2!="(Missing)")%>%
        filter(K2!=-7)%>%
        filter(K2!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K2))
      
      x$K2<-as.factor(x$K2)
      x$K2<-fct_explicit_na(x$K2)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K2)<-c("My life is in Switzerland, so I felt I was in the right place",
                               "Being in Switzerland or in my home country was the same for me",
                               "I would have preferred to be in my home country")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K2<-as.factor(marDF$K2)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K2", "pop")]}else{
        marDF[,c("year","K2", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  8000,800000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K2), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Which statement best describes how you felt at that moment?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K3  WWhich impact did the partial lockdown in spring have on your professional situation in Switzerland? #####
  
  output$K3_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K3", "pop","year")
      
      
      x<-x %>%
        group_by(year,K3) %>% 
        filter(K3!="(Missing)")%>%
        filter(K3!=-7)%>%
        filter(K3!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K3))
      
      x$K3<-as.factor(x$K3)
      x$K3<-fct_explicit_na(x$K3)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K3)<-c("It had (almost) no impact",
                               "I kept my job, but I had to telework",
                               "I had to temporarily reduce my work time",
                               "I was temporarily put out of work",
                               "I lost my job, as an employee")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K3<-as.factor(marDF$K3)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K3", "pop")]}else{
        marDF[,c("year","K3", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  4000,400000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K3), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,75))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Which impact did the partial lockdown in spring have on your professional situation in Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K4  WWhich impact did the partial lockdown have on your professional situation in Switzerland?#####
  
  output$K4_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K4", "pop","year")
      
      
      x<-x %>%
        group_by(year,K4) %>% 
        filter(K4!="(Missing)")%>%
        filter(K4!=-7)%>%
        filter(K4!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K4))
      
      x$K4<-as.factor(x$K4)
      x$K4<-fct_explicit_na(x$K4)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K4)<-c("I could benefit economically from the situation",
                               "It had almost no impact",
                               "I kept most of my activities, but I had to organize my work differently",
                               "I kept only a part of my activities, and suffered from the situation",
                               "I was no longer able to work")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K4<-as.factor(marDF$K4)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K4", "pop")]}else{
        marDF[,c("year","K4", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  500,25000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K4), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,50))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #   paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Which impact did the partial lockdown have on your professional situation in Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K5  Which statement best fits how you felt about your residence status during that period?#####
  
  output$K5_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K5", "pop","year")
      
      
      x<-x %>%
        group_by(year,K5) %>% 
        filter(K5!="(Missing)")%>%
        filter(K5!=-7)%>%
        filter(K5!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K5))
      
      x$K5<-as.factor(x$K5)
      x$K5<-fct_explicit_na(x$K5)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K5)<-c("I did not fear losing my residence permit",
                               "I was concerned about the renewal of my permit",
                               "I lost my residence permit")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K5<-as.factor(marDF$K5)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K5", "pop")]}else{
        marDF[,c("year","K5", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  7000,700000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K5), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #    paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #   paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Which statement best fits how you felt about your residence status during that period?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K6  Did you experience discriminatory or unfair treatment based on your nationality in relation to the Covid-19 outbreak?#####
  
  output$K6_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K6", "pop","year")
      
      
      x<-x %>%
        group_by(year,K6) %>% 
        filter(K6!="(Missing)")%>%
        filter(K6!=-7)%>%
        filter(K6!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K6))
      
      x$K6<-as.factor(x$K6)
      x$K6<-fct_explicit_na(x$K6)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K6)<-c("Yes, I did experience such kind of treatment",
                               "No, I do not think so")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K6<-as.factor(marDF$K6)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K6", "pop")]}else{
        marDF[,c("year","K6", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  7500,750000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K6), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #   paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Did you experience discriminatory or unfair treatment based on your nationality in relation to the Covid-19 outbreak?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K7  Did you experience support or empathy from the population living in Switzerland because of how your country of origin was affected by the Covid-19 outbreak ?#####
  
  output$K7_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K7", "pop","year")
      
      
      x<-x %>%
        group_by(year,K7) %>% 
        filter(K7!="(Missing)")%>%
        filter(K7!=-7)%>%
        filter(K7!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K7))
      
      x$K7<-as.factor(x$K7)
      x$K7<-fct_explicit_na(x$K7)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K7)<-c("Yes, I did experience marks of support or empathy",
                               "No, I do not think so")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K7<-as.factor(marDF$K7)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K7", "pop")]}else{
        marDF[,c("year","K7", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  7500,750000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K7), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #  paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Did you experience support or empathy from the population living in Switzerland because of how your country of origin was affected by the Covid-19 outbreak?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K8 Did the Covid-19 outbreak affect your plans regarding your stay in Switzerland ?#####
  
  output$K8_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K8", "pop","year")
      
      
      x<-x %>%
        group_by(year,K8) %>% 
        filter(K8!="(Missing)")%>%
        filter(K8!=-7)%>%
        filter(K8!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K8))
      
      x$K8<-as.factor(x$K8)
      x$K8<-fct_explicit_na(x$K8)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K8)<-c("Yes, I decided/had to anticipate my departure",
                               "Yes, I decided/had to postpone my departure",
                               "No")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K8<-as.factor(marDF$K8)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K8", "pop")]}else{
        marDF[,c("year","K8", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  7500,750000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K8), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #    paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #   paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Did the Covid-19 outbreak affect your plans regarding your stay in Switzerland?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  #####K9 Did the Covid-19 outbreak affect your plans regarding naturalization?#####
  
  output$K9_20 <-renderHighchart({ 
    
    dmms1820 <-  dmms[3]
    mar <- lapply(dmms1820, function(x){
      
      x<-x[,c(input$BK,input$magK,"year")]#input$BF,input$magG,
      #x<-x[,c("A8","weight","year")]
      colnames(x)<-c("K9", "pop","year")
      
      
      x<-x %>%
        group_by(year,K9) %>% 
        filter(K9!="(Missing)")%>%
        filter(K9!=-7)%>%
        filter(K9!=-9)%>%
        summarise(pop=round(sum(pop),0))%>%
        mutate(prop=round(pop/sum(pop)*100,1))%>%
        arrange((K9))
      
      x$K9<-as.factor(x$K9)
      x$K9<-fct_explicit_na(x$K9)
      
      x
    })
    
    
    
    levels(mar[["D20"]]$K9)<-c("Yes, I realized that naturalization is a way to stabilize my stay in Switzerland",
                               "Yes, I realized that I no longer want to naturalize in Switzerland.",
                               "Yes, for other reasons",
                               "No")
    
    marDF<- as.data.frame(do.call("rbind", mar))
    marDF$K9<-as.factor(marDF$K9)
    
    data<- if(input$magK2=="Absolute"){ 
      marDF[,c("year","K9", "pop")]}else{
        marDF[,c("year","K9", "prop")]}
    
    hc_yAxis<-ifelse(input$magK=="n_nw",  7500,750000)
    
    
    formatter<- ifelse(input$magK2=="Relative","function(){ return Math.abs(this.value) + '%'; }",
                       "function(){ return Math.abs(this.value); }")
    
    rank <- highchart() %>% 
      #hc_chart(type = "bar") %>%
      hc_xAxis(categories = levels(marDF$K9), title = list(text = '')) %>%
      #hc_add_series(name= "Wave 2016",data = data[data$year==2016,3])%>%
      #hc_add_series(name= "Wave 2018",data = data[data$year==2018,3])%>%
      hc_add_series(name= "Wave 2020",data = data[data$year==2020,3])%>%
      hc_chart(type = 'bar',zoomType= 'xy') %>%
      hc_legend(enabled =TRUE ) %>%
      hc_yAxis(labels = list(formatter = JS(formatter)),
               min=ifelse(input$magK2=="Absolute",0,0),
               max=ifelse(input$magK2=="Absolute",hc_yAxis,100))%>%
      hc_plotOptions(series = list(dataLabels = list(enabled = TRUE))) %>%
      hc_subtitle(text =paste(
        #   paste("\n2016 N",a(sum(marDF[marDF$year==2016,"pop"])),sep=": "),
        #  paste("\n2018 N",a(sum(marDF[marDF$year==2018,"pop"])),sep=": "),
        paste("\n2020 N",a(sum(marDF[marDF$year==2020,"pop"])),sep=": "),
        sep=" | "))%>%
      hc_title(text = "Did the Covid-19 outbreak affect your plans regarding naturalization?",
               align = 'left')  %>%
      #hc_subtitle(text =  paste("\nN",a(sum(c(mar[["D16"]]$pop))),sep=": "))%>%
      hc_add_theme(hc_theme_smpl()) %>%
      
      hc_exporting(enabled = TRUE)%>%
      hc_tooltip(enabled = TRUE)%>%
      hc_colors(c(gg_color_hue(3)[c(3)]))%>% 
      hc_credits(enabled = TRUE, text = "NCCR ON THE MOVE",href = "https://nccr-onthemove.ch/")     
    
    rank
    
    
  })
  
  
  
  
  ##### crosstable ######
  
  output$cross <-renderText({ 
    
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$A, input$B,input$C,"year")] 
      
      colnames(x)<-c("A","B","pop","year")
      x[is.na(x)] <- -7
      
      x
    })
    
    ##### 16 A ####     
    df<-mar[["D16"]]%>%
      group_by(A, B)%>%
      filter(A!=-9)%>% 
      filter(A!=-8)%>% 
      filter(A!=99)%>% 
      filter(A!=-7)%>% 
      filter(B!=-9)%>% 
      filter(A!=-8)%>% 
      filter(B!=99)%>% 
      filter(B!=-7)%>% 
      summarise(n=round(sum(pop),0))%>%
      mutate(prop=round((n/sum(n)*100),2))
    
    
    df[[1]]<-as.factor(df[[1]])
    levels(df[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
    {if(input$A=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$A=="A9"|
                              input$A=="B8_1"|
                              input$A=="B8_2"|
                              input$A=="B8_3"|
                              input$A=="B8_4"|
                              input$A=="B8_5"|
                              input$A=="B8_6"|
                              input$A=="B8_7"|
                              input$A=="B8_8"|
                              input$A=="B8_9"|
                              input$A=="B8_10"|
                              input$A=="B13_1"|
                              input$A=="B13_2"|
                              input$A=="B13_3"|
                              input$A=="B13_4"|
                              input$A=="B13_5"|
                              input$A=="B13_6"|
                              input$A=="B8_10"|
                              input$A=="C2_1"|
                              input$A=="C2_2"|
                              input$A=="C2_3"|
                              input$A=="C2_4"|
                              input$A=="C2_5"|
                              input$A=="C2_6"|
                              input$A=="C2_7"|
                              input$A=="C3_1"|
                              input$A=="C3_2"|
                              input$A=="C3_3"|
                              input$A=="C3_4"|
                              input$A=="C3_5"|
                              input$A=="C3_6"|
                              input$A=="C3_7"|
                              input$A=="C3_8"|
                              input$A=="E1_1"|
                              input$A=="E1_2"|
                              input$A=="E1_3"|
                              input$A=="E1_4"|
                              input$A=="E1_5"|
                              input$A=="E1_6"|
                              input$A=="E1_7"|
                              input$A=="E1_8"|
                              input$A=="E1_9"|
                              input$A=="E11_1"|
                              input$A=="E11_2"|
                              input$A=="E11_3"|
                              input$A=="E11_4"|
                              input$A=="E11_5"|
                              input$A=="E11_6"|
                              input$A=="E11_7"|
                              input$A=="E11_8"|
                              input$A=="E11_9"|
                              input$A=="E16_1"|
                              input$A=="E16_2"|
                              input$A=="E16_3"|
                              input$A=="E16_4"|
                              input$A=="E16_5"|
                              input$A=="E16_6"|
                              input$A=="E16_7"|
                              input$A=="E16_8"|
                              input$A=="E16_9"|
                              input$A=="F7_1"|
                              input$A=="F7_2"|
                              input$A=="F7_3"|
                              input$A=="F7_4"|
                              input$A=="F7_5"|
                              input$A=="F7_6"|
                              input$A=="F7_7"|
                              input$A=="F7_8"|
                              input$A=="F7_9"|
                              input$A=="H8_1"|
                              input$A=="H8_2"|
                              input$A=="H8_3"|
                              input$A=="H8_4"|
                              input$A=="H8_5"|
                              input$A=="H8_6"|
                              input$A=="H8_7"|
                              input$A=="H8_8"|
                              input$A=="H9_1"|
                              input$A=="H9_2"|
                              input$A=="H9_3"|
                              input$A=="H9_4"|
                              input$A=="H9_6")){c("Yes","No")}else
                              {if(input$A=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$A=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016")}else
                                                                               {if(input$A=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$A=="B4"|
                                                                                                            input$A=="B9"|
                                                                                                            input$A=="E4"|
                                                                                                            input$A=="E5"|
                                                                                                            input$A=="E15"|
                                                                                                            input$A=="G7"|
                                                                                                            input$A=="G11")){c("Yes","No")}else
                                                                                                            {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality")}else
                                                                                                                                                       {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    
    ##### 16 B ####      
    df[[2]]<-as.factor(df[[2]])
    levels(df[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
    {if(input$B=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$B=="A9"|
                              input$B=="B8_1"|
                              input$B=="B8_2"|
                              input$B=="B8_3"|
                              input$B=="B8_4"|
                              input$B=="B8_5"|
                              input$B=="B8_6"|
                              input$B=="B8_7"|
                              input$B=="B8_8"|
                              input$B=="B8_9"|
                              input$B=="B8_10"|
                              input$B=="B13_1"|
                              input$B=="B13_2"|
                              input$B=="B13_3"|
                              input$B=="B13_4"|
                              input$B=="B13_5"|
                              input$B=="B13_6"|
                              input$B=="B8_10"|
                              input$B=="C2_1"|
                              input$B=="C2_2"|
                              input$B=="C2_3"|
                              input$B=="C2_4"|
                              input$B=="C2_5"|
                              input$B=="C2_6"|
                              input$B=="C2_7"|
                              input$B=="C3_1"|
                              input$B=="C3_2"|
                              input$B=="C3_3"|
                              input$B=="C3_4"|
                              input$B=="C3_5"|
                              input$B=="C3_6"|
                              input$B=="C3_7"|
                              input$B=="C3_8"|
                              input$B=="E1_1"|
                              input$B=="E1_2"|
                              input$B=="E1_3"|
                              input$B=="E1_4"|
                              input$B=="E1_5"|
                              input$B=="E1_6"|
                              input$B=="E1_7"|
                              input$B=="E1_8"|
                              input$B=="E1_9"|
                              input$B=="E11_1"|
                              input$B=="E11_2"|
                              input$B=="E11_3"|
                              input$B=="E11_4"|
                              input$B=="E11_5"|
                              input$B=="E11_6"|
                              input$B=="E11_7"|
                              input$B=="E11_8"|
                              input$B=="E11_9"|
                              input$B=="E16_1"|
                              input$B=="E16_2"|
                              input$B=="E16_3"|
                              input$B=="E16_4"|
                              input$B=="E16_5"|
                              input$B=="E16_6"|
                              input$B=="E16_7"|
                              input$B=="E16_8"|
                              input$B=="E16_9"|
                              input$B=="F7_1"|
                              input$B=="F7_2"|
                              input$B=="F7_3"|
                              input$B=="F7_4"|
                              input$B=="F7_5"|
                              input$B=="F7_6"|
                              input$B=="F7_7"|
                              input$B=="F7_8"|
                              input$B=="F7_9"|
                              input$B=="H8_1"|
                              input$B=="H8_2"|
                              input$B=="H8_3"|
                              input$B=="H8_4"|
                              input$B=="H8_5"|
                              input$B=="H8_6"|
                              input$B=="H8_7"|
                              input$B=="H8_8"|
                              input$B=="H9_1"|
                              input$B=="H9_2"|
                              input$B=="H9_3"|
                              input$B=="H9_4"|
                              input$B=="H9_6")){c("Yes","No")}else
                              {if(input$B=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$B=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016")}else
                                                                               {if(input$B=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$B=="B4"|
                                                                                                            input$B=="B9"|
                                                                                                            input$B=="E4"|
                                                                                                            input$B=="E5"|
                                                                                                            input$B=="E15"|
                                                                                                            input$B=="G7"|
                                                                                                            input$B=="G11")){c("Yes","No")}else
                                                                                                            {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality")}else
                                                                                                                                                       {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    
    kable(df %>%
            subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
            rename("Table" = 1,"B"=2,"C"=3)%>% 
            spread(B, C),caption = paste(paste(ifelse(input$C=="weight","Weighted data","Non weighted data"),
                                               ifelse(input$D=="Relative","(%)","(N)"), sep=" "),"2016",sep=": "))%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  })    
  
  output$cross2 <-renderText({ 
    
    ##### 18 A ####
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$A, input$B,input$C,"year")] 
      
      colnames(x)<-c("A","B","pop","year")
      
      x
    })
    
    
    df<-mar[["D18"]]%>%
      group_by(A, B)%>%
      filter(A!=-9)%>% 
      filter(A!=-8)%>% 
      filter(A!=99)%>% 
      filter(A!=-7)%>% 
      filter(B!=-9)%>% 
      filter(A!=-8)%>% 
      filter(B!=99)%>% 
      filter(B!=-7)%>% 
      summarise(n=round(sum(pop),0))%>%
      mutate(prop=round((n/sum(n)*100),2))
    
    df[[1]]<-as.factor(df[[1]])
    levels(df[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
    {if(input$A=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$A=="A9"|
                              input$A=="B8_1"|
                              input$A=="B8_2"|
                              input$A=="B8_3"|
                              input$A=="B8_4"|
                              input$A=="B8_5"|
                              input$A=="B8_6"|
                              input$A=="B8_7"|
                              input$A=="B8_8"|
                              input$A=="B8_9"|
                              input$A=="B8_10"|
                              input$A=="B13_1"|
                              input$A=="B13_2"|
                              input$A=="B13_3"|
                              input$A=="B13_4"|
                              input$A=="B13_5"|
                              input$A=="B13_6"|
                              input$A=="B8_10"|
                              input$A=="C2_1"|
                              input$A=="C2_2"|
                              input$A=="C2_3"|
                              input$A=="C2_4"|
                              input$A=="C2_5"|
                              input$A=="C2_6"|
                              input$A=="C2_7"|
                              input$A=="C3_1"|
                              input$A=="C3_2"|
                              input$A=="C3_3"|
                              input$A=="C3_4"|
                              input$A=="C3_5"|
                              input$A=="C3_6"|
                              input$A=="C3_7"|
                              input$A=="C3_8"|
                              input$A=="E1_1"|
                              input$A=="E1_2"|
                              input$A=="E1_3"|
                              input$A=="E1_4"|
                              input$A=="E1_5"|
                              input$A=="E1_6"|
                              input$A=="E1_7"|
                              input$A=="E1_8"|
                              input$A=="E1_9"|
                              input$A=="E11_1"|
                              input$A=="E11_2"|
                              input$A=="E11_3"|
                              input$A=="E11_4"|
                              input$A=="E11_5"|
                              input$A=="E11_6"|
                              input$A=="E11_7"|
                              input$A=="E11_8"|
                              input$A=="E11_9"|
                              input$A=="E16_1"|
                              input$A=="E16_2"|
                              input$A=="E16_3"|
                              input$A=="E16_4"|
                              input$A=="E16_5"|
                              input$A=="E16_6"|
                              input$A=="E16_7"|
                              input$A=="E16_8"|
                              input$A=="E16_9"|
                              input$A=="F7_1"|
                              input$A=="F7_2"|
                              input$A=="F7_3"|
                              input$A=="F7_4"|
                              input$A=="F7_5"|
                              input$A=="F7_6"|
                              input$A=="F7_7"|
                              input$A=="F7_8"|
                              input$A=="F7_9"|
                              input$A=="H8_1"|
                              input$A=="H8_2"|
                              input$A=="H8_3"|
                              input$A=="H8_4"|
                              input$A=="H8_5"|
                              input$A=="H8_6"|
                              input$A=="H8_7"|
                              input$A=="H8_8"|
                              input$A=="H9_1"|
                              input$A=="H9_2"|
                              input$A=="H9_3"|
                              input$A=="H9_4"|
                              input$A=="H9_6")){c("Yes","No")}else
                              {if(input$A=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$A=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016", 
                                                                               "2017",
                                                                               "2018")}else
                                                                               {if(input$A=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$A=="B4"|
                                                                                                            input$A=="B9"|
                                                                                                            input$A=="E4"|
                                                                                                            input$A=="E5"|
                                                                                                            input$A=="E15"|
                                                                                                            input$A=="G7"|
                                                                                                            input$A=="G11")){c("Yes","No")}else
                                                                                                            {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality")}else
                                                                                                                                                       {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    ##### 18 B ####    
    df[[2]]<-as.factor(df[[2]])
    levels(df[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
    {if(input$B=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$B=="A9"|
                              input$B=="B8_1"|
                              input$B=="B8_2"|
                              input$B=="B8_3"|
                              input$B=="B8_4"|
                              input$B=="B8_5"|
                              input$B=="B8_6"|
                              input$B=="B8_7"|
                              input$B=="B8_8"|
                              input$B=="B8_9"|
                              input$B=="B8_10"|
                              input$B=="B13_1"|
                              input$B=="B13_2"|
                              input$B=="B13_3"|
                              input$B=="B13_4"|
                              input$B=="B13_5"|
                              input$B=="B13_6"|
                              input$B=="B8_10"|
                              input$B=="C2_1"|
                              input$B=="C2_2"|
                              input$B=="C2_3"|
                              input$B=="C2_4"|
                              input$B=="C2_5"|
                              input$B=="C2_6"|
                              input$B=="C2_7"|
                              input$B=="C3_1"|
                              input$B=="C3_2"|
                              input$B=="C3_3"|
                              input$B=="C3_4"|
                              input$B=="C3_5"|
                              input$B=="C3_6"|
                              input$B=="C3_7"|
                              input$B=="C3_8"|
                              input$B=="E1_1"|
                              input$B=="E1_2"|
                              input$B=="E1_3"|
                              input$B=="E1_4"|
                              input$B=="E1_5"|
                              input$B=="E1_6"|
                              input$B=="E1_7"|
                              input$B=="E1_8"|
                              input$B=="E1_9"|
                              input$B=="E11_1"|
                              input$B=="E11_2"|
                              input$B=="E11_3"|
                              input$B=="E11_4"|
                              input$B=="E11_5"|
                              input$B=="E11_6"|
                              input$B=="E11_7"|
                              input$B=="E11_8"|
                              input$B=="E11_9"|
                              input$B=="E16_1"|
                              input$B=="E16_2"|
                              input$B=="E16_3"|
                              input$B=="E16_4"|
                              input$B=="E16_5"|
                              input$B=="E16_6"|
                              input$B=="E16_7"|
                              input$B=="E16_8"|
                              input$B=="E16_9"|
                              input$B=="F7_1"|
                              input$B=="F7_2"|
                              input$B=="F7_3"|
                              input$B=="F7_4"|
                              input$B=="F7_5"|
                              input$B=="F7_6"|
                              input$B=="F7_7"|
                              input$B=="F7_8"|
                              input$B=="F7_9"|
                              input$B=="H8_1"|
                              input$B=="H8_2"|
                              input$B=="H8_3"|
                              input$B=="H8_4"|
                              input$B=="H8_5"|
                              input$B=="H8_6"|
                              input$B=="H8_7"|
                              input$B=="H8_8"|
                              input$B=="H9_1"|
                              input$B=="H9_2"|
                              input$B=="H9_3"|
                              input$B=="H9_4"|
                              input$B=="H9_6")){c("Yes","No")}else
                              {if(input$B=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$B=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016",
                                                                               "2017",
                                                                               "2018")}else
                                                                               {if(input$B=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$B=="B4"|
                                                                                                            input$B=="B9"|
                                                                                                            input$B=="E4"|
                                                                                                            input$B=="E5"|
                                                                                                            input$B=="E15"|
                                                                                                            input$B=="G7"|
                                                                                                            input$B=="G11")){c("Yes","No")}else
                                                                                                            {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality")}else
                                                                                                                                                       {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    
    
    
    kable(df %>%
            subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
            rename("Table" = 1,"B"=2,"C"=3)%>% 
            spread(B, C),caption = paste(paste(ifelse(input$C=="weight","Weighted data","Non weighted data"),
                                               ifelse(input$D=="Relative","(%)","(N)"), sep=" "),"2018",sep=": "))%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  }) 
  
  
  output$cross3 <-renderText({ 
    
    ##### 20 A ####
    mar <- lapply(dmms, function(x){
      
      x<-x[,c(input$A, input$B,input$C,"year")] 
      
      colnames(x)<-c("A","B","pop","year")
      
      x
    })
    
    
    df<-mar[["D20"]]%>%
      group_by(A, B)%>%
      filter(A!=-9)%>% 
      filter(A!=-8)%>% 
      filter(A!=99)%>% 
      filter(A!=-7)%>% 
      filter(B!=-9)%>% 
      filter(A!=-8)%>% 
      filter(B!=99)%>% 
      filter(B!=-7)%>% 
      summarise(n=round(sum(pop),0))%>%
      mutate(prop=round((n/sum(n)*100),2))
    
    df[[1]]<-as.factor(df[[1]])
    levels(df[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
    {if(input$A=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$A=="A9"|
                              input$A=="B8_1"|
                              input$A=="B8_2"|
                              input$A=="B8_3"|
                              input$A=="B8_4"|
                              input$A=="B8_5"|
                              input$A=="B8_6"|
                              input$A=="B8_7"|
                              input$A=="B8_8"|
                              input$A=="B8_9"|
                              input$A=="B8_10"|
                              input$A=="B13_1"|
                              input$A=="B13_2"|
                              input$A=="B13_3"|
                              input$A=="B13_4"|
                              input$A=="B13_5"|
                              input$A=="B13_6"|
                              input$A=="B8_10"|
                              input$A=="C2_1"|
                              input$A=="C2_2"|
                              input$A=="C2_3"|
                              input$A=="C2_4"|
                              input$A=="C2_5"|
                              input$A=="C2_6"|
                              input$A=="C2_7"|
                              input$A=="C3_1"|
                              input$A=="C3_2"|
                              input$A=="C3_3"|
                              input$A=="C3_4"|
                              input$A=="C3_5"|
                              input$A=="C3_6"|
                              input$A=="C3_7"|
                              input$A=="C3_8"|
                              input$A=="E1_1"|
                              input$A=="E1_2"|
                              input$A=="E1_3"|
                              input$A=="E1_4"|
                              input$A=="E1_5"|
                              input$A=="E1_6"|
                              input$A=="E1_7"|
                              input$A=="E1_8"|
                              input$A=="E1_9"|
                              input$A=="E11_1"|
                              input$A=="E11_2"|
                              input$A=="E11_3"|
                              input$A=="E11_4"|
                              input$A=="E11_5"|
                              input$A=="E11_6"|
                              input$A=="E11_7"|
                              input$A=="E11_8"|
                              input$A=="E11_9"|
                              input$A=="E16_1"|
                              input$A=="E16_2"|
                              input$A=="E16_3"|
                              input$A=="E16_4"|
                              input$A=="E16_5"|
                              input$A=="E16_6"|
                              input$A=="E16_7"|
                              input$A=="E16_8"|
                              input$A=="E16_9"|
                              input$A=="F7_1"|
                              input$A=="F7_2"|
                              input$A=="F7_3"|
                              input$A=="F7_4"|
                              input$A=="F7_5"|
                              input$A=="F7_6"|
                              input$A=="F7_7"|
                              input$A=="F7_8"|
                              input$A=="F7_9"|
                              input$A=="H8_1"|
                              input$A=="H8_2"|
                              input$A=="H8_3"|
                              input$A=="H8_4"|
                              input$A=="H8_5"|
                              input$A=="H8_6"|
                              input$A=="H8_7"|
                              input$A=="H8_8"|
                              input$A=="H9_1"|
                              input$A=="H9_2"|
                              input$A=="H9_3"|
                              input$A=="H9_4"|
                              input$A=="H9_6")){c("Yes","No")}else
                              {if(input$A=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$A=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016", 
                                                                               "2017",
                                                                               "2018",
                                                                               "2019",
                                                                               "2020")}else
                                                                               {if(input$A=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$A=="B4"|
                                                                                                            input$A=="B9"|
                                                                                                            input$A=="E4"|
                                                                                                            input$A=="E5"|
                                                                                                            input$A=="E15"|
                                                                                                            input$A=="G7"|
                                                                                                            input$A=="G11")){c("Yes","No")}else
                                                                                                            {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality",
                                                                                                                                                       "I have already being naturalized")}else
                                                                                                                                                       {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Other",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "I have the Swiss citizenship")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    ##### 20 B ####    
    df[[2]]<-as.factor(df[[2]])
    levels(df[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
    {if(input$B=="A8"){c("Single, never married",
                         "Married",
                         "Separated",
                         "Divorced",
                         "Widowed",
                         "Registered partnership",
                         "Dissolved partnership")}else
                         {if((input$B=="A9"|
                              input$B=="B8_1"|
                              input$B=="B8_2"|
                              input$B=="B8_3"|
                              input$B=="B8_4"|
                              input$B=="B8_5"|
                              input$B=="B8_6"|
                              input$B=="B8_7"|
                              input$B=="B8_8"|
                              input$B=="B8_9"|
                              input$B=="B8_10"|
                              input$B=="B13_1"|
                              input$B=="B13_2"|
                              input$B=="B13_3"|
                              input$B=="B13_4"|
                              input$B=="B13_5"|
                              input$B=="B13_6"|
                              input$B=="B8_10"|
                              input$B=="C2_1"|
                              input$B=="C2_2"|
                              input$B=="C2_3"|
                              input$B=="C2_4"|
                              input$B=="C2_5"|
                              input$B=="C2_6"|
                              input$B=="C2_7"|
                              input$B=="C3_1"|
                              input$B=="C3_2"|
                              input$B=="C3_3"|
                              input$B=="C3_4"|
                              input$B=="C3_5"|
                              input$B=="C3_6"|
                              input$B=="C3_7"|
                              input$B=="C3_8"|
                              input$B=="E1_1"|
                              input$B=="E1_2"|
                              input$B=="E1_3"|
                              input$B=="E1_4"|
                              input$B=="E1_5"|
                              input$B=="E1_6"|
                              input$B=="E1_7"|
                              input$B=="E1_8"|
                              input$B=="E1_9"|
                              input$B=="E11_1"|
                              input$B=="E11_2"|
                              input$B=="E11_3"|
                              input$B=="E11_4"|
                              input$B=="E11_5"|
                              input$B=="E11_6"|
                              input$B=="E11_7"|
                              input$B=="E11_8"|
                              input$B=="E11_9"|
                              input$B=="E16_1"|
                              input$B=="E16_2"|
                              input$B=="E16_3"|
                              input$B=="E16_4"|
                              input$B=="E16_5"|
                              input$B=="E16_6"|
                              input$B=="E16_7"|
                              input$B=="E16_8"|
                              input$B=="E16_9"|
                              input$B=="F7_1"|
                              input$B=="F7_2"|
                              input$B=="F7_3"|
                              input$B=="F7_4"|
                              input$B=="F7_5"|
                              input$B=="F7_6"|
                              input$B=="F7_7"|
                              input$B=="F7_8"|
                              input$B=="F7_9"|
                              input$B=="H8_1"|
                              input$B=="H8_2"|
                              input$B=="H8_3"|
                              input$B=="H8_4"|
                              input$B=="H8_5"|
                              input$B=="H8_6"|
                              input$B=="H8_7"|
                              input$B=="H8_8"|
                              input$B=="H9_1"|
                              input$B=="H9_2"|
                              input$B=="H9_3"|
                              input$B=="H9_4"|
                              input$B=="H9_6")){c("Yes","No")}else
                              {if(input$B=="age_group"){c("20-30",
                                                          "30-40",
                                                          "40_50",
                                                          "50-60",
                                                          "60-64")}else
                                                          {if(input$B=="A6"){c("2006",
                                                                               "2007",
                                                                               "2008",
                                                                               "2009",
                                                                               "2010",
                                                                               "2011",
                                                                               "2012",
                                                                               "2013",
                                                                               "2014",
                                                                               "2015",
                                                                               "2016",
                                                                               "2017",
                                                                               "2018",
                                                                               "2019",
                                                                               "2020")}else
                                                                               {if(input$B=="B2CAT"){c("In no other country",
                                                                                                       "In 1 other country",
                                                                                                       "In 2 other countries",
                                                                                                       "In 3 other countries",
                                                                                                       "In 4 or more other countries")}else
                                                                                                       {if((input$B=="B4"|
                                                                                                            input$B=="B9"|
                                                                                                            input$B=="E4"|
                                                                                                            input$B=="E5"|
                                                                                                            input$B=="E15"|
                                                                                                            input$B=="G7"|
                                                                                                            input$B=="G11")){c("Yes","No")}else
                                                                                                            {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                  "You moved together",
                                                                                                                                  "Your spouse/partner moved before you",
                                                                                                                                  "Your spouse/partner moved after you",
                                                                                                                                  "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                  {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                       "Yes, probably",
                                                                                                                                                       "No, probably not",
                                                                                                                                                       "No, certainly not",
                                                                                                                                                       "I do not know yet",
                                                                                                                                                       "I have already applied for the Swiss nationality",
                                                                                                                                                       "I have already being naturalized")}else
                                                                                                                                                       {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                         "Compulsory education",
                                                                                                                                                                                                                         "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                         "Vocational education and/or training",
                                                                                                                                                                                                                         "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                         "Advanced technical and professional training",
                                                                                                                                                                                                                         "Bachelor or equivalent",
                                                                                                                                                                                                                         "Master or equivalent",
                                                                                                                                                                                                                         "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                         {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                              "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                              "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                              "No, it was not necessary",
                                                                                                                                                                                                                                              "No, other reasons")}else
                                                                                                                                                                                                                                              {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                   "A company owner",
                                                                                                                                                                                                                                                                                                   "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                   "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                   "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                   "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                   "An apprentice",
                                                                                                                                                                                                                                                                                                   "Master or equivalent",
                                                                                                                                                                                                                                                                                                   "A PhD student")}else
                                                                                                                                                                                                                                                                                                   {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                         "Limited duration",
                                                                                                                                                                                                                                                                                                                         "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                         {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                               "Improved slightly",
                                                                                                                                                                                                                                                                                                                                               "Remained the same",
                                                                                                                                                                                                                                                                                                                                               "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                               "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                               {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                      "German",
                                                                                                                                                                                                                                                                                                                                                                      "French",
                                                                                                                                                                                                                                                                                                                                                                      "Romansh",
                                                                                                                                                                                                                                                                                                                                                                      "Italian",
                                                                                                                                                                                                                                                                                                                                                                      "English",
                                                                                                                                                                                                                                                                                                                                                                      "Spanish",
                                                                                                                                                                                                                                                                                                                                                                      "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                      "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                      {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                      {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                           "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                           "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                           "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                           {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                     "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Other",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "I have the Swiss citizenship")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }}}}}}}}}}}}}}}}}}}}}}}
    
    
    
    kable(df %>%
            subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
            rename("Table" = 1,"B"=2,"C"=3)%>% 
            spread(B, C),caption = paste(paste(ifelse(input$C=="weight","Weighted data","Non weighted data"),
                                               ifelse(input$D=="Relative","(%)","(N)"), sep=" "),"2020",sep=": "))%>%
      kable_styling(
        font_size = 15,
        bootstrap_options = c("striped", "hover", "condensed"))
  }) 
  
  #### DOWNLOAD DATA SECTION CROOS ###### 
  
  output$downloadDataCT <- downloadHandler(
    
    # This function returns a string which tells the client
    # browser what name to use when saving the file.
    filename = function() {
      paste(paste("nccr","data",sep=" "), input$filetypeCT, sep = ".")
    },
    
    # This function should write data to a file given to it by
    # the argument 'file'.
    content = function(file) {
      sep <- switch(input$filetypeCT, "csv" = ",", "txt" = "\t")
      
      mar <- lapply(dmms, function(x){
        
        x<-x[,c(input$A, input$B,input$C,"year")] 
        
        colnames(x)<-c("A","B","pop","year")
        x[is.na(x)] <- -7
        
        x
      })
      
      ##### 16 A ####  
      df<-mar[["D16"]]%>%
        group_by(A, B)%>%
        filter(A!=-9)%>% 
        filter(A!=-8)%>% 
        filter(A!=99)%>% 
        filter(A!=-7)%>% 
        filter(B!=-9)%>% 
        filter(A!=-8)%>% 
        filter(B!=99)%>% 
        filter(B!=-7)%>% 
        summarise(n=round(sum(pop),0))%>%
        mutate(prop=round((n/sum(n)*100),2))
      
      df[[1]]<-as.factor(df[[1]])
      levels(df[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
      {if(input$A=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$A=="A9"|
                                input$A=="B8_1"|
                                input$A=="B8_2"|
                                input$A=="B8_3"|
                                input$A=="B8_4"|
                                input$A=="B8_5"|
                                input$A=="B8_6"|
                                input$A=="B8_7"|
                                input$A=="B8_8"|
                                input$A=="B8_9"|
                                input$A=="B8_10"|
                                input$A=="B13_1"|
                                input$A=="B13_2"|
                                input$A=="B13_3"|
                                input$A=="B13_4"|
                                input$A=="B13_5"|
                                input$A=="B13_6"|
                                input$A=="B8_10"|
                                input$A=="C2_1"|
                                input$A=="C2_2"|
                                input$A=="C2_3"|
                                input$A=="C2_4"|
                                input$A=="C2_5"|
                                input$A=="C2_6"|
                                input$A=="C2_7"|
                                input$A=="C3_1"|
                                input$A=="C3_2"|
                                input$A=="C3_3"|
                                input$A=="C3_4"|
                                input$A=="C3_5"|
                                input$A=="C3_6"|
                                input$A=="C3_7"|
                                input$A=="C3_8"|
                                input$A=="E1_1"|
                                input$A=="E1_2"|
                                input$A=="E1_3"|
                                input$A=="E1_4"|
                                input$A=="E1_5"|
                                input$A=="E1_6"|
                                input$A=="E1_7"|
                                input$A=="E1_8"|
                                input$A=="E1_9"|
                                input$A=="E11_1"|
                                input$A=="E11_2"|
                                input$A=="E11_3"|
                                input$A=="E11_4"|
                                input$A=="E11_5"|
                                input$A=="E11_6"|
                                input$A=="E11_7"|
                                input$A=="E11_8"|
                                input$A=="E11_9"|
                                input$A=="E16_1"|
                                input$A=="E16_2"|
                                input$A=="E16_3"|
                                input$A=="E16_4"|
                                input$A=="E16_5"|
                                input$A=="E16_6"|
                                input$A=="E16_7"|
                                input$A=="E16_8"|
                                input$A=="E16_9"|
                                input$A=="F7_1"|
                                input$A=="F7_2"|
                                input$A=="F7_3"|
                                input$A=="F7_4"|
                                input$A=="F7_5"|
                                input$A=="F7_6"|
                                input$A=="F7_7"|
                                input$A=="F7_8"|
                                input$A=="F7_9"|
                                input$A=="H8_1"|
                                input$A=="H8_2"|
                                input$A=="H8_3"|
                                input$A=="H8_4"|
                                input$A=="H8_5"|
                                input$A=="H8_6"|
                                input$A=="H8_7"|
                                input$A=="H8_8"|
                                input$A=="H9_1"|
                                input$A=="H9_2"|
                                input$A=="H9_3"|
                                input$A=="H9_4"|
                                input$A=="H9_6")){c("Yes","No")}else
                                {if(input$A=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$A=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016")}else
                                                                                 {if(input$A=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$A=="B4"|
                                                                                                              input$A=="B9"|
                                                                                                              input$A=="E4"|
                                                                                                              input$A=="E5"|
                                                                                                              input$A=="E15"|
                                                                                                              input$A=="G7"|
                                                                                                              input$A=="G11")){c("Yes","No")}else
                                                                                                              {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      ##### 16 B ####         
      df[[2]]<-as.factor(df[[2]])
      levels(df[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
      {if(input$B=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$B=="A9"|
                                input$B=="B8_1"|
                                input$B=="B8_2"|
                                input$B=="B8_3"|
                                input$B=="B8_4"|
                                input$B=="B8_5"|
                                input$B=="B8_6"|
                                input$B=="B8_7"|
                                input$B=="B8_8"|
                                input$B=="B8_9"|
                                input$B=="B8_10"|
                                input$B=="B13_1"|
                                input$B=="B13_2"|
                                input$B=="B13_3"|
                                input$B=="B13_4"|
                                input$B=="B13_5"|
                                input$B=="B13_6"|
                                input$B=="B8_10"|
                                input$B=="C2_1"|
                                input$B=="C2_2"|
                                input$B=="C2_3"|
                                input$B=="C2_4"|
                                input$B=="C2_5"|
                                input$B=="C2_6"|
                                input$B=="C2_7"|
                                input$B=="C3_1"|
                                input$B=="C3_2"|
                                input$B=="C3_3"|
                                input$B=="C3_4"|
                                input$B=="C3_5"|
                                input$B=="C3_6"|
                                input$B=="C3_7"|
                                input$B=="C3_8"|
                                input$B=="E1_1"|
                                input$B=="E1_2"|
                                input$B=="E1_3"|
                                input$B=="E1_4"|
                                input$B=="E1_5"|
                                input$B=="E1_6"|
                                input$B=="E1_7"|
                                input$B=="E1_8"|
                                input$B=="E1_9"|
                                input$B=="E11_1"|
                                input$B=="E11_2"|
                                input$B=="E11_3"|
                                input$B=="E11_4"|
                                input$B=="E11_5"|
                                input$B=="E11_6"|
                                input$B=="E11_7"|
                                input$B=="E11_8"|
                                input$B=="E11_9"|
                                input$B=="E16_1"|
                                input$B=="E16_2"|
                                input$B=="E16_3"|
                                input$B=="E16_4"|
                                input$B=="E16_5"|
                                input$B=="E16_6"|
                                input$B=="E16_7"|
                                input$B=="E16_8"|
                                input$B=="E16_9"|
                                input$B=="F7_1"|
                                input$B=="F7_2"|
                                input$B=="F7_3"|
                                input$B=="F7_4"|
                                input$B=="F7_5"|
                                input$B=="F7_6"|
                                input$B=="F7_7"|
                                input$B=="F7_8"|
                                input$B=="F7_9"|
                                input$B=="H8_1"|
                                input$B=="H8_2"|
                                input$B=="H8_3"|
                                input$B=="H8_4"|
                                input$B=="H8_5"|
                                input$B=="H8_6"|
                                input$B=="H8_7"|
                                input$B=="H8_8"|
                                input$B=="H9_1"|
                                input$B=="H9_2"|
                                input$B=="H9_3"|
                                input$B=="H9_4"|
                                input$B=="H9_6")){c("Yes","No")}else
                                {if(input$B=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$B=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016")}else
                                                                                 {if(input$B=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$B=="B4"|
                                                                                                              input$B=="B9"|
                                                                                                              input$B=="E4"|
                                                                                                              input$B=="E5"|
                                                                                                              input$B=="E15"|
                                                                                                              input$B=="G7"|
                                                                                                              input$B=="G11")){c("Yes","No")}else
                                                                                                              {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      
      dffinal0<-df %>%
        subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
        rename("Table" = 1,"B"=2,"C"=3)%>% 
        spread(B, C)%>%
        mutate(year=2016)
      ##### 18 A ####         
      df1<-mar[["D18"]]%>%
        group_by(A, B)%>%
        filter(A!=-9)%>% 
        filter(A!=-8)%>% 
        filter(A!=99)%>% 
        filter(A!=-7)%>% 
        filter(B!=-9)%>% 
        filter(A!=-8)%>% 
        filter(B!=99)%>% 
        filter(B!=-7)%>% 
        summarise(n=round(sum(pop),0))%>%
        mutate(prop=round((n/sum(n)*100),2))
      
      df1[[1]]<-as.factor(df1[[1]])
      levels(df1[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
      {if(input$A=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$A=="A9"|
                                input$A=="B8_1"|
                                input$A=="B8_2"|
                                input$A=="B8_3"|
                                input$A=="B8_4"|
                                input$A=="B8_5"|
                                input$A=="B8_6"|
                                input$A=="B8_7"|
                                input$A=="B8_8"|
                                input$A=="B8_9"|
                                input$A=="B8_10"|
                                input$A=="B13_1"|
                                input$A=="B13_2"|
                                input$A=="B13_3"|
                                input$A=="B13_4"|
                                input$A=="B13_5"|
                                input$A=="B13_6"|
                                input$A=="B8_10"|
                                input$A=="C2_1"|
                                input$A=="C2_2"|
                                input$A=="C2_3"|
                                input$A=="C2_4"|
                                input$A=="C2_5"|
                                input$A=="C2_6"|
                                input$A=="C2_7"|
                                input$A=="C3_1"|
                                input$A=="C3_2"|
                                input$A=="C3_3"|
                                input$A=="C3_4"|
                                input$A=="C3_5"|
                                input$A=="C3_6"|
                                input$A=="C3_7"|
                                input$A=="C3_8"|
                                input$A=="E1_1"|
                                input$A=="E1_2"|
                                input$A=="E1_3"|
                                input$A=="E1_4"|
                                input$A=="E1_5"|
                                input$A=="E1_6"|
                                input$A=="E1_7"|
                                input$A=="E1_8"|
                                input$A=="E1_9"|
                                input$A=="E11_1"|
                                input$A=="E11_2"|
                                input$A=="E11_3"|
                                input$A=="E11_4"|
                                input$A=="E11_5"|
                                input$A=="E11_6"|
                                input$A=="E11_7"|
                                input$A=="E11_8"|
                                input$A=="E11_9"|
                                input$A=="E16_1"|
                                input$A=="E16_2"|
                                input$A=="E16_3"|
                                input$A=="E16_4"|
                                input$A=="E16_5"|
                                input$A=="E16_6"|
                                input$A=="E16_7"|
                                input$A=="E16_8"|
                                input$A=="E16_9"|
                                input$A=="F7_1"|
                                input$A=="F7_2"|
                                input$A=="F7_3"|
                                input$A=="F7_4"|
                                input$A=="F7_5"|
                                input$A=="F7_6"|
                                input$A=="F7_7"|
                                input$A=="F7_8"|
                                input$A=="F7_9"|
                                input$A=="H8_1"|
                                input$A=="H8_2"|
                                input$A=="H8_3"|
                                input$A=="H8_4"|
                                input$A=="H8_5"|
                                input$A=="H8_6"|
                                input$A=="H8_7"|
                                input$A=="H8_8"|
                                input$A=="H9_1"|
                                input$A=="H9_2"|
                                input$A=="H9_3"|
                                input$A=="H9_4"|
                                input$A=="H9_6")){c("Yes","No")}else
                                {if(input$A=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$A=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016",
                                                                                 "2017",
                                                                                 "2018")}else
                                                                                 {if(input$A=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$A=="B4"|
                                                                                                              input$A=="B9"|
                                                                                                              input$A=="E4"|
                                                                                                              input$A=="E5"|
                                                                                                              input$A=="E15"|
                                                                                                              input$A=="G7"|
                                                                                                              input$A=="G11")){c("Yes","No")}else
                                                                                                              {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      ##### 18 B ####           
      df1[[2]]<-as.factor(df1[[2]])
      levels(df1[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
      {if(input$B=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$B=="A9"|
                                input$B=="B8_1"|
                                input$B=="B8_2"|
                                input$B=="B8_3"|
                                input$B=="B8_4"|
                                input$B=="B8_5"|
                                input$B=="B8_6"|
                                input$B=="B8_7"|
                                input$B=="B8_8"|
                                input$B=="B8_9"|
                                input$B=="B8_10"|
                                input$B=="B13_1"|
                                input$B=="B13_2"|
                                input$B=="B13_3"|
                                input$B=="B13_4"|
                                input$B=="B13_5"|
                                input$B=="B13_6"|
                                input$B=="B8_10"|
                                input$B=="C2_1"|
                                input$B=="C2_2"|
                                input$B=="C2_3"|
                                input$B=="C2_4"|
                                input$B=="C2_5"|
                                input$B=="C2_6"|
                                input$B=="C2_7"|
                                input$B=="C3_1"|
                                input$B=="C3_2"|
                                input$B=="C3_3"|
                                input$B=="C3_4"|
                                input$B=="C3_5"|
                                input$B=="C3_6"|
                                input$B=="C3_7"|
                                input$B=="C3_8"|
                                input$B=="E1_1"|
                                input$B=="E1_2"|
                                input$B=="E1_3"|
                                input$B=="E1_4"|
                                input$B=="E1_5"|
                                input$B=="E1_6"|
                                input$B=="E1_7"|
                                input$B=="E1_8"|
                                input$B=="E1_9"|
                                input$B=="E11_1"|
                                input$B=="E11_2"|
                                input$B=="E11_3"|
                                input$B=="E11_4"|
                                input$B=="E11_5"|
                                input$B=="E11_6"|
                                input$B=="E11_7"|
                                input$B=="E11_8"|
                                input$B=="E11_9"|
                                input$B=="E16_1"|
                                input$B=="E16_2"|
                                input$B=="E16_3"|
                                input$B=="E16_4"|
                                input$B=="E16_5"|
                                input$B=="E16_6"|
                                input$B=="E16_7"|
                                input$B=="E16_8"|
                                input$B=="E16_9"|
                                input$B=="F7_1"|
                                input$B=="F7_2"|
                                input$B=="F7_3"|
                                input$B=="F7_4"|
                                input$B=="F7_5"|
                                input$B=="F7_6"|
                                input$B=="F7_7"|
                                input$B=="F7_8"|
                                input$B=="F7_9"|
                                input$B=="H8_1"|
                                input$B=="H8_2"|
                                input$B=="H8_3"|
                                input$B=="H8_4"|
                                input$B=="H8_5"|
                                input$B=="H8_6"|
                                input$B=="H8_7"|
                                input$B=="H8_8"|
                                input$B=="H9_1"|
                                input$B=="H9_2"|
                                input$B=="H9_3"|
                                input$B=="H9_4"|
                                input$B=="H9_6")){c("Yes","No")}else
                                {if(input$B=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$B=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016",
                                                                                 "2017",
                                                                                 "2018")}else
                                                                                 {if(input$B=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$B=="B4"|
                                                                                                              input$B=="B9"|
                                                                                                              input$B=="E4"|
                                                                                                              input$B=="E5"|
                                                                                                              input$B=="E15"|
                                                                                                              input$B=="G7"|
                                                                                                              input$B=="G11")){c("Yes","No")}else
                                                                                                              {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      
      dffinal1<-df1 %>%
        subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
        rename("Table" = 1,"B"=2,"C"=3)%>% 
        spread(B, C)%>%
        mutate(year=2018)
      
      ##### 20 A ####         
      df1<-mar[["D20"]]%>%
        group_by(A, B)%>%
        filter(A!=-9)%>% 
        filter(A!=-8)%>% 
        filter(A!=99)%>% 
        filter(A!=-7)%>% 
        filter(B!=-9)%>% 
        filter(A!=-8)%>% 
        filter(B!=99)%>% 
        filter(B!=-7)%>% 
        summarise(n=round(sum(pop),0))%>%
        mutate(prop=round((n/sum(n)*100),2))
      
      df1[[1]]<-as.factor(df1[[1]])
      levels(df1[[1]])<- if(input$A=="sex1"){c("Male", "Female")}else
      {if(input$A=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$A=="A9"|
                                input$A=="B8_1"|
                                input$A=="B8_2"|
                                input$A=="B8_3"|
                                input$A=="B8_4"|
                                input$A=="B8_5"|
                                input$A=="B8_6"|
                                input$A=="B8_7"|
                                input$A=="B8_8"|
                                input$A=="B8_9"|
                                input$A=="B8_10"|
                                input$A=="B13_1"|
                                input$A=="B13_2"|
                                input$A=="B13_3"|
                                input$A=="B13_4"|
                                input$A=="B13_5"|
                                input$A=="B13_6"|
                                input$A=="B8_10"|
                                input$A=="C2_1"|
                                input$A=="C2_2"|
                                input$A=="C2_3"|
                                input$A=="C2_4"|
                                input$A=="C2_5"|
                                input$A=="C2_6"|
                                input$A=="C2_7"|
                                input$A=="C3_1"|
                                input$A=="C3_2"|
                                input$A=="C3_3"|
                                input$A=="C3_4"|
                                input$A=="C3_5"|
                                input$A=="C3_6"|
                                input$A=="C3_7"|
                                input$A=="C3_8"|
                                input$A=="E1_1"|
                                input$A=="E1_2"|
                                input$A=="E1_3"|
                                input$A=="E1_4"|
                                input$A=="E1_5"|
                                input$A=="E1_6"|
                                input$A=="E1_7"|
                                input$A=="E1_8"|
                                input$A=="E1_9"|
                                input$A=="E11_1"|
                                input$A=="E11_2"|
                                input$A=="E11_3"|
                                input$A=="E11_4"|
                                input$A=="E11_5"|
                                input$A=="E11_6"|
                                input$A=="E11_7"|
                                input$A=="E11_8"|
                                input$A=="E11_9"|
                                input$A=="E16_1"|
                                input$A=="E16_2"|
                                input$A=="E16_3"|
                                input$A=="E16_4"|
                                input$A=="E16_5"|
                                input$A=="E16_6"|
                                input$A=="E16_7"|
                                input$A=="E16_8"|
                                input$A=="E16_9"|
                                input$A=="F7_1"|
                                input$A=="F7_2"|
                                input$A=="F7_3"|
                                input$A=="F7_4"|
                                input$A=="F7_5"|
                                input$A=="F7_6"|
                                input$A=="F7_7"|
                                input$A=="F7_8"|
                                input$A=="F7_9"|
                                input$A=="H8_1"|
                                input$A=="H8_2"|
                                input$A=="H8_3"|
                                input$A=="H8_4"|
                                input$A=="H8_5"|
                                input$A=="H8_6"|
                                input$A=="H8_7"|
                                input$A=="H8_8"|
                                input$A=="H9_1"|
                                input$A=="H9_2"|
                                input$A=="H9_3"|
                                input$A=="H9_4"|
                                input$A=="H9_6")){c("Yes","No")}else
                                {if(input$A=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$A=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016",
                                                                                 "2017",
                                                                                 "2018")}else
                                                                                 {if(input$A=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$A=="B4"|
                                                                                                              input$A=="B9"|
                                                                                                              input$A=="E4"|
                                                                                                              input$A=="E5"|
                                                                                                              input$A=="E15"|
                                                                                                              input$A=="G7"|
                                                                                                              input$A=="G11")){c("Yes","No")}else
                                                                                                              {if(input$A=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$A=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$A=="D1"|input$A=="D3"|input$A=="E23"|input$A=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$A=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$A=="E2"|input$A=="E12"|input$A=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$A=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$A=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$A=="E25"|input$A=="G13_1"|input$A=="G13_2"|input$A=="H11_1"|input$A=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$A=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$A=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$A=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$A=="G16_1"|input$A=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$A=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$A=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$A=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      ##### 20 B ####           
      df1[[2]]<-as.factor(df1[[2]])
      levels(df1[[2]])<- if(input$B=="sex1"){c("Male", "Female")}else
      {if(input$B=="A8"){c("Single, never married",
                           "Married",
                           "Separated",
                           "Divorced",
                           "Widowed",
                           "Registered partnership",
                           "Dissolved partnership")}else
                           {if((input$B=="A9"|
                                input$B=="B8_1"|
                                input$B=="B8_2"|
                                input$B=="B8_3"|
                                input$B=="B8_4"|
                                input$B=="B8_5"|
                                input$B=="B8_6"|
                                input$B=="B8_7"|
                                input$B=="B8_8"|
                                input$B=="B8_9"|
                                input$B=="B8_10"|
                                input$B=="B13_1"|
                                input$B=="B13_2"|
                                input$B=="B13_3"|
                                input$B=="B13_4"|
                                input$B=="B13_5"|
                                input$B=="B13_6"|
                                input$B=="B8_10"|
                                input$B=="C2_1"|
                                input$B=="C2_2"|
                                input$B=="C2_3"|
                                input$B=="C2_4"|
                                input$B=="C2_5"|
                                input$B=="C2_6"|
                                input$B=="C2_7"|
                                input$B=="C3_1"|
                                input$B=="C3_2"|
                                input$B=="C3_3"|
                                input$B=="C3_4"|
                                input$B=="C3_5"|
                                input$B=="C3_6"|
                                input$B=="C3_7"|
                                input$B=="C3_8"|
                                input$B=="E1_1"|
                                input$B=="E1_2"|
                                input$B=="E1_3"|
                                input$B=="E1_4"|
                                input$B=="E1_5"|
                                input$B=="E1_6"|
                                input$B=="E1_7"|
                                input$B=="E1_8"|
                                input$B=="E1_9"|
                                input$B=="E11_1"|
                                input$B=="E11_2"|
                                input$B=="E11_3"|
                                input$B=="E11_4"|
                                input$B=="E11_5"|
                                input$B=="E11_6"|
                                input$B=="E11_7"|
                                input$B=="E11_8"|
                                input$B=="E11_9"|
                                input$B=="E16_1"|
                                input$B=="E16_2"|
                                input$B=="E16_3"|
                                input$B=="E16_4"|
                                input$B=="E16_5"|
                                input$B=="E16_6"|
                                input$B=="E16_7"|
                                input$B=="E16_8"|
                                input$B=="E16_9"|
                                input$B=="F7_1"|
                                input$B=="F7_2"|
                                input$B=="F7_3"|
                                input$B=="F7_4"|
                                input$B=="F7_5"|
                                input$B=="F7_6"|
                                input$B=="F7_7"|
                                input$B=="F7_8"|
                                input$B=="F7_9"|
                                input$B=="H8_1"|
                                input$B=="H8_2"|
                                input$B=="H8_3"|
                                input$B=="H8_4"|
                                input$B=="H8_5"|
                                input$B=="H8_6"|
                                input$B=="H8_7"|
                                input$B=="H8_8"|
                                input$B=="H9_1"|
                                input$B=="H9_2"|
                                input$B=="H9_3"|
                                input$B=="H9_4"|
                                input$B=="H9_6")){c("Yes","No")}else
                                {if(input$B=="age_group"){c("20-30",
                                                            "30-40",
                                                            "40_50",
                                                            "50-60",
                                                            "60-64")}else
                                                            {if(input$B=="A6"){c("2006",
                                                                                 "2007",
                                                                                 "2008",
                                                                                 "2009",
                                                                                 "2010",
                                                                                 "2011",
                                                                                 "2012",
                                                                                 "2013",
                                                                                 "2014",
                                                                                 "2015",
                                                                                 "2016",
                                                                                 "2017",
                                                                                 "2018")}else
                                                                                 {if(input$B=="B2CAT"){c("In no other country",
                                                                                                         "In 1 other country",
                                                                                                         "In 2 other countries",
                                                                                                         "In 3 other countries",
                                                                                                         "In 4 or more other countries")}else
                                                                                                         {if((input$B=="B4"|
                                                                                                              input$B=="B9"|
                                                                                                              input$B=="E4"|
                                                                                                              input$B=="E5"|
                                                                                                              input$B=="E15"|
                                                                                                              input$B=="G7"|
                                                                                                              input$B=="G11")){c("Yes","No")}else
                                                                                                              {if(input$B=="B10"){c("Your spouse/partner already lived in Switzerland when you met",
                                                                                                                                    "You moved together",
                                                                                                                                    "Your spouse/partner moved before you",
                                                                                                                                    "Your spouse/partner moved after you",
                                                                                                                                    "Your spouse/partner has not yet moved to Switzerland")}else
                                                                                                                                    {if(input$B=="C1"){c("Yes, certainly",
                                                                                                                                                         "Yes, probably",
                                                                                                                                                         "No, probably not",
                                                                                                                                                         "No, certainly not",
                                                                                                                                                         "I do not know yet",
                                                                                                                                                         "I have already applied for the Swiss nationality")}else
                                                                                                                                                         {if((input$B=="D1"|input$B=="D3"|input$B=="E23"|input$B=="F6")){c("No formal educational qualification",
                                                                                                                                                                                                                           "Compulsory education",
                                                                                                                                                                                                                           "Higher secondary education not giving access to universities (or similar)",
                                                                                                                                                                                                                           "Vocational education and/or training",
                                                                                                                                                                                                                           "High school-leaving certificate giving access to universities (or similar)",
                                                                                                                                                                                                                           "Advanced technical and professional training",
                                                                                                                                                                                                                           "Bachelor or equivalent",
                                                                                                                                                                                                                           "Master or equivalent",
                                                                                                                                                                                                                           "Phd Doctoral or equivalent")}else
                                                                                                                                                                                                                           {if(input$B=="D4"){c("Yes, the certificate was obtained",
                                                                                                                                                                                                                                                "Yes, but the certificate was not obtained",
                                                                                                                                                                                                                                                "Yes, but the procedure is not yet complete",
                                                                                                                                                                                                                                                "No, it was not necessary",
                                                                                                                                                                                                                                                "No, other reasons")}else
                                                                                                                                                                                                                                                {if((input$B=="E2"|input$B=="E12"|input$B=="E18")){c("Self-employed",
                                                                                                                                                                                                                                                                                                     "A company owner",
                                                                                                                                                                                                                                                                                                     "A relative employed in a family business",
                                                                                                                                                                                                                                                                                                     "Employed as director or board member and/or with managerial",
                                                                                                                                                                                                                                                                                                     "Employed without managerial responsibility",
                                                                                                                                                                                                                                                                                                     "Employed in a protected workshop (except support staff)",
                                                                                                                                                                                                                                                                                                     "An apprentice",
                                                                                                                                                                                                                                                                                                     "Master or equivalent",
                                                                                                                                                                                                                                                                                                     "A PhD student")}else
                                                                                                                                                                                                                                                                                                     {if(input$B=="E21"){c("Unlimited duration",
                                                                                                                                                                                                                                                                                                                           "Limited duration",
                                                                                                                                                                                                                                                                                                                           "You don't have a contract")}else
                                                                                                                                                                                                                                                                                                                           {if(input$B=="E27"){c("Improved substantially",
                                                                                                                                                                                                                                                                                                                                                 "Improved slightly",
                                                                                                                                                                                                                                                                                                                                                 "Remained the same",
                                                                                                                                                                                                                                                                                                                                                 "Worsened slightly",
                                                                                                                                                                                                                                                                                                                                                 "Worsened substantially")}else
                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="G1_1"){c("Swiss-German",
                                                                                                                                                                                                                                                                                                                                                                        "German",
                                                                                                                                                                                                                                                                                                                                                                        "French",
                                                                                                                                                                                                                                                                                                                                                                        "Romansh",
                                                                                                                                                                                                                                                                                                                                                                        "Italian",
                                                                                                                                                                                                                                                                                                                                                                        "English",
                                                                                                                                                                                                                                                                                                                                                                        "Spanish",
                                                                                                                                                                                                                                                                                                                                                                        "Portuguese",
                                                                                                                                                                                                                                                                                                                                                                        "Other language")}else
                                                                                                                                                                                                                                                                                                                                                                        {if((input$B=="E25"|input$B=="G13_1"|input$B=="G13_2"|input$B=="H11_1"|input$B=="H11_2")){c("0","1","2","3","4","5","6","7")}else
                                                                                                                                                                                                                                                                                                                                                                        {if(input$B=="G2"){c("Everything",
                                                                                                                                                                                                                                                                                                                                                                                             "Most of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Parts of a conversation",
                                                                                                                                                                                                                                                                                                                                                                                             "Some words and phrases",
                                                                                                                                                                                                                                                                                                                                                                                             "Nothing at all")}else
                                                                                                                                                                                                                                                                                                                                                                                             {if(input$B=="G3"){c("Speak fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak somewhat fluently",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Speak not very well",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Know some vocabulary",
                                                                                                                                                                                                                                                                                                                                                                                                                  "Not speak the language at all")}else
                                                                                                                                                                                                                                                                                                                                                                                                                  {if(input$B=="G6"){c("All your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live in Switzerland",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Approximately the same numbers of friends live in Switzerland and abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "Most of your good friends live abroad",
                                                                                                                                                                                                                                                                                                                                                                                                                                       "All your good friends live abroad")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="G8"){c("Once or twice a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Three to six times a year",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Once a month",
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Twice or more a month")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if((input$B=="G16_1"|input$B=="G16_2")){c("Very interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Quite interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Hardly interested",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Not at all interested")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {if(input$B=="H3"){c("Very often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Often",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "From time to time",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Never")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {if(input$B=="A7"){c("Settlement permit (C permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Residence permit (B permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Diplomat or International Status or residence permit with gainful employment as member of diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Short-term residence permit (L permit)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Other")}else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {if(input$B=="CONT3"){c("EU/EFTA",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "non-EU/EFTA")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }}}}}}}}}}}}}}}}}}}}}}}
      
      dffinal2<-df1 %>%
        subset(select=if(input$D=="Absolute"){c(1:3)}else{c(1,2,4)})%>% 
        rename("Table" = 1,"B"=2,"C"=3)%>% 
        spread(B, C)%>%
        mutate(year=2020)
      
      dffinal<-rbind(dffinal0, dffinal1,dffinal2)
      
      write.table(dffinal, file, sep = sep, row.names = FALSE)
      
      
    })
  
  
})